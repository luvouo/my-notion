<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Projects — Soft Schedule</title>

  <style>
    :root{
      --accent-1: rgba(165, 206, 240, 0.88);
      --accent-2: rgba(140, 190, 232, 0.52);
      --border:   rgba(140, 190, 232, 0.60);

      --text: rgba(30,30,30,0.92);
      --muted: rgba(30,30,30,0.38);

      --glass: rgba(255,255,255,0.10);
      --shadow: 0 10px 30px rgba(0,0,0,0.06);
      --radius: 20px;

      /* ✅ pinned pale skyblue */
      --pin-bg: rgba(165, 206, 240, 0.20);
      --pin-bd: rgba(140, 190, 232, 0.38);
    }

    @font-face{
      font-family: "EnterSanChaek";
      src: url("../fonts/엔터산책10.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    html, body{
      margin:0;
      padding:0;
      background: transparent;
      font-family: ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      color: var(--text);
    }

    .wrap{
      width: min(980px, 100%);
      margin: 0 auto;
      padding: clamp(10px, 2.6vw, 16px);
      box-sizing: border-box;
    }

    .card{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: clamp(14px, 2.8vw, 18px);
      background: var(--glass);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(120% 80% at 0% 0%, rgba(165,206,240,0.20), transparent 55%),
        radial-gradient(80% 80% at 100% 20%, rgba(140,190,232,0.14), transparent 55%);
      pointer-events:none;
    }

    .inner{
      position: relative;
      z-index: 1;
      display: grid;
      gap: 12px;
    }

    .top{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .title{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }

    .pearl{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display: block;
      object-fit: cover;
      flex: 0 0 auto;
      box-shadow: 0 0 0 2px rgba(165,206,240,0.22);
    }

    .title h1{
      margin:0;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      font-size: clamp(15px, 3.8vw, 18px);
      letter-spacing: -0.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .meta{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      margin-left: auto;
      font-variant-numeric: tabular-nums;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }

    .controls{
      display:flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .inputRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      flex: 1 1 520px;
      min-width: 0;
    }

    .input{
      flex: 1 1 240px;
      min-width: 0;
      border: 1px solid rgba(140,190,232,0.45);
      background: rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 12px 12px;
      outline: none;
      color: var(--text);
      font-size: 13.5px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .input::placeholder{ color: rgba(30,30,30,0.45); }

    .btn{
      flex: 0 0 auto;
      border: 1px solid rgba(140,190,232,0.70);
      background: rgba(165,206,240,0.18);
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 13px;
      color: rgba(30,30,30,0.85);
      cursor: pointer;
      transition: transform .08s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease, color .18s ease;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      white-space: nowrap;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .btn:active{ transform: scale(0.98); }
    .btn:hover{
      background: rgba(165,206,240,0.24);
      border-color: rgba(140,190,232,0.90);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.18);
    }
    .btn:focus-visible{
      outline: none;
      box-shadow: 0 0 0 3px rgba(165,206,240,0.28);
    }

    .btn.secondary{
      border: 1px solid rgba(140,190,232,0.45);
      background: rgba(255,255,255,0.08);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
    }

    .board{
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      align-items: start;
    }

    .col{
      border: 1px solid rgba(140,190,232,0.30);
      background: rgba(255,255,255,0.06);
      border-radius: 16px;
      padding: 10px;
      min-height: 220px;
      display: grid;
      gap: 10px;
      overflow: hidden;
    }

    .colHead{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .colTitle{
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      font-size: 13px;
      color: rgba(30,30,30,0.82);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .colMeta{
      font-size: 12px;
      color: rgba(30,30,30,0.52);
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }

    .colBody{
      display: grid;
      gap: 10px;
      min-height: 120px;
    }

    /* ===== Compact project card (board view) ===== */
    .pCompact{
      width: 100%;
      text-align: left;

      border: 1px solid rgba(140,190,232,0.22);
      background: rgba(255,255,255,0.62);
      border-radius: 16px;
      padding: 10px;
      box-sizing: border-box;
      display: grid;
      gap: 8px;
      min-width: 0;

      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      transition: border-color .18s ease, background .18s ease, transform .08s ease, box-shadow .18s ease;
    }
    .pCompact:hover{
      border-color: rgba(140,190,232,0.45);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.14);
    }
    .pCompact:active{ transform: scale(0.99); }

    /* ✅ pinned style */
    .pCompact.pinned{
      background: var(--pin-bg);
      border-color: var(--pin-bd);
    }

    .pTitleRow{
      display:flex;
      gap: 8px;
      align-items: center;
      min-width: 0;
    }

    /* ✅ tiny pin marker */
    .pinMark{
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: rgba(140,190,232,0.85);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.18);
      flex: 0 0 auto;
      opacity: 0.75;
    }

    .pName{
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      font-size: 13.5px;
      color: rgba(30,30,30,0.88);
      min-width: 0;
      flex: 1 1 auto;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin: 0;
      padding: 0;
    }

    /* ✅ todo stats badge */
    .statBadge{
      flex: 0 0 auto;
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.06);
      background: rgba(255,255,255,0.55);
      color: rgba(30,30,30,0.72);
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }

    .tags{
      display:flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items:center;
    }
    .tagChip{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      border: 1px solid rgba(140,190,232,0.22);
      background: rgba(255,255,255,0.60);
      border-radius: 999px;
      padding: 5px 9px;
      font-size: 12px;
      color: rgba(30,30,30,0.72);
      max-width: 100%;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .tagChip span{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 140px;
    }

    /* ===== Footer ===== */
    .footer{
      display:flex;
      justify-content: space-between;
      align-items:flex-end;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .footerLeft{
      display:flex;
      flex-direction: column;
      gap: 6px;
      min-width: 160px;
    }
    .toast{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: rgba(30,30,30,0.62);
      font-size: 12px;
      line-height: 1;
      opacity: 0;
      transform: translateY(4px);
      pointer-events: none;
      transition: opacity .14s ease, transform .14s ease;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .toast:not(:empty){
      opacity: 1;
      transform: translateY(0);
    }
    .toast::before{
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(165,206,240,0.88);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.16);
      flex: 0 0 auto;
    }

    .footer-actions{
      display:flex;
      justify-content: flex-end;
      align-items:center;
      gap: 8px;
      flex-wrap: nowrap;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      padding-left: 8px;
      padding-right: 2px;
      scrollbar-width: none;
      width: 100%;
    }
    .footer-actions::-webkit-scrollbar{ display:none; }
    .footer-actions > .btn{ flex: 0 0 auto; }

    /* ===== Drag styles ===== */
    .pCompact.dragging{ opacity: 0.55; }
    .col.dropOver{
      border-color: rgba(140,190,232,0.70);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.18) inset;
    }

    /* ===== Project Detail Modal ===== */
    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.18);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 10px;
      z-index: 6000;
      overflow: hidden;
    }
    .modalOverlay.open{ display:flex; }

    .modal{
      width: min(920px, 100%);
      max-height: calc(100vh - 20px);
      display: flex;
      flex-direction: column;
      border-radius: 18px;
      border: 1px solid rgba(140,190,232,0.38);
      background: rgba(255,255,255,0.84);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 18px 50px rgba(0,0,0,0.18);
      overflow: hidden;
      position: relative;
    }

    .modalHeader{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      flex-wrap: wrap;
      box-sizing: border-box;
    }

    .mhLeft{
      display:flex;
      gap: 10px;
      align-items:center;
      min-width: 0;
      flex: 1 1 auto;
    }
    .mhLeft strong{
      font-size: 14px;
      letter-spacing: -0.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      flex: 1 1 auto;
      min-width: 0;
    }

    .mhRight{
      display:flex;
      gap: 8px;
      align-items:center;
      justify-content: flex-end;
      flex: 0 0 auto;
      min-width: 0;
      flex-wrap: wrap;
    }

    .modalBody{
      padding: 12px;
      overflow: auto;
      min-height: 0;
      flex: 1 1 auto;
      display: grid;
      gap: 12px;
      position: relative; /* dpPop inside */
    }

    .section{
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,255,255,0.66);
      display: grid;
      gap: 10px;
      min-width: 0;
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      min-width: 0;
    }

    .fieldLabel{
      font-size: 12px;
      color: rgba(30,30,30,0.55);
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }

    .textInput{
      width: 100%;
      min-width: 0;
      border: 1px solid rgba(140,190,232,0.18);
      background: rgba(255,255,255,0.70);
      border-radius: 12px;
      padding: 10px 10px;
      outline: none;
      font-size: 13px;
      color: rgba(30,30,30,0.88);
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      box-sizing: border-box;
    }

    .feedback{
      border: 1px solid rgba(140,190,232,0.18);
      background: rgba(255,255,255,0.70);
      border-radius: 14px;
      padding: 10px 10px;
      outline: none;
      font-size: 12.8px;
      color: rgba(30,30,30,0.86);
      min-height: 86px;
      resize: vertical;
      line-height: 1.45;
      box-sizing: border-box;
      font-family: ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .feedback::placeholder{ color: rgba(30,30,30,0.42); }

    .miniBtn{
      border: 1px solid rgba(140,190,232,0.35);
      background: rgba(255,255,255,0.08);
      color: rgba(30,30,30,0.72);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      cursor: pointer;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      transition: box-shadow .18s ease, border-color .18s ease, color .18s ease, transform .08s ease;
      white-space: nowrap;
      -webkit-tap-highlight-color: transparent;
    }
    .miniBtn:hover{
      border-color: rgba(140,190,232,0.70);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.16);
      color: var(--accent-1);
    }
    .miniBtn:active{ transform: scale(0.99); }

    .dangerBtn{
      border-color: rgba(0,0,0,0.08);
      background: rgba(0,0,0,0.03);
    }

    /* ===== Tags editor (modal) ===== */
    .tagAddRow{
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap: wrap;
      min-width: 0;
    }
    .tagInput{
      flex: 1 1 140px;
      min-width: 0;
      border: 1px solid rgba(140,190,232,0.18);
      background: rgba(255,255,255,0.70);
      border-radius: 12px;
      padding: 9px 10px;
      outline: none;
      font-size: 12.5px;
      color: rgba(30,30,30,0.85);
      box-sizing: border-box;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .tagChip button{
      border: none;
      background: transparent;
      cursor: pointer;
      color: rgba(30,30,30,0.55);
      padding: 2px 4px;
      border-radius: 8px;
      font-family: inherit;
    }
    .tagChip button:hover{
      background: rgba(165,206,240,0.14);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.14);
      color: rgba(30,30,30,0.78);
    }

    /* ===== Todos (modal) ===== */
    .todoBox{
      border: 1px solid rgba(140,190,232,0.22);
      background: rgba(255,255,255,0.50);
      border-radius: 14px;
      padding: 10px;
      display:grid;
      gap: 8px;
      min-width: 0;
    }
    .todoAdd{
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap: wrap;
      min-width: 0;
    }
    .todoInput{
      flex: 1 1 220px;
      min-width: 0;
      border: 1px solid rgba(140,190,232,0.18);
      background: rgba(255,255,255,0.70);
      border-radius: 12px;
      padding: 9px 10px;
      outline: none;
      font-size: 12.8px;
      color: rgba(30,30,30,0.88);
      box-sizing: border-box;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .todoList{
      display:grid;
      gap: 8px;
      min-width: 0;
    }

    .tRow{
      display:grid;
      grid-template-columns: 20px minmax(0,1fr) minmax(120px, 180px);
      gap: 10px;
      align-items:start;
      border: 1px solid rgba(140,190,232,0.18);
      background: rgba(255,255,255,0.66);
      border-radius: 14px;
      padding: 8px 10px;
      min-width: 0;
      box-sizing: border-box;
      overflow: hidden;
    }

    .tChk{
      width: 18px;
      height: 18px;
      border-radius: 6px;
      border: 1.4px solid rgba(140,190,232,0.55);
      background: rgba(255,255,255,0.70);
      cursor:pointer;
      display:grid;
      place-items:center;
      -webkit-tap-highlight-color: transparent;
      transition: background .18s ease, border-color .18s ease, transform .08s ease, box-shadow .18s ease;
    }
    .tChk:hover{
      border-color: rgba(140,190,232,0.75);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.16);
    }
    .tChk:active{ transform: scale(0.98); }
    .tChk svg{ width: 12px; height: 12px; opacity: 0; }
    .tChk.on{
      background: rgba(165,206,240,0.16);
      border-color: rgba(140,190,232,0.80);
    }
    .tChk.on svg{ opacity: 1; }

    .tMain{
      min-width: 0;
      display: grid;
      gap: 6px;
    }

    .tText{
      font-size: 13px;
      color: rgba(30,30,30,0.86);
      line-height: 1.35;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
      font-family: ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .tText.done{
      text-decoration: line-through;
      color: rgba(30,30,30,0.55);
    }

    .tSub{
      display:none;
      grid-template-columns: 1fr;
      gap: 6px;
      padding-top: 2px;
      min-width: 0;
    }
    .tSub.open{ display:grid; }

    .subAdd{
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap: wrap;
      min-width: 0;
    }
    .subInput{
      flex: 1 1 200px;
      min-width: 0;
      border: 1px solid rgba(140,190,232,0.18);
      background: rgba(255,255,255,0.70);
      border-radius: 12px;
      padding: 8px 10px;
      outline: none;
      font-size: 12.2px;
      color: rgba(30,30,30,0.88);
      box-sizing: border-box;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }

    .subList{
      display:grid;
      gap: 6px;
      min-width: 0;
    }
    .sRow{
      display:flex;
      align-items:center;
      gap: 8px;
      border: 1px solid rgba(140,190,232,0.16);
      background: rgba(255,255,255,0.62);
      border-radius: 12px;
      padding: 7px 9px;
      min-width: 0;
      box-sizing: border-box;
    }
    .sRow .sText{
      flex:1 1 auto;
      min-width: 0;
      font-size: 12.5px;
      color: rgba(30,30,30,0.80);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      font-family: ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .sRow .sText.done{
      text-decoration: line-through;
      color: rgba(30,30,30,0.55);
    }

    .tTools{
      display:flex;
      gap: 8px;
      align-items:flex-end;
      justify-content:flex-end;
      flex-wrap: wrap;
      min-width: 0;
    }
    .tTools > *{ flex: 0 0 auto; }

    .prioBtn{
      border: 1px solid rgba(140,190,232,0.22);
      background: rgba(255,255,255,0.66);
      border-radius: 999px;
      padding: 6px 9px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap: 4px;
      -webkit-tap-highlight-color: transparent;
      transition: box-shadow .18s ease, border-color .18s ease, transform .08s ease;
    }
    .prioBtn:hover{
      border-color: rgba(140,190,232,0.55);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.14);
    }
    .prioBtn:active{ transform: scale(0.99); }

    .stars{
      display:inline-flex;
      gap: 3px;
      align-items:center;
    }
    .starImg{
      width: 12px;
      height: 12px;
      display:block;
      object-fit: contain;
      opacity: 0.92;
    }
    .dotFallback{
      font-size: 12px;
      letter-spacing: 1px;
      color: rgba(30,30,30,0.65);
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }

    /* ===== URLs (dynamic) ===== */
    .urlList{
      display:grid;
      gap: 8px;
      min-width: 0;
    }
    .urlRow{
      display:flex;
      gap: 8px;
      align-items:center;
      min-width: 0;
    }
    .urlText{
      flex: 1 1 auto;
      min-width: 0;
      border: 1px solid rgba(140,190,232,0.18);
      background: rgba(255,255,255,0.70);
      border-radius: 12px;
      padding: 9px 10px;
      outline: none;
      font-size: 12.5px;
      color: rgba(30,30,30,0.85);
      box-sizing: border-box;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .urlText::placeholder{ color: rgba(30,30,30,0.42); }

    /* ===== Upcoming-style Date Picker (inside modal body) ===== */
    .dpTrigger{
      flex: 0 0 auto;
      display: inline-flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;

      height: 38px;
      padding: 0 12px;

      border: 1px solid rgba(140,190,232,0.45);
      background: rgba(255,255,255,0.10);
      border-radius: 14px;

      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      user-select: none;

      transition: border-color .18s ease, box-shadow .18s ease, background .18s ease;

      width: 100%;
      box-sizing: border-box;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .dpText{
      font-size: 14px;
      color: rgba(30,30,30,0.45);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      min-width: 0;
    }
    .dpIcon{
      color: rgba(30,30,30,0.45);
      display: inline-flex;
      align-items: center;
      flex: 0 0 auto;
    }
    .dpTrigger:hover{
      border-color: rgba(140,190,232,0.75);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.20);
    }
    .dpTrigger:focus-visible{
      outline: none;
      border-color: rgba(140,190,232,0.85);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.28);
    }
    .dpTrigger.filled .dpText,
    .dpTrigger.filled .dpIcon{
      color: rgba(30,30,30,0.78);
    }

    .dpPop{
      position: absolute;
      left: 0;
      top: 0;
      width: 320px;
      z-index: 9999;

      border-radius: 16px;
      border: 1px solid rgba(140,190,232,0.45);
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 16px 40px rgba(0,0,0,0.12);
      padding: 10px;

      transform-origin: top left;
      transform: translateY(6px) scale(0.67);

      opacity: 0;
      pointer-events: none;
      transition: opacity .14s ease, transform .14s ease;
    }
    .dpPop.open{
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0) scale(0.67);
    }

    .dpHeader{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 4px 2px 8px;
    }
    .dpTitle{
      font-size: 13px;
      color: rgba(30,30,30,0.78);
      letter-spacing: -0.2px;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .dpNav{
      width: 34px;
      height: 30px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.06);
      background: rgba(255,255,255,0.60);
      color: rgba(30,30,30,0.70);
      cursor: pointer;
      transition: box-shadow .18s ease, border-color .18s ease, transform .08s ease;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .dpNav:hover{
      border-color: rgba(140,190,232,0.65);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.20);
    }
    .dpNav:active{ transform: scale(0.98); }

    .dpDow{
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      padding: 2px 2px 6px;
      font-size: 11px;
      letter-spacing: 0.2px;
      color: rgba(30,30,30,0.72);
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }

    .dpGrid{
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      padding: 2px;
    }

    .dpDay{
      height: 34px;
      border-radius: 10px;
      border: 1px solid transparent;
      background: rgba(255,255,255,0.55);
      color: rgba(30,30,30,0.78);
      font-size: 12px;
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: box-shadow .18s ease, border-color .18s ease, background .18s ease, transform .08s ease;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .dpDay[disabled]{ opacity: 0.35; cursor: default; }
    .dpDay:hover:not([disabled]){
      border-color: rgba(140,190,232,0.65);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.18);
    }
    .dpDay:active:not([disabled]){ transform: scale(0.98); }
    .dpDay.today::after{
      content:"";
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: rgba(30,30,30,0.58);
      margin-top: 2px;
    }
    .dpDay.selected{
      background: rgba(165,206,240,0.24);
      border-color: rgba(140,190,232,0.85);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.22);
    }

    .dpFooter{
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding-top: 10px;
    }
    .dpAction{
      flex: 1 1 auto;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.06);
      background: rgba(255,255,255,0.60);
      color: rgba(30,30,30,0.78);
      font-size: 12px;
      cursor: pointer;
      transition: box-shadow .18s ease, border-color .18s ease, transform .08s ease;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .dpAction:hover{
      border-color: rgba(140,190,232,0.65);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.20);
    }
    .dpAction:active{ transform: scale(0.98); }
    .dpAction.primary{
      background: rgba(165,206,240,0.18);
      border-color: rgba(140,190,232,0.70);
    }

    @media (max-width: 880px){
      .board{ grid-template-columns: 1fr; }
    }
    @media (max-width: 520px){
      .tRow{
        grid-template-columns: 20px minmax(0,1fr);
        grid-template-rows: auto auto;
      }
      .tTools{
        grid-column: 1 / -1;
        justify-content: flex-start;
        align-items: flex-start;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card" role="application" aria-label="Projects Widget">
      <div class="inner">
        <div class="top">
          <div class="title">
            <img class="pearl" src="./icon/pearl.png" alt="" aria-hidden="true" />
            <h1>Projects</h1>
          </div>
          <div class="meta" id="metaText"></div>
        </div>

        <div class="controls">
          <div class="inputRow">
            <input id="quickProjectName" class="input" type="text" placeholder="새 프로젝트 이름…" maxlength="60" />
            <button class="btn secondary" id="addProjectBtn" type="button">Add Project</button>
            <input id="boardSearch" class="input" type="text" placeholder="보드 검색: 프로젝트명 / 태그 / todo…" maxlength="80" />
          </div>

          <div style="display:flex; gap:8px; flex-wrap:nowrap;">
            <button class="btn secondary" id="archiveBtn" type="button">History / Archive</button>
            <button class="btn secondary" id="exportAllBtn" type="button">Export</button>
          </div>
        </div>

        <div class="board" id="board"></div>

        <div class="footer">
          <div class="footerLeft">
            <span id="countText">0 projects</span>
            <div class="toast" id="toast"></div>
          </div>

          <div class="footer-actions">
            <button class="btn secondary" id="clearSearchBtn" type="button">Clear Search</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Project Detail Modal -->
  <div class="modalOverlay" id="projectModalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Project Details">
      <div class="modalHeader">
        <div class="mhLeft">
          <img class="pearl" src="./icon/pearl.png" alt="" aria-hidden="true" />
          <strong id="pmTitle">Project</strong>
        </div>

        <div class="mhRight">
          <button class="btn secondary" id="pmPinBtn" type="button">Pin</button>
          <button class="btn secondary" id="pmArchiveBtn" type="button">Archive</button>
          <button class="btn secondary dangerBtn" id="pmDeleteBtn" type="button">Delete</button>
          <button class="btn secondary" id="pmCloseBtn" type="button">닫기</button>
        </div>
      </div>

      <div class="modalBody" id="pmBody">
        <div class="section" style="color: rgba(30,30,30,0.55); font-size:12px;">loading…</div>

        <!-- Date picker popover (inside modal) -->
        <div class="dpPop" id="pmDpPop" role="dialog" aria-label="Date Picker">
          <div class="dpHeader">
            <button type="button" class="dpNav" id="pmDpPrev" aria-label="Previous month">‹</button>
            <div class="dpTitle" id="pmDpTitle">2026.01</div>
            <button type="button" class="dpNav" id="pmDpNext" aria-label="Next month">›</button>
          </div>

          <div class="dpDow" aria-hidden="true">
            <span>S</span><span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span>
          </div>

          <div class="dpGrid" id="pmDpGrid" role="grid" aria-label="Calendar days"></div>

          <div class="dpFooter">
            <button type="button" class="dpAction" id="pmDpBack">Back</button>
            <button type="button" class="dpAction primary" id="pmDpToday">Today</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Projects Archive Modal -->
  <div class="modalOverlay" id="archiveOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Projects History / Archive">
      <div class="modalHeader">
        <div class="mhLeft">
          <img class="pearl" src="./icon/pearl.png" alt="" aria-hidden="true" />
          <strong>Projects History / Archive</strong>
          <input id="archiveSearchInput" class="textInput" style="max-width:420px;" type="text" placeholder="검색: 프로젝트명 / 태그 / 링크 / todo / 메모…" />
        </div>

        <div class="mhRight">
          <button class="btn secondary" id="bulkPinBtn" type="button">Pin</button>
          <button class="btn secondary" id="bulkUnpinBtn" type="button">Clear</button>
          <button class="btn secondary" id="bulkExportBtn" type="button">Export</button>
          <button class="btn secondary" id="bulkRestoreBtn" type="button">Restore</button>
          <button class="btn secondary dangerBtn" id="bulkDeleteBtn" type="button">Delete</button>
          <button class="btn secondary" id="closeArchiveBtn" type="button">닫기</button>
        </div>
      </div>

      <div class="modalBody" style="display:grid; grid-template-columns: max-content 1fr; gap:12px;">
        <div class="section" id="archiveList" style="width:max-content; max-width: 360px; overflow:auto; padding:10px;"></div>
        <div class="section" id="archivePreview" style="overflow:auto;"></div>
      </div>

      <div class="toast" id="archiveToast" style="position:absolute; left:14px; bottom:14px;"></div>
    </div>
  </div>

  <script>
    /* ========= Workspace scoped keys ========= */
    const WORKSPACE_ID_STORAGE_KEY = "soft_schedule_workspace_id_v1";
    function getWorkspaceIdMaybe(){
      const v = localStorage.getItem(WORKSPACE_ID_STORAGE_KEY);
      return (v && String(v).trim()) ? String(v).trim() : "";
    }
    const workspace_id = getWorkspaceIdMaybe();

    const PROJECTS_KEY = workspace_id
      ? `soft_schedule_projects_${workspace_id}_v1`
      : "soft_schedule_projects_v1";

    const PROJECTS_ARCHIVE_KEY = workspace_id
      ? `soft_schedule_projects_archive_${workspace_id}_v1`
      : "soft_schedule_projects_archive_v1";

    /* ========= SBstar ========= */
    const STAR_IMG_URL = "https://luvouo.github.io/my-notion/widgets/icon/SBstar.png";
    let STAR_OK = true;
    (function testStar(){
      const img = new Image();
      img.onload = () => { STAR_OK = true; };
      img.onerror = () => { STAR_OK = false; };
      img.src = STAR_IMG_URL;
    })();

    /* ========= model ========= */
    const STAGES = ["backlog","progress","done"];
    const STAGE_LABEL = { backlog:"Backlog", progress:"In Progress", done:"Done" };

    function uid(){
      return (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random()));
    }
    function pad2(n){ return String(n).padStart(2,"0"); }
    function todayYmd(){
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#039;"
      }[m]));
    }
    function deepClone(x){ return JSON.parse(JSON.stringify(x)); }

    function emptyProject(name="New Project"){
      return {
        id: uid(),
        name: name,
        startDate: todayYmd(),
        stage: "backlog",
        pinned: false,
        tags: [],
        urls: [""],      // ✅ URL list (dynamic)
        feedback: "",
        todos: [],
      };
    }

    function loadProjects(){
      try{
        const raw = localStorage.getItem(PROJECTS_KEY);
        if(!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }
    function saveProjects(arr){
      localStorage.setItem(PROJECTS_KEY, JSON.stringify(Array.isArray(arr) ? arr : []));
    }
    function loadArchive(){
      try{
        const raw = localStorage.getItem(PROJECTS_ARCHIVE_KEY);
        if(!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch(e){ return []; }
    }
    function saveArchive(arr){
      localStorage.setItem(PROJECTS_ARCHIVE_KEY, JSON.stringify(Array.isArray(arr) ? arr : []));
    }

    /* ========= state ========= */
    let projects = loadProjects();
    let archived = loadArchive();
    let searchQ = "";

    /* ========= DOM ========= */
    const metaText = document.getElementById("metaText");
    const board = document.getElementById("board");
    const quickProjectName = document.getElementById("quickProjectName");
    const addProjectBtn = document.getElementById("addProjectBtn");
    const boardSearch = document.getElementById("boardSearch");
    const archiveBtn = document.getElementById("archiveBtn");
    const exportAllBtn = document.getElementById("exportAllBtn");
    const clearSearchBtn = document.getElementById("clearSearchBtn");
    const countText = document.getElementById("countText");
    const toast = document.getElementById("toast");

    const projectModalOverlay = document.getElementById("projectModalOverlay");
    const pmTitle = document.getElementById("pmTitle");
    const pmBody = document.getElementById("pmBody");
    const pmCloseBtn = document.getElementById("pmCloseBtn");
    const pmPinBtn = document.getElementById("pmPinBtn");
    const pmArchiveBtn = document.getElementById("pmArchiveBtn");
    const pmDeleteBtn = document.getElementById("pmDeleteBtn");

    // archive modal
    const archiveOverlay = document.getElementById("archiveOverlay");
    const closeArchiveBtn = document.getElementById("closeArchiveBtn");
    const archiveSearchInput = document.getElementById("archiveSearchInput");
    const archiveList = document.getElementById("archiveList");
    const archivePreview = document.getElementById("archivePreview");
    const archiveToast = document.getElementById("archiveToast");

    const bulkPinBtn = document.getElementById("bulkPinBtn");
    const bulkUnpinBtn = document.getElementById("bulkUnpinBtn");
    const bulkExportBtn = document.getElementById("bulkExportBtn");
    const bulkRestoreBtn = document.getElementById("bulkRestoreBtn");
    const bulkDeleteBtn = document.getElementById("bulkDeleteBtn");

    function showToast(msg){
      toast.textContent = msg;
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.textContent = "", 1600);
    }
    function showArchiveToast(msg){
      archiveToast.textContent = msg;
      clearTimeout(showArchiveToast._t);
      showArchiveToast._t = setTimeout(()=> archiveToast.textContent = "", 1600);
    }

    function persist(){
      saveProjects(projects);
      saveArchive(archived);
    }

    function findProject(id){
      return projects.find(p => p.id === id) || null;
    }

    function matchesProject(p, q){
      const s = String(q||"").trim().toLowerCase();
      if(!s) return true;
      const parts = [
        p.name,
        p.startDate,
        p.feedback,
        ...(p.tags||[]),
        ...((p.urls||[]).map(u => u || "")),
        ...((p.todos||[]).map(t => t.text)),
        ...((p.todos||[]).flatMap(t => (t.subs||[]).map(su => su.text)))
      ].join(" ").toLowerCase();
      return parts.includes(s);
    }

    function computeTodoStats(p){
      const todos = Array.isArray(p.todos) ? p.todos : [];
      const total = todos.length;
      const done = todos.filter(t => !!t.done).length;
      return { done, total };
    }

    function stageProjects(stage){
      const filtered = projects
        .filter(p => p.stage === stage)
        .filter(p => matchesProject(p, searchQ));

      filtered.sort((a,b) => {
        const ap = a.pinned ? 1 : 0;
        const bp = b.pinned ? 1 : 0;
        if(ap !== bp) return bp - ap;
        const ad = String(a.startDate||"");
        const bd = String(b.startDate||"");
        if(ad !== bd) return (bd > ad ? 1 : -1);
        return String(a.name||"").localeCompare(String(b.name||""), "ko");
      });

      return filtered;
    }

    function formatMeta(){
      const total = projects.length;
      const done = projects.filter(p => p.stage === "done").length;
      metaText.textContent = `${total} projects · ${done} done · archive ${archived.length}`;
      countText.textContent = `${total} projects`;
    }

    function compactCardHtml(p, {summaryMode=false} = {}){
      const tags = (p.tags||[]).slice(0, 6).map(t => `
        <div class="tagChip" title="${escapeHtml(t)}"><span>${escapeHtml(t)}</span></div>
      `).join("");

      const st = computeTodoStats(p);

      // ✅ Done column default summary = tags + stats only (name still shown)
      const showTags = true;
      const showStats = true;

      return `
        <button class="pCompact ${p.pinned ? "pinned" : ""}"
          data-open-project="${p.id}"
          data-pid="${p.id}"
          draggable="true"
          type="button"
          aria-label="Project card">

          <div class="pTitleRow">
            ${p.pinned ? `<span class="pinMark" aria-hidden="true"></span>` : ``}
            <div class="pName" title="${escapeHtml(p.name||"")}">${escapeHtml(p.name || "Project")}</div>
            ${showStats ? `<div class="statBadge" title="todos done/total">${st.done}/${st.total}</div>` : ``}
          </div>

          ${showTags ? `
            <div class="tags">
              ${tags || `<span style="font-size:12px; color:rgba(30,30,30,0.45); font-family:EnterSanChaek, ui-sans-serif;">(no tags)</span>`}
            </div>
          ` : ``}
        </button>
      `;
    }

    function renderBoard(){
      formatMeta();

      const cols = STAGES.map(stage => {
        const list = stageProjects(stage);
        const count = list.length;

        // ✅ Done column: summary mode ON (still clickable)
        const body = list.map(p => compactCardHtml(p, {summaryMode: stage==="done"})).join("");

        return `
          <div class="col" data-col="${stage}">
            <div class="colHead">
              <div class="colTitle">${escapeHtml(STAGE_LABEL[stage])}</div>
              <div class="colMeta">${count}</div>
            </div>
            <div class="colBody" data-dropzone="${stage}">
              ${body || `<div style="color:rgba(30,30,30,0.45); font-size:12px; font-family:EnterSanChaek, ui-sans-serif;">(empty)</div>`}
            </div>
          </div>
        `;
      }).join("");

      board.innerHTML = cols;
    }

    /* ========= Markdown export ========= */
    function normalizeUrl(u){
      const s = String(u || "").trim();
      if(!s) return "";
      if(/^https?:\/\//i.test(s)) return s;
      return "https://" + s;
    }
    function mdForProject(p){
      const lines = [];
      lines.push(`# ${p.name || "Project"}`);
      lines.push(`- Stage: ${STAGE_LABEL[p.stage] || p.stage}`);
      lines.push(`- Start: ${p.startDate || ""}`);
      lines.push(`- Pinned: ${p.pinned ? "yes" : "no"}`);
      if((p.tags||[]).length) lines.push(`- Tags: ${p.tags.join(", ")}`);
      lines.push("");

      const urls = (p.urls||[]).map(u => (u||"").trim()).filter(Boolean);
      if(urls.length){
        lines.push(`## URLs`);
        for(const u of urls){
          lines.push(`- ${normalizeUrl(u)}`);
        }
        lines.push("");
      }

      if((p.feedback||"").trim()){
        lines.push(`## Feedback`);
        lines.push(p.feedback.trim());
        lines.push("");
      }

      lines.push(`## Todos`);
      const todos = (p.todos||[]);
      if(!todos.length){
        lines.push(`- (empty)`);
      }else{
        for(const t of todos){
          const pr = Math.max(1, Math.min(3, t.prio||1));
          const prTxt = "★".repeat(pr);
          lines.push(`- [${t.done ? "x" : " "}] ${t.text} (${prTxt})`);
          const subs = (t.subs||[]);
          for(const s of subs){
            lines.push(`  - [${s.done ? "x" : " "}] ${s.text}`);
          }
        }
      }
      return lines.join("\n");
    }
    function formatAllAsMarkdown(){
      const lines = [];
      lines.push(`# Projects Export`);
      lines.push(`- Exported: ${new Date().toISOString()}`);
      lines.push(`- Active: ${projects.length}`);
      lines.push(`- Archived: ${archived.length}`);
      lines.push("");
      for(const stage of STAGES){
        const list = projects.filter(p => p.stage === stage);
        lines.push(`## ${STAGE_LABEL[stage]} (${list.length})`);
        if(!list.length){
          lines.push(`- (empty)`);
          lines.push("");
          continue;
        }
        for(const p of list){
          lines.push(mdForProject(p));
          lines.push("\n---\n");
        }
        lines.push("");
      }
      if(archived.length){
        lines.push(`## Archived (${archived.length})`);
        for(const p of archived){
          lines.push(mdForProject(p));
          lines.push("\n---\n");
        }
      }
      return lines.join("\n");
    }
    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        try{
          const ok = document.execCommand("copy");
          document.body.removeChild(ta);
          return ok;
        }catch(err){
          document.body.removeChild(ta);
          return false;
        }
      }
    }

    /* ========= CRUD ========= */
    function addProject(name){
      const nm = String(name||"").trim() || "New Project";
      projects.unshift(emptyProject(nm));
      persist();
      renderBoard();
      showToast("프로젝트를 추가했어.");
    }
    function updateProject(id, fn){
      const idx = projects.findIndex(p => p.id === id);
      if(idx < 0) return;
      const next = deepClone(projects[idx]);
      fn(next);
      projects[idx] = next;
      persist();
      renderBoard();
    }
    function deleteProject(id){
      projects = projects.filter(p => p.id !== id);
      persist();
      renderBoard();
    }
    function archiveProject(id){
      const p = findProject(id);
      if(!p) return;
      projects = projects.filter(x => x.id !== id);
      archived.unshift({ ...deepClone(p), archivedAt: Date.now() });
      persist();
      renderBoard();
      showToast("Archive로 보냈어.");
    }

    /* ========= Drag & Drop ========= */
    let dragPid = null;
    function attachDnDHandlers(){
      board.addEventListener("dragstart", (e) => {
        const card = e.target.closest(".pCompact");
        if(!card) return;
        dragPid = card.dataset.pid;
        card.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
        try{ e.dataTransfer.setData("text/plain", dragPid); }catch(_){}
      });

      board.addEventListener("dragend", (e) => {
        const card = e.target.closest(".pCompact");
        if(card) card.classList.remove("dragging");
        dragPid = null;
        board.querySelectorAll(".col.dropOver").forEach(el => el.classList.remove("dropOver"));
      });

      board.addEventListener("dragover", (e) => {
        const zone = e.target.closest("[data-dropzone]");
        if(!zone) return;
        e.preventDefault();
        const col = e.target.closest(".col");
        if(col) col.classList.add("dropOver");
        e.dataTransfer.dropEffect = "move";
      });

      board.addEventListener("dragleave", (e) => {
        const col = e.target.closest(".col");
        if(col) col.classList.remove("dropOver");
      });

      board.addEventListener("drop", (e) => {
        const zone = e.target.closest("[data-dropzone]");
        if(!zone) return;
        e.preventDefault();
        const stage = zone.dataset.dropzone;
        const pid = dragPid || (function(){
          try{ return e.dataTransfer.getData("text/plain"); }catch(_){ return null; }
        })();
        if(!pid) return;

        updateProject(pid, p => { p.stage = stage; });
        showToast(`이동: ${STAGE_LABEL[stage]}`);
      });
    }

    /* ========= Project Detail Modal ========= */
    let openProjectId = null;

    function starsHtml(level){
      const n = Math.max(1, Math.min(3, Number(level)||1));
      if(STAR_OK){
        let out = `<span class="stars" aria-label="priority ${n}">`;
        for(let i=0;i<n;i++){
          out += `<img class="starImg" src="${STAR_IMG_URL}" alt="" aria-hidden="true" />`;
        }
        out += `</span>`;
        return out;
      }
      return `<span class="dotFallback" aria-label="priority ${n}">${"●".repeat(n)}</span>`;
    }

    function svgCheck(){
      return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M20 7L10 17l-5-5" stroke="rgba(30,30,30,0.85)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      `;
    }

    // ===== date helpers (Upcoming) =====
    function ymdDotFromDash(s){
      const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(s||""));
      if(!m) return null;
      return `${m[1]}.${m[2]}.${m[3]}`;
    }
    function dashFromDate(d){
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }
    function fmtYM(d){
      return `${d.getFullYear()}.${pad2(d.getMonth()+1)}`;
    }
    function isSameDay(a,b){
      return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
    }

    // Date Picker elements (modal)
    const pmDpPop = document.getElementById("pmDpPop");
    const pmDpPrev = document.getElementById("pmDpPrev");
    const pmDpNext = document.getElementById("pmDpNext");
    const pmDpTitle = document.getElementById("pmDpTitle");
    const pmDpGrid = document.getElementById("pmDpGrid");
    const pmDpBack = document.getElementById("pmDpBack");
    const pmDpToday = document.getElementById("pmDpToday");
    const DP_SCALE = 0.67;

    let dpSelectedDate = null;
    let dpView = new Date(); dpView.setDate(1);
    let dpTriggerEl = null;
    let dpTextEl = null;

    function openDP(triggerEl, textEl, currentDash){
      dpTriggerEl = triggerEl;
      dpTextEl = textEl;

      dpSelectedDate = currentDash || null;
      if(dpSelectedDate){
        const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(dpSelectedDate);
        if(m) dpView = new Date(Number(m[1]), Number(m[2])-1, 1);
      }else{
        const t = new Date();
        dpView = new Date(t.getFullYear(), t.getMonth(), 1);
      }

      triggerEl.setAttribute("aria-expanded","true");
      pmDpPop.classList.add("open");
      renderDP();
      requestAnimationFrame(()=>{
        placeDP();
        pmDpPrev.focus();
      });
    }

    function closeDP(){
      if(dpTriggerEl) dpTriggerEl.setAttribute("aria-expanded","false");
      pmDpPop.classList.remove("open");
      dpTriggerEl = null;
      dpTextEl = null;
    }

    function setSelected(dateObjOrNull, {close=true} = {}){
      if(!openProjectId) return;

      if(!dateObjOrNull){
        dpSelectedDate = null;
        if(dpTextEl) dpTextEl.textContent = "날짜 선택";
        if(dpTriggerEl) dpTriggerEl.classList.remove("filled");
        // 여기서는 startDate를 today로 유지
        updateProject(openProjectId, p => { p.startDate = todayYmd(); });
      }else{
        dpSelectedDate = dashFromDate(dateObjOrNull);
        if(dpTextEl) dpTextEl.textContent = ymdDotFromDash(dpSelectedDate);
        if(dpTriggerEl) dpTriggerEl.classList.add("filled");
        updateProject(openProjectId, p => { p.startDate = dpSelectedDate; });
      }

      renderProjectModal(openProjectId);
      if(close) closeDP();
    }

    function renderDP(){
      pmDpTitle.textContent = fmtYM(dpView);
      pmDpGrid.innerHTML = "";

      const today = new Date();
      const first = new Date(dpView.getFullYear(), dpView.getMonth(), 1);
      const last  = new Date(dpView.getFullYear(), dpView.getMonth()+1, 0);
      const daysInMonth = last.getDate();
      const startDow = first.getDay();

      for(let i=0;i<startDow;i++){
        const blank = document.createElement("button");
        blank.type = "button";
        blank.className = "dpDay";
        blank.disabled = true;
        blank.setAttribute("aria-hidden","true");
        blank.textContent = "";
        pmDpGrid.appendChild(blank);
      }

      for(let day=1; day<=daysInMonth; day++){
        const d = new Date(dpView.getFullYear(), dpView.getMonth(), day);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "dpDay";
        btn.textContent = String(day);
        btn.setAttribute("role","gridcell");

        if(isSameDay(d, today)) btn.classList.add("today");
        if(dpSelectedDate && dpSelectedDate === dashFromDate(d)) btn.classList.add("selected");

        btn.addEventListener("click", ()=> setSelected(d, {close:true}));
        pmDpGrid.appendChild(btn);
      }
    }

    function placeDP(){
      if(!dpTriggerEl) return;
      const r = dpTriggerEl.getBoundingClientRect();
      const modalBodyRect = pmBody.getBoundingClientRect();

      const popW = pmDpPop.offsetWidth;
      const popH = pmDpPop.offsetHeight;
      const scaledW = popW * DP_SCALE;
      const scaledH = popH * DP_SCALE;

      const gap = 8;
      const pad = 10;

      const relLeft0 = r.left - modalBodyRect.left;
      const relTop0  = r.bottom - modalBodyRect.top;

      let left = relLeft0;
      let top  = relTop0 + gap;

      if(top + scaledH > pmBody.clientHeight - pad){
        top = (r.top - modalBodyRect.top) - scaledH - gap;
      }

      left = Math.max(pad, Math.min(left, pmBody.clientWidth - scaledW - pad));
      top  = Math.max(pad, Math.min(top,  pmBody.clientHeight - scaledH - pad));

      pmDpPop.style.left = `${left}px`;
      pmDpPop.style.top  = `${top}px`;
    }

    pmDpPrev.addEventListener("click", ()=>{
      dpView = new Date(dpView.getFullYear(), dpView.getMonth()-1, 1);
      renderDP(); placeDP();
    });
    pmDpNext.addEventListener("click", ()=>{
      dpView = new Date(dpView.getFullYear(), dpView.getMonth()+1, 1);
      renderDP(); placeDP();
    });
    pmDpBack.addEventListener("click", ()=> setSelected(null, {close:true}));
    pmDpToday.addEventListener("click", ()=>{
      const t = new Date();
      dpView = new Date(t.getFullYear(), t.getMonth(), 1);
      setSelected(t, {close:true});
    });
    pmDpPop.addEventListener("click", (e)=> e.stopPropagation());
    window.addEventListener("resize", ()=> { if(pmDpPop.classList.contains("open")) placeDP(); }, {passive:true});
    window.addEventListener("scroll", ()=> { if(pmDpPop.classList.contains("open")) placeDP(); }, {passive:true});

    function renderProjectModal(pid){
      const p = findProject(pid);
      if(!p) return;

      pmTitle.textContent = p.name || "Project";
      pmPinBtn.textContent = p.pinned ? "Unpin" : "Pin";

      const tagsHtml = (p.tags||[]).map((t, idx) => `
        <div class="tagChip" title="${escapeHtml(t)}">
          <span>${escapeHtml(t)}</span>
          <button type="button" data-tag-del="${idx}">✕</button>
        </div>
      `).join("");

      const startDash = p.startDate || todayYmd();
      const startDot = ymdDotFromDash(startDash) || startDash;

      const todoList = (p.todos||[]).map(t => {
        const subCount = (t.subs||[]).length;
        const subDone = (t.subs||[]).filter(s => !!s.done).length;
        const tDoneCls = t.done ? "done" : "";
        const subOpen = !!t.subOpen;

        const subsHtml = (t.subs||[]).map(su => `
          <div class="sRow">
            <div class="tChk ${su.done ? "on" : ""}" role="checkbox" aria-checked="${su.done}"
              data-sub-tog="${t.id}" data-sub-id="${su.id}">${svgCheck()}</div>
            <div class="sText ${su.done ? "done" : ""}" title="${escapeHtml(su.text)}">${escapeHtml(su.text)}</div>
            <button class="miniBtn dangerBtn" type="button" data-sub-del="${t.id}" data-sub-id="${su.id}">Delete</button>
          </div>
        `).join("");

        return `
          <div class="tRow">
            <div class="tChk ${t.done ? "on" : ""}" role="checkbox" aria-checked="${t.done}"
              data-todo-tog="${t.id}">${svgCheck()}</div>

            <div class="tMain">
              <div class="tText ${tDoneCls}" title="${escapeHtml(t.text)}">${escapeHtml(t.text)}</div>

              <div class="tSub ${subOpen ? "open" : ""}">
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                  <span style="font-size:12px; color:rgba(30,30,30,0.55); font-family:EnterSanChaek, ui-sans-serif;">
                    Substeps ${subDone}/${subCount}
                  </span>
                </div>

                <div class="subAdd">
                  <input class="subInput" type="text" maxlength="80"
                    placeholder="서브스텝 추가…"
                    data-sub-input="${t.id}" />
                  <button class="miniBtn" type="button" data-sub-add="${t.id}">Add</button>
                </div>

                <div class="subList">${subsHtml || `<div style="color:rgba(30,30,30,0.45); font-size:12px; font-family:EnterSanChaek, ui-sans-serif;">(empty)</div>`}</div>
              </div>
            </div>

            <div class="tTools">
              <button class="prioBtn" type="button" title="우선순위 변경 (1→2→3→1)"
                data-prio="${t.id}">
                ${starsHtml(t.prio || 1)}
              </button>

              <button class="miniBtn" type="button" data-sub-toggle="${t.id}">
                ${subOpen ? "Substeps Hide" : (subCount ? `Substeps (${subDone}/${subCount})` : "Substeps")}
              </button>

              <button class="miniBtn dangerBtn" type="button" data-todo-del="${t.id}">Delete</button>
            </div>
          </div>
        `;
      }).join("");

      // ✅ URLs dynamic list (position at bottom)
      const urls = Array.isArray(p.urls) && p.urls.length ? p.urls : [""];
      const urlRows = urls.map((u, i) => `
        <div class="urlRow">
          <input class="urlText" type="text" placeholder="URL…" value="${escapeHtml(u||"")}" data-url-idx="${i}" />
          <button class="miniBtn dangerBtn" type="button" data-url-del="${i}">Delete</button>
        </div>
      `).join("");

      pmBody.innerHTML = `
        <div class="section">
          <div class="row2">
            <div style="display:grid; gap:6px; min-width:0;">
              <div class="fieldLabel">Project Name</div>
              <input class="textInput" data-p-name type="text" maxlength="60" value="${escapeHtml(p.name||"")}" />
            </div>

            <div style="display:grid; gap:6px; min-width:0; position:relative;">
              <div class="fieldLabel">Start Date</div>

              <button type="button"
                class="dpTrigger ${startDash ? "filled" : ""}"
                data-dp-trigger
                aria-haspopup="dialog"
                aria-expanded="false">
                <span class="dpText" data-dp-text>${escapeHtml(startDot)}</span>
                <span class="dpIcon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="16" height="16">
                    <path d="M7 3v2M17 3v2M4 8h16M6 5h12a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2z"
                          fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  </svg>
                </span>
              </button>
              <div style="font-size:11px; color:rgba(30,30,30,0.42); font-family:EnterSanChaek, ui-sans-serif;">
                (Upcoming 위젯 Date Picker 방식)
              </div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="fieldLabel">Tags</div>
          <div class="tags">${tagsHtml || `<span style="font-size:12px; color:rgba(30,30,30,0.45); font-family:EnterSanChaek, ui-sans-serif;">(no tags)</span>`}</div>

          <div class="tagAddRow">
            <input class="tagInput" data-tag-input type="text" maxlength="30" placeholder="태그 입력 후 Enter…" />
            <button class="miniBtn" type="button" data-tag-add>Add Tag</button>
          </div>
        </div>

        <div class="section">
          <div class="fieldLabel">Feedback</div>
          <textarea class="feedback" data-feedback placeholder="개인 feedback / 메모…">${escapeHtml(p.feedback||"")}</textarea>
        </div>

        <div class="section">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
            <div class="fieldLabel">Todos</div>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <button class="miniBtn" type="button" data-clear-done>Clear done</button>
            </div>
          </div>

          <div class="todoBox">
            <div class="todoAdd">
              <input class="todoInput" data-todo-input type="text" maxlength="90" placeholder="todo 추가…" />
              <button class="miniBtn" type="button" data-todo-add>Add</button>
            </div>
            <div class="todoList">
              ${todoList || `<div style="color:rgba(30,30,30,0.45); font-size:12px; font-family:EnterSanChaek, ui-sans-serif;">(empty)</div>`}
            </div>
          </div>
        </div>

        <!-- ✅ URL section moved to bottom + dynamic add -->
        <div class="section">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
            <div class="fieldLabel">URL</div>
            <button class="miniBtn" type="button" data-url-add>＋</button>
          </div>

          <div class="urlList">
            ${urlRows}
          </div>
        </div>
      `;
      // innerHTML로 덮어쓰면 pmDpPop이 DOM에서 제거되므로 다시 붙여 줌
      pmBody.appendChild(pmDpPop);
    }

    function openProjectModal(pid){
      const p = findProject(pid);
      if(!p) return;
      openProjectId = pid;
      renderProjectModal(pid);

      projectModalOverlay.classList.add("open");
      projectModalOverlay.setAttribute("aria-hidden","false");

      pmPinBtn.textContent = p.pinned ? "Unpin" : "Pin";
      closeDP();
    }

    function closeProjectModal(){
      closeDP();
      projectModalOverlay.classList.remove("open");
      projectModalOverlay.setAttribute("aria-hidden","true");
      openProjectId = null;
    }

    pmCloseBtn.addEventListener("click", closeProjectModal);
    projectModalOverlay.addEventListener("click", (e)=>{
      if(e.target === projectModalOverlay) closeProjectModal();
    });

    // Modal header actions
    pmPinBtn.addEventListener("click", ()=>{
      if(!openProjectId) return;
      updateProject(openProjectId, p => p.pinned = !p.pinned);
      const p = findProject(openProjectId);
      if(p) pmPinBtn.textContent = p.pinned ? "Unpin" : "Pin";
      showToast(p && p.pinned ? "Pinned." : "Unpinned.");
    });
    pmArchiveBtn.addEventListener("click", ()=>{
      if(!openProjectId) return;
      const id = openProjectId;
      closeProjectModal();
      archiveProject(id);
    });
    pmDeleteBtn.addEventListener("click", ()=>{
      if(!openProjectId) return;
      const ok = confirm("이 프로젝트를 삭제할까? (되돌리기 불가)");
      if(!ok) return;
      const id = openProjectId;
      closeProjectModal();
      deleteProject(id);
      showToast("삭제했어.");
    });

    /* ✅ dp open/close is now stable:
       - dpTrigger click handled via delegation
       - pmBody click closes dp (unless stopped)
    */
    pmBody.addEventListener("click", (e)=>{
      // click anywhere in body closes dp if open
      if(pmDpPop.classList.contains("open")) closeDP();
    });

    // Modal interactions (delegated)
    projectModalOverlay.addEventListener("click", (e)=>{
      if(!openProjectId) return;
      const pid = openProjectId;
      const dpTrig = e.target.closest("[data-dp-trigger]");
      if(dpTrig){
        e.stopPropagation(); // pmBody 핸들러 실행 방지
        e.preventDefault();
        const txt = dpTrig.querySelector("[data-dp-text]");
        const p = findProject(pid);
        if(!p) return;
        if(pmDpPop.classList.contains("open")) closeDP();
        else openDP(dpTrig, txt, p.startDate || todayYmd());
        return;
      }
    }, true); // 캡처 단계에서 실행

    pmBody.addEventListener("click", (e)=>{
      // date picker trigger나 popover 내부 클릭은 무시
      const dpTrig = e.target.closest("[data-dp-trigger]");
      const dpPop = e.target.closest(".dpPop");
      if(dpTrig || dpPop) {
        // 날짜 버튼이나 달력 팝업 클릭은 무시 (projectModalOverlay에서 처리)
        return;
      }
      // click anywhere in body closes dp if open
      if(pmDpPop.classList.contains("open")) closeDP();
    });

    // Modal interactions (delegated)
    projectModalOverlay.addEventListener("click", (e)=>{
      if(!openProjectId) return;
      const pid = openProjectId;

      const tagDel = e.target.closest("[data-tag-del]");
      if(tagDel){
        const idx = Number(tagDel.dataset.tagDel);
        updateProject(pid, p => {
          p.tags = Array.isArray(p.tags) ? p.tags : [];
          if(Number.isFinite(idx) && idx >= 0) p.tags.splice(idx, 1);
        });
        renderProjectModal(pid);
        return;
      }

      const tagAdd = e.target.closest("[data-tag-add]");
      if(tagAdd){
        const inp = projectModalOverlay.querySelector("[data-tag-input]");
        const val = inp ? (inp.value||"").trim() : "";
        if(!val) return;
        updateProject(pid, p => {
          p.tags = Array.isArray(p.tags) ? p.tags : [];
          if(!p.tags.includes(val)) p.tags.unshift(val);
        });
        renderProjectModal(pid);
        return;
      }

      const todoAdd = e.target.closest("[data-todo-add]");
      if(todoAdd){
        const inp = projectModalOverlay.querySelector("[data-todo-input]");
        const text = inp ? (inp.value||"").trim() : "";
        if(!text) return;
        updateProject(pid, p => {
          p.todos = Array.isArray(p.todos) ? p.todos : [];
          p.todos.unshift({ id: uid(), text, done:false, prio:1, subOpen:false, subs:[] });
        });
        renderProjectModal(pid);
        return;
      }

      const todoTog = e.target.closest("[data-todo-tog]");
      if(todoTog){
        const tid = todoTog.dataset.todoTog;
        updateProject(pid, p => {
          p.todos = (p.todos||[]).map(t => t.id === tid ? ({...t, done: !t.done}) : t);
        });
        renderProjectModal(pid);
        return;
      }

      const prio = e.target.closest("[data-prio]");
      if(prio){
        const tid = prio.dataset.prio;
        updateProject(pid, p => {
          p.todos = (p.todos||[]).map(t => {
            if(t.id !== tid) return t;
            const next = ((t.prio||1) % 3) + 1;
            return { ...t, prio: next };
          });
        });
        renderProjectModal(pid);
        return;
      }

      const todoDel = e.target.closest("[data-todo-del]");
      if(todoDel){
        const tid = todoDel.dataset.todoDel;
        updateProject(pid, p => {
          p.todos = (p.todos||[]).filter(t => t.id !== tid);
        });
        renderProjectModal(pid);
        return;
      }

      const subToggle = e.target.closest("[data-sub-toggle]");
      if(subToggle){
        const tid = subToggle.dataset.subToggle;
        updateProject(pid, p => {
          p.todos = (p.todos||[]).map(t => t.id === tid ? ({...t, subOpen: !t.subOpen}) : t);
        });
        renderProjectModal(pid);
        return;
      }

      const subAdd = e.target.closest("[data-sub-add]");
      if(subAdd){
        const tid = subAdd.dataset.subAdd;
        const inp = projectModalOverlay.querySelector(`[data-sub-input="${CSS.escape(tid)}"]`);
        const text = inp ? (inp.value||"").trim() : "";
        if(!text) return;
        updateProject(pid, p => {
          p.todos = (p.todos||[]).map(t => {
            if(t.id !== tid) return t;
            const subs = Array.isArray(t.subs) ? t.subs : [];
            subs.unshift({ id: uid(), text, done:false });
            return { ...t, subs, subOpen: true };
          });
        });
        renderProjectModal(pid);
        return;
      }

      const subTog = e.target.closest("[data-sub-tog]");
      if(subTog){
        const tid = subTog.dataset.subTog;
        const sid = subTog.dataset.subId;
        updateProject(pid, p => {
          p.todos = (p.todos||[]).map(t => {
            if(t.id !== tid) return t;
            const subs = (t.subs||[]).map(s => s.id === sid ? ({...s, done: !s.done}) : s);
            return { ...t, subs };
          });
        });
        renderProjectModal(pid);
        return;
      }

      const subDel = e.target.closest("[data-sub-del]");
      if(subDel){
        const tid = subDel.dataset.subDel;
        const sid = subDel.dataset.subId;
        updateProject(pid, p => {
          p.todos = (p.todos||[]).map(t => {
            if(t.id !== tid) return t;
            const subs = (t.subs||[]).filter(s => s.id !== sid);
            return { ...t, subs };
          });
        });
        renderProjectModal(pid);
        return;
      }

      const clearDone = e.target.closest("[data-clear-done]");
      if(clearDone){
        updateProject(pid, p => {
          p.todos = (p.todos||[]).filter(t => !t.done);
        });
        renderProjectModal(pid);
        return;
      }

      // ✅ URL add/remove
      const urlAdd = e.target.closest("[data-url-add]");
      if(urlAdd){
        updateProject(pid, p => {
          p.urls = Array.isArray(p.urls) ? p.urls : [];
          p.urls.push("");
        });
        renderProjectModal(pid);
        return;
      }

      const urlDel = e.target.closest("[data-url-del]");
      if(urlDel){
        const idx = Number(urlDel.dataset.urlDel);
        updateProject(pid, p => {
          p.urls = Array.isArray(p.urls) ? p.urls : [];
          if(Number.isFinite(idx) && idx >= 0) p.urls.splice(idx, 1);
          if(!p.urls.length) p.urls = [""];
        });
        renderProjectModal(pid);
        return;
      }
    });

    projectModalOverlay.addEventListener("input", (e)=>{
      if(!openProjectId) return;
      const pid = openProjectId;

      const name = e.target.closest("[data-p-name]");
      if(name){
        const v = (name.value||"").slice(0,60);
        updateProject(pid, p => p.name = v);
        pmTitle.textContent = v || "Project";
        return;
      }

      const fb = e.target.closest("[data-feedback]");
      if(fb){
        updateProject(pid, p => p.feedback = fb.value || "");
        return;
      }

      const url = e.target.closest("[data-url-idx]");
      if(url){
        const idx = Number(url.dataset.urlIdx);
        updateProject(pid, p => {
          p.urls = Array.isArray(p.urls) ? p.urls : [];
          while(p.urls.length <= idx) p.urls.push("");
          p.urls[idx] = url.value || "";
        });
        return;
      }
    });

    projectModalOverlay.addEventListener("keydown", (e)=>{
      if(!openProjectId) return;

      const tagInp = e.target.closest("[data-tag-input]");
      if(tagInp && e.key === "Enter"){
        e.preventDefault();
        const val = (tagInp.value||"").trim();
        if(!val) return;
        updateProject(openProjectId, p => {
          p.tags = Array.isArray(p.tags) ? p.tags : [];
          if(!p.tags.includes(val)) p.tags.unshift(val);
        });
        renderProjectModal(openProjectId);
        return;
      }

      const todoInp = e.target.closest("[data-todo-input]");
      if(todoInp && e.key === "Enter"){
        e.preventDefault();
        const text = (todoInp.value||"").trim();
        if(!text) return;
        updateProject(openProjectId, p => {
          p.todos = Array.isArray(p.todos) ? p.todos : [];
          p.todos.unshift({ id: uid(), text, done:false, prio:1, subOpen:false, subs:[] });
        });
        renderProjectModal(openProjectId);
        return;
      }

      const subInp = e.target.closest("[data-sub-input]");
      if(subInp && e.key === "Enter"){
        e.preventDefault();
        const tid = subInp.dataset.subInput;
        const text = (subInp.value||"").trim();
        if(!text) return;
        updateProject(openProjectId, p => {
          p.todos = (p.todos||[]).map(t => {
            if(t.id !== tid) return t;
            const subs = Array.isArray(t.subs) ? t.subs : [];
            subs.unshift({ id: uid(), text, done:false });
            return { ...t, subs, subOpen: true };
          });
        });
        renderProjectModal(openProjectId);
        return;
      }
    });

    /* ========= Archive modal (same logic + URL support) ========= */
    let archiveSelected = new Set();
    let archivePickedId = null;

    function matchesArchive(p, q){
      const s = String(q||"").trim().toLowerCase();
      if(!s) return true;
      const parts = [
        p.name, p.startDate, p.feedback,
        ...(p.tags||[]),
        ...((p.urls||[]).map(u => u || "")),
        ...((p.todos||[]).map(t => t.text)),
        ...((p.todos||[]).flatMap(t => (t.subs||[]).map(su => su.text)))
      ].join(" ").toLowerCase();
      return parts.includes(s);
    }

    function buildArchive(){
      const q = (archiveSearchInput.value||"").trim();
      const list = archived
        .filter(p => matchesArchive(p, q))
        .slice()
        .sort((a,b) => {
          const ap = a.pinned ? 1 : 0;
          const bp = b.pinned ? 1 : 0;
          if(ap !== bp) return bp - ap;
          const ad = String(a.startDate||"");
          const bd = String(b.startDate||"");
          if(ad !== bd) return (bd > ad ? 1 : -1);
          return String(a.name||"").localeCompare(String(b.name||""), "ko");
        });

      if(!list.length){
        archiveList.innerHTML = `<div style="color:rgba(30,30,30,0.55); font-size:12px;">보관함이 비어있어.</div>`;
        archivePreview.innerHTML = `<div style="color:rgba(30,30,30,0.55); font-size:12px;">(empty)</div>`;
        return;
      }

      archiveList.innerHTML = list.map(p => {
        const checked = archiveSelected.has(p.id);
        const active = archivePickedId === p.id;
        return `
          <div style="display:grid; grid-template-columns: 18px 1fr; gap:10px; align-items:start; margin-bottom:10px;">
            <div class="tChk ${checked ? "on":""}" data-arch-sel="${p.id}" style="margin-top:4px;">${svgCheck()}</div>
            <button class="miniBtn" data-arch-pick="${p.id}" style="text-align:left; border-radius:14px; width:100%; justify-content:flex-start; ${active ? "border-color: rgba(140,190,232,0.75); box-shadow: 0 0 0 3px rgba(165,206,240,0.16);" : ""}">
              ${escapeHtml(p.name||"Project")}
            </button>
          </div>
        `;
      }).join("");

      const picked = archived.find(x => x.id === archivePickedId) || list[0];
      archivePickedId = picked.id;
      archivePreview.innerHTML = `
        <div style="display:grid; gap:10px;">
          <div style="font-family:EnterSanChaek, ui-sans-serif; font-size:14px; color:rgba(30,30,30,0.82);">${escapeHtml(picked.name||"Project")}</div>
          <pre style="margin:0; white-space:pre-wrap; font-size:12px; color:rgba(30,30,30,0.72); background:rgba(255,255,255,0.55); border:1px solid rgba(0,0,0,0.06); border-radius:14px; padding:10px;">${escapeHtml(mdForProject(picked))}</pre>
        </div>
      `;
    }

    function openArchive(){
      archiveSelected.clear();
      archivePickedId = null;
      archiveOverlay.classList.add("open");
      archiveOverlay.setAttribute("aria-hidden","false");
      buildArchive();
    }
    function closeArchive(){
      archiveOverlay.classList.remove("open");
      archiveOverlay.setAttribute("aria-hidden","true");
      archiveToast.textContent = "";
    }

    closeArchiveBtn.addEventListener("click", closeArchive);
    archiveOverlay.addEventListener("click", (e)=>{ if(e.target === archiveOverlay) closeArchive(); });
    archiveSearchInput.addEventListener("input", buildArchive);

    archiveList.addEventListener("click", (e)=>{
      const sel = e.target.closest("[data-arch-sel]");
      if(sel){
        const id = sel.dataset.archSel;
        if(archiveSelected.has(id)) archiveSelected.delete(id);
        else archiveSelected.add(id);
        buildArchive();
        return;
      }
      const pick = e.target.closest("[data-arch-pick]");
      if(pick){
        archivePickedId = pick.dataset.archPick;
        buildArchive();
        return;
      }
    });

    function getArchiveSelectedIds(){ return Array.from(archiveSelected); }
    function restoreArchivedProject(id){
      const idx = archived.findIndex(p => p.id === id);
      if(idx < 0) return;
      const p = archived[idx];
      archived.splice(idx, 1);
      const restored = { ...deepClone(p) };
      if(!STAGES.includes(restored.stage)) restored.stage = "backlog";
      projects.unshift(restored);
      persist();
      renderBoard();
    }

    bulkPinBtn.addEventListener("click", ()=>{
      const ids = getArchiveSelectedIds();
      if(!ids.length){ showArchiveToast("선택된 항목이 없어."); return; }
      archived = archived.map(p => ids.includes(p.id) ? ({...p, pinned:true}) : p);
      persist(); buildArchive();
      showArchiveToast(`${ids.length}개 pin.`);
    });
    bulkUnpinBtn.addEventListener("click", ()=>{
      const ids = getArchiveSelectedIds();
      if(!ids.length){ showArchiveToast("선택된 항목이 없어."); return; }
      archived = archived.map(p => ids.includes(p.id) ? ({...p, pinned:false}) : p);
      persist(); buildArchive();
      showArchiveToast(`${ids.length}개 unpin.`);
    });
    bulkExportBtn.addEventListener("click", async ()=>{
      const ids = getArchiveSelectedIds();
      if(!ids.length){ showArchiveToast("선택된 항목이 없어."); return; }
      const parts = [];
      for(const id of ids){
        const p = archived.find(x => x.id === id);
        if(p) parts.push(mdForProject(p));
      }
      const md = parts.join("\n\n---\n\n");
      const ok = await copyToClipboard(md);
      showArchiveToast(ok ? "Export(복사) 완료." : "복사 실패");
    });
    bulkRestoreBtn.addEventListener("click", ()=>{
      const ids = getArchiveSelectedIds();
      if(!ids.length){ showArchiveToast("선택된 항목이 없어."); return; }
      for(const id of ids) restoreArchivedProject(id);
      archiveSelected.clear();
      buildArchive();
      showArchiveToast(`${ids.length}개 복원.`);
    });
    bulkDeleteBtn.addEventListener("click", ()=>{
      const ids = getArchiveSelectedIds();
      if(!ids.length){ showArchiveToast("선택된 항목이 없어."); return; }
      const ok = confirm(`선택한 ${ids.length}개를 삭제할까? (되돌리기 불가)`);
      if(!ok) return;
      archived = archived.filter(p => !ids.includes(p.id));
      archiveSelected.clear();
      persist();
      buildArchive();
      showArchiveToast("삭제 완료.");
    });

    /* ========= top controls ========= */
    addProjectBtn.addEventListener("click", () => {
      addProject(quickProjectName.value);
      quickProjectName.value = "";
      quickProjectName.focus();
    });
    quickProjectName.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){ e.preventDefault(); addProjectBtn.click(); }
    });

    boardSearch.addEventListener("input", () => {
      searchQ = (boardSearch.value||"").trim();
      renderBoard();
    });

    clearSearchBtn.addEventListener("click", () => {
      boardSearch.value = "";
      searchQ = "";
      renderBoard();
      showToast("검색을 지웠어.");
    });

    archiveBtn.addEventListener("click", openArchive);

    exportAllBtn.addEventListener("click", async () => {
      const md = formatAllAsMarkdown();
      const ok = await copyToClipboard(md);
      showToast(ok ? "Export(복사) 완료." : "복사 실패 (권한 확인)");
    });

    /* ✅ board card click: open modal (now whole card) */
    board.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-open-project]");
      if(btn){
        openProjectModal(btn.dataset.openProject);
        return;
      }
    });

    /* ========= escape key ========= */
    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape"){
        if(pmDpPop.classList.contains("open")){ closeDP(); return; }
        if(projectModalOverlay.classList.contains("open")){ closeProjectModal(); return; }
        if(archiveOverlay.classList.contains("open")){ closeArchive(); return; }
      }
    });

    /* ========= init ========= */
    renderBoard();
    attachDnDHandlers();

    setTimeout(() => {
      if(!STAR_OK){
        showToast("SBstar 이미지 로드 실패 → ●●●로 대체 중");
      }
    }, 1200);
  </script>
</body>
</html>
