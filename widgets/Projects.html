<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Projects — Soft Schedule</title>

  <style>
    :root{
      --accent-1: rgba(165, 206, 240, 0.88);
      --accent-2: rgba(140, 190, 232, 0.52);
      --border:   rgba(140, 190, 232, 0.60);

      --text: rgba(30,30,30,0.92);
      --muted: rgba(30,30,30,0.38);

      --glass: rgba(255,255,255,0.10);
      --shadow: 0 10px 30px rgba(0,0,0,0.06);
      --radius: 20px;

      --danger: rgba(210, 70, 70, 0.85);
    }

    @font-face{
      font-family: "EnterSanChaek";
      src: url("../fonts/엔터산책10.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    html, body{
      margin:0;
      padding:0;
      background: transparent;
      font-family: ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      color: var(--text);
    }

    .wrap{
      width: min(980px, 100%);
      margin: 0 auto;
      padding: clamp(10px, 2.6vw, 16px);
      box-sizing: border-box;
    }

    .card{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: clamp(14px, 2.8vw, 18px);
      background: var(--glass);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(120% 80% at 0% 0%, rgba(165,206,240,0.20), transparent 55%),
        radial-gradient(80% 80% at 100% 20%, rgba(140,190,232,0.14), transparent 55%);
      pointer-events:none;
    }

    .inner{
      position: relative;
      z-index: 1;
      display: grid;
      gap: 12px;
    }

    .top{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .title{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }

    .pearl{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display: block;
      object-fit: cover;
      flex: 0 0 auto;
      box-shadow: 0 0 0 2px rgba(165,206,240,0.22);
    }

    .title h1{
      margin:0;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      font-size: clamp(15px, 3.8vw, 18px);
      letter-spacing: -0.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .meta{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      margin-left: auto;
      font-variant-numeric: tabular-nums;
    }

    .controls{
      display:flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .leftControls{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
      flex: 1 1 560px;
      min-width: 0;
    }

    .input{
      flex: 1 1 240px;
      min-width: 0;
      border: 1px solid rgba(140,190,232,0.45);
      background: rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 12px 12px;
      outline: none;
      color: var(--text);
      font-size: 13.5px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .input::placeholder{ color: rgba(30,30,30,0.45); }

    .btn{
      flex: 0 0 auto;
      border: 1px solid rgba(140,190,232,0.70);
      background: rgba(165,206,240,0.18);
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 13px;
      color: rgba(30,30,30,0.85);
      cursor: pointer;
      transition: transform .08s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease, color .18s ease;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      white-space: nowrap;
    }
    .btn:active{ transform: scale(0.98); }
    .btn:hover{
      background: rgba(165,206,240,0.24);
      border-color: rgba(140,190,232,0.90);
    }
    .btn:focus-visible{
      outline: none;
      box-shadow: 0 0 0 3px rgba(165,206,240,0.28);
    }

    .btn.secondary{
      border: 1px solid rgba(140,190,232,0.45);
      background: rgba(255,255,255,0.08);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      color: rgba(30,30,30,0.80);
    }
    .btn.secondary:hover{
      border-color: rgba(140,190,232,0.70);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.22);
      color: rgba(30,30,30,0.92);
    }

    .pill{
      border: 1px solid rgba(140,190,232,0.45);
      background: rgba(255,255,255,0.08);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      cursor:pointer;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      color: rgba(30,30,30,0.74);
      transition: box-shadow .18s ease, border-color .18s ease, background .18s ease, transform .08s ease, color .18s ease;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      white-space: nowrap;
    }
    .pill:hover{
      border-color: rgba(140,190,232,0.70);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.22);
      color: rgba(30,30,30,0.88);
    }
    .pill:active{ transform: scale(0.98); }
    .pill:focus-visible{ outline:none; box-shadow: 0 0 0 3px rgba(165,206,240,0.28); }
    .pill.on{
      background: rgba(165,206,240,0.18);
      border-color: rgba(140,190,232,0.88);
      box-shadow: 0 10px 26px rgba(140,190,232,0.10);
      color: rgba(30,30,30,0.88);
    }

    .rightControls{
      display:flex;
      align-items:center;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      flex: 0 0 auto;
      max-width: 100%;
    }
    .rightControls::-webkit-scrollbar{ display:none; }

    .board{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      align-items: start;
    }

    .col{
      border: 1px solid rgba(140,190,232,0.30);
      background: rgba(255,255,255,0.06);
      border-radius: 16px;
      padding: 10px;
      min-height: 220px;
      display:grid;
      gap: 10px;
    }

    .colHead{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      min-width:0;
    }

    .colTitle{
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      font-size: 13px;
      color: rgba(30,30,30,0.82);
      display:flex;
      align-items:center;
      gap: 8px;
      min-width: 0;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .badge{
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.06);
      background: rgba(0,0,0,0.03);
      color: rgba(30,30,30,0.58);
      flex: 0 0 auto;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }
    .badge.strong{
      border-color: rgba(140,190,232,0.40);
      background: rgba(165,206,240,0.18);
      color: rgba(30,30,30,0.62);
    }

    .dropHint{
      font-size: 12px;
      color: rgba(30,30,30,0.42);
      border: 1px dashed rgba(140,190,232,0.35);
      border-radius: 14px;
      padding: 10px;
      text-align:center;
      display:none;
    }
    .col.dragover .dropHint{ display:block; }
    .col.dragover{
      border-color: rgba(140,190,232,0.60);
      background: rgba(165,206,240,0.08);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.14);
    }

    .cards{
      display:grid;
      gap: 10px;
      min-height: 140px;
    }

    .pCard{
      border: 1px solid rgba(140,190,232,0.22);
      background: rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 10px;
      display:grid;
      gap: 10px;
      min-width: 0;
      box-shadow: 0 10px 24px rgba(0,0,0,0.03);
    }

    .pTop{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
      min-width: 0;
    }

    .pTitle{
      display:grid;
      gap: 4px;
      min-width: 0;
      flex: 1 1 auto;
    }

    .pTitle strong{
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      font-size: 13.5px;
      color: rgba(30,30,30,0.90);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .pSub{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
      color: rgba(30,30,30,0.52);
      font-variant-numeric: tabular-nums;
    }

    .miniTag{
      border: 1px solid rgba(140,190,232,0.30);
      background: rgba(255,255,255,0.10);
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 11px;
      color: rgba(30,30,30,0.62);
      white-space: nowrap;
    }

    .iconRow{
      display:flex;
      gap: 8px;
      align-items:center;
      flex: 0 0 auto;
      flex-wrap: nowrap;
    }

    .iconBtn{
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(140,190,232,0.18);
      background: rgba(255,255,255,0.70);
      cursor:pointer;
      display:grid;
      place-items:center;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
      transition: background .18s ease, border-color .18s ease, transform .08s ease, box-shadow .18s ease;
    }
    .iconBtn:hover{
      border-color: rgba(140,190,232,0.38);
      background: rgba(255,255,255,0.78);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.18);
    }
    .iconBtn:active{ transform: scale(0.98); }
    .iconBtn.on{
      border-color: rgba(140,190,232,0.55);
      background: rgba(165,206,240,0.16);
    }
    .iconBtn svg{
      width: 16px;
      height: 16px;
      stroke: rgba(110,110,110,0.70);
    }
    .iconBtn.danger svg{ stroke: rgba(150,90,90,0.72); }

    .feedback{
      border: 1px solid rgba(140,190,232,0.26);
      background: rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 10px 10px;
      font-size: 12.5px;
      color: rgba(30,30,30,0.78);
      line-height: 1.45;
      min-height: 38px;
      outline: none;
      resize: vertical;
      font-family: ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .feedback::placeholder{ color: rgba(30,30,30,0.42); }

    .todoBox{
      border: 1px solid rgba(140,190,232,0.22);
      background: rgba(255,255,255,0.06);
      border-radius: 14px;
      padding: 10px;
      display:grid;
      gap: 8px;
    }

    .todoAdd{
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap: wrap;
    }

    .todoInput{
      flex: 1 1 220px;
      min-width: 0;
      border: 1px solid rgba(140,190,232,0.35);
      background: rgba(255,255,255,0.10);
      border-radius: 12px;
      padding: 10px 10px;
      outline: none;
      color: var(--text);
      font-size: 13px;
    }
    .todoInput::placeholder{ color: rgba(30,30,30,0.45); }

    .addMini{
      width: 30px;
      height: 30px;
      border-radius: 999px;
      border: 1px solid rgba(140,190,232,0.45);
      background: rgba(255,255,255,0.12);
      cursor:pointer;
      display:grid;
      place-items:center;
      padding: 0;
      transition: background .18s ease, border-color .18s ease, box-shadow .18s ease, transform .08s ease;
      -webkit-tap-highlight-color: transparent;
      flex: 0 0 auto;
    }
    .addMini:hover{
      background: rgba(165,206,240,0.16);
      border-color: rgba(140,190,232,0.70);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.22);
    }
    .addMini:active{ transform: scale(0.96); }
    .addMini:disabled{
      opacity: 0.45;
      cursor: not-allowed;
      background: rgba(255,255,255,0.06);
      border-color: rgba(140,190,232,0.25);
      box-shadow: none;
      transform: none;
    }
    .addMini svg{
      width: 14px;
      height: 14px;
      stroke: rgba(30,30,30,0.55);
    }

    .tList{
      display:grid;
      gap: 8px;
    }

    .tItem{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(140,190,232,0.20);
      background: rgba(255,255,255,0.06);
      min-width: 0;
    }

    .check{
      width: 18px;
      height: 18px;
      border-radius: 6px;
      border: 1.6px solid rgba(140,190,232,0.95);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      transition: background .18s ease, border-color .18s ease, box-shadow .18s ease, transform .08s ease;
      appearance: none;
      -webkit-appearance: none;
      background: transparent;
      padding: 0;
    }
    .check:hover{
      background: rgba(165,206,240,0.12);
      border-color: rgba(140,190,232,1);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.22);
    }
    .check:active{ transform: scale(0.98); }
    .check svg{
      width: 12px;
      height: 12px;
      opacity: 0;
      transform: scale(0.9);
      transition: opacity .18s ease, transform .18s ease;
    }

    .tText{
      flex: 1 1 auto;
      min-width: 0;
      line-height: 1.45;
      font-size: 13.5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: rgba(30,30,30,0.86);
    }

    .del{
      flex: 0 0 auto;
      border: none;
      background: transparent;
      color: rgba(30,30,30,0.50);
      cursor:pointer;
      font-size: 14px;
      padding: 6px 8px;
      border-radius: 10px;
      transition: background .18s ease, color .18s ease, box-shadow .18s ease, transform .08s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .del:hover{
      background: rgba(165,206,240,0.12);
      color: rgba(30,30,30,0.78);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.20);
    }
    .del:active{ transform: scale(0.96); }

    .tItem.done{ opacity: 0.78; }
    .tItem.done .tText{ text-decoration: line-through; color: rgba(30,30,30,0.52); }
    .tItem.done .check{
      background: rgba(165,206,240,0.18);
      border-color: rgba(140,190,232,1);
    }
    .tItem.done .check svg{ opacity: 1; transform: scale(1); }

    .footer{
      display:flex;
      justify-content: space-between;
      align-items:flex-end;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .footerLeft{
      display:flex;
      flex-direction: column;
      gap: 6px;
      min-width: 160px;
    }

    .toast{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      color: rgba(30,30,30,0.66);
      font-size: 12px;
      line-height: 1;

      opacity: 0;
      transform: translateY(4px);
      pointer-events: none;

      transition: opacity .14s ease, transform .14s ease;
      user-select: none;
    }
    .toast.show{
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    .toast::before{
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(165,206,240,0.88);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.16);
      flex: 0 0 auto;
    }
    .toast .undoBtn{
      border: 1px solid rgba(140,190,232,0.55);
      background: rgba(165,206,240,0.16);
      color: rgba(30,30,30,0.82);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .toast .undoBtn:hover{
      border-color: rgba(140,190,232,0.80);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.18);
    }

    .hint{
      font-size: 12px;
      color: rgba(30,30,30,0.45);
      line-height: 1.35;
    }

    /* ===== Modal ===== */
    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.18);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 10px;
      z-index: 5000;
      overflow: hidden;
    }
    .modalOverlay.open{ display:flex; }

    .modal{
      width: min(860px, 100%);
      max-height: calc(100vh - 20px);
      display: flex;
      flex-direction: column;
      border-radius: 18px;
      border: 1px solid rgba(140,190,232,0.38);
      background: rgba(255,255,255,0.86);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 18px 50px rgba(0,0,0,0.18);
      overflow: hidden;
      position: relative;
    }

    .modalHeader{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      flex-wrap: wrap;
      min-width: 0;
      box-sizing: border-box;
    }

    .mhLeft{
      display:flex;
      gap: 10px;
      align-items:center;
      min-width: 0;
      flex: 1 1 auto;
      flex-wrap: wrap;
    }
    .mhLeft strong{
      font-size: 14px;
      letter-spacing: -0.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      flex: 0 0 auto;
    }

    .mhRight{
      display:flex;
      gap: 8px;
      align-items:center;
      justify-content: flex-end;
      flex: 0 0 auto;
      flex-wrap: wrap;
    }

    .modalBody{
      min-height: 0;
      flex: 1 1 auto;
      overflow: auto;
      padding: 12px 14px;
      display:grid;
      gap: 10px;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items: start;
    }

    .field{
      display:grid;
      gap: 8px;
      min-width: 0;
    }

    .label{
      font-size: 12px;
      color: rgba(30,30,30,0.60);
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }

    .modalInput{
      border: 1px solid rgba(140,190,232,0.45);
      background: rgba(255,255,255,0.70);
      border-radius: 14px;
      padding: 12px 12px;
      outline: none;
      color: var(--text);
      font-size: 14px;
      font-family: ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      width: 100%;
      box-sizing: border-box;
    }

    .modalTextarea{
      border: 1px solid rgba(140,190,232,0.45);
      background: rgba(255,255,255,0.70);
      border-radius: 14px;
      padding: 12px 12px;
      outline: none;
      color: var(--text);
      font-size: 13.5px;
      font-family: ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      width: 100%;
      box-sizing: border-box;
      min-height: 92px;
      resize: vertical;
      line-height: 1.45;
    }

    .modalFooter{
      padding: 12px 14px;
      border-top: 1px solid rgba(0,0,0,0.06);
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      font-size: 12px;
      color: rgba(30,30,30,0.55);
      font-variant-numeric: tabular-nums;
    }

    @media (max-width: 880px){
      .board{ grid-template-columns: 1fr; }
    }
    @media (max-width: 520px){
      .row{ grid-template-columns: 1fr; }
      .meta{ display:none; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card" role="application" aria-label="Projects Widget">
      <div class="inner">
        <div class="top">
          <div class="title">
            <img class="pearl" src="./icon/pearl.png" alt="" aria-hidden="true" />
            <h1>Projects</h1>
          </div>
          <div class="meta" id="metaText">0 projects</div>
        </div>

        <div class="controls">
          <div class="leftControls">
            <input id="searchInput" class="input" type="text" placeholder="검색: 프로젝트/할일/feedback…" maxlength="80" />
            <button class="pill on" id="filterAll" type="button">All</button>
            <button class="pill" id="filterBacklog" type="button">Backlog</button>
            <button class="pill" id="filterProgress" type="button">In Progress</button>
            <button class="pill" id="filterDone" type="button">Done</button>
            <button class="pill" id="filterPinned" type="button">Pinned</button>
          </div>
          <div class="rightControls">
            <button class="btn secondary" id="sortBtn" type="button" title="정렬">Sort: Updated</button>
            <button class="btn secondary" id="newBtn" type="button">New Project</button>
            <button class="btn secondary" id="exportAllBtn" type="button" title="전체 MD 복사">Export All</button>
          </div>
        </div>

        <div class="board" id="board">
          <div class="col" data-col="backlog" aria-label="Backlog">
            <div class="colHead">
              <div class="colTitle">Backlog <span class="badge" id="countBacklog">0</span></div>
              <div class="badge strong" id="doneBacklog">0/0</div>
            </div>
            <div class="dropHint">Drop here</div>
            <div class="cards" id="cardsBacklog"></div>
          </div>

          <div class="col" data-col="progress" aria-label="In Progress">
            <div class="colHead">
              <div class="colTitle">In Progress <span class="badge" id="countProgress">0</span></div>
              <div class="badge strong" id="doneProgress">0/0</div>
            </div>
            <div class="dropHint">Drop here</div>
            <div class="cards" id="cardsProgress"></div>
          </div>

          <div class="col" data-col="done" aria-label="Done">
            <div class="colHead">
              <div class="colTitle">Done <span class="badge" id="countDone">0</span></div>
              <div class="badge strong" id="doneDone">0/0</div>
            </div>
            <div class="dropHint">Drop here</div>
            <div class="cards" id="cardsDone"></div>
          </div>
        </div>

        <div class="footer">
          <div class="footerLeft">
            <span id="summaryText">0/0 todo done</span>
            <div class="toast" id="toast" aria-live="polite"></div>
          </div>
          <div class="hint" id="hintText">
            Drag & Drop으로 칼럼 이동. 모바일은 카드 상단을 길게 눌러서 드래그.
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- New / Edit Modal -->
  <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Project Editor">
      <div class="modalHeader">
        <div class="mhLeft">
          <img class="pearl" src="./icon/pearl.png" alt="" aria-hidden="true" />
          <strong id="modalTitle">New Project</strong>
        </div>
        <div class="mhRight">
          <button class="btn secondary" id="modalExportBtn" type="button" title="프로젝트 MD 복사" disabled>Export</button>
          <button class="btn secondary" id="modalCloseBtn" type="button">닫기</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="row">
          <div class="field">
            <div class="label">Project name (주제)</div>
            <input id="nameInput" class="modalInput" type="text" maxlength="60" placeholder="예: Soft Schedule — Projects 위젯" />
          </div>
          <div class="field">
            <div class="label">Start date</div>
            <input id="startInput" class="modalInput" type="date" />
          </div>
        </div>

        <div class="field">
          <div class="label">Personal feedback</div>
          <textarea id="fbInput" class="modalTextarea" placeholder="진행하면서 느낀 점, 막힌 포인트, 다음 액션…"></textarea>
        </div>

        <div class="field">
          <div class="label">Quick add todo</div>
          <div class="todoAdd">
            <input id="todoInput" class="todoInput" type="text" maxlength="80" placeholder="한 줄 할 일…" />
            <button id="todoAddBtn" class="addMini" type="button" aria-label="할 일 추가" title="추가" disabled>
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 5v14M5 12h14" stroke-width="1.7" stroke-linecap="round"/>
              </svg>
            </button>
            <button class="btn secondary" id="clearDoneTodosBtn" type="button" title="완료 삭제">Clear done</button>
          </div>
          <div class="todoBox">
            <div class="tList" id="todoList"></div>
          </div>
        </div>
      </div>

      <div class="modalFooter">
        <span id="modalMeta">—</span>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn secondary" id="pinBtn" type="button">Pin</button>
          <button class="btn secondary" id="moveBacklogBtn" type="button">Move: Backlog</button>
          <button class="btn secondary" id="moveProgressBtn" type="button">Move: In Progress</button>
          <button class="btn secondary" id="moveDoneBtn" type="button">Move: Done</button>
          <button class="btn secondary" id="deleteProjectBtn" type="button" style="border-color: rgba(210,70,70,0.35);">Delete</button>
          <button class="btn secondary" id="saveBtn" type="button">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       Storage
    ========================= */
    const PROJECTS_KEY = "soft_schedule_projects_v1";

    function safeUUID(){
      return (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now() + Math.random());
    }

    function todayISO(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#039;"
      }[m]));
    }

    function loadProjects(){
      try{
        const raw = localStorage.getItem(PROJECTS_KEY);
        if(!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr.map(normalizeProject) : [];
      }catch(e){ return []; }
    }

    function saveProjects(list){
      localStorage.setItem(PROJECTS_KEY, JSON.stringify(Array.isArray(list) ? list.map(normalizeProject) : []));
    }

    function normalizeProject(p){
      const base = {
        id: safeUUID(),
        name: "",
        startDate: "",
        feedback: "",
        stage: "backlog", // backlog | progress | done
        pinned: false,
        createdAt: Date.now(),
        updatedAt: Date.now(),
        todos: [] // {id,text,done,createdAt}
      };
      if(!p || typeof p !== "object") return base;
      const out = { ...base, ...p };
      out.stage = (out.stage === "progress" || out.stage === "done" || out.stage === "backlog") ? out.stage : "backlog";
      out.pinned = !!out.pinned;
      out.name = String(out.name || "");
      out.startDate = String(out.startDate || "");
      out.feedback = String(out.feedback || "");
      out.createdAt = Number.isFinite(out.createdAt) ? out.createdAt : Date.now();
      out.updatedAt = Number.isFinite(out.updatedAt) ? out.updatedAt : Date.now();
      out.todos = Array.isArray(out.todos) ? out.todos.map(t => ({
        id: String(t?.id || safeUUID()),
        text: String(t?.text || ""),
        done: !!t?.done,
        createdAt: Number.isFinite(t?.createdAt) ? t.createdAt : Date.now()
      })) : [];
      return out;
    }

    /* =========================
       State
    ========================= */
    let projects = loadProjects();

    let filterStage = "all"; // all | backlog | progress | done | pinned
    let searchQ = "";
    let sortMode = "updated"; // updated | created | name | start

    let editingId = null;

    // undo payload: {type, ...}
    let undoPayload = null;

    /* =========================
       DOM
    ========================= */
    const metaText = document.getElementById("metaText");
    const summaryText = document.getElementById("summaryText");

    const searchInput = document.getElementById("searchInput");
    const sortBtn = document.getElementById("sortBtn");
    const newBtn = document.getElementById("newBtn");
    const exportAllBtn = document.getElementById("exportAllBtn");

    const filterAll = document.getElementById("filterAll");
    const filterBacklog = document.getElementById("filterBacklog");
    const filterProgress = document.getElementById("filterProgress");
    const filterDone = document.getElementById("filterDone");
    const filterPinned = document.getElementById("filterPinned");

    const toast = document.getElementById("toast");

    const cardsBacklog = document.getElementById("cardsBacklog");
    const cardsProgress = document.getElementById("cardsProgress");
    const cardsDone = document.getElementById("cardsDone");

    const countBacklog = document.getElementById("countBacklog");
    const countProgress = document.getElementById("countProgress");
    const countDone = document.getElementById("countDone");

    const doneBacklog = document.getElementById("doneBacklog");
    const doneProgress = document.getElementById("doneProgress");
    const doneDone = document.getElementById("doneDone");

    const modalOverlay = document.getElementById("modalOverlay");
    const modalTitle = document.getElementById("modalTitle");
    const modalCloseBtn = document.getElementById("modalCloseBtn");
    const modalExportBtn = document.getElementById("modalExportBtn");

    const nameInput = document.getElementById("nameInput");
    const startInput = document.getElementById("startInput");
    const fbInput = document.getElementById("fbInput");

    const todoInput = document.getElementById("todoInput");
    const todoAddBtn = document.getElementById("todoAddBtn");
    const todoList = document.getElementById("todoList");
    const clearDoneTodosBtn = document.getElementById("clearDoneTodosBtn");

    const modalMeta = document.getElementById("modalMeta");
    const pinBtn = document.getElementById("pinBtn");
    const moveBacklogBtn = document.getElementById("moveBacklogBtn");
    const moveProgressBtn = document.getElementById("moveProgressBtn");
    const moveDoneBtn = document.getElementById("moveDoneBtn");
    const deleteProjectBtn = document.getElementById("deleteProjectBtn");
    const saveBtn = document.getElementById("saveBtn");

    const cols = Array.from(document.querySelectorAll(".col"));

    /* =========================
       Toast + Undo
    ========================= */
    function showUndoToast(message, payload){
      undoPayload = payload || null;
      toast.innerHTML = `
        <span>${escapeHtml(message || "삭제했어.")}</span>
        ${undoPayload ? `<button class="undoBtn" type="button" id="undoBtn">Undo</button>` : ``}
      `;
      toast.classList.add("show");
      clearTimeout(showUndoToast._t);
      showUndoToast._t = setTimeout(hideToast, 3000);

      const ub = document.getElementById("undoBtn");
      if(ub){
        ub.addEventListener("click", () => {
          if(undoPayload) runUndo(undoPayload);
          hideToast();
        }, { once: true });
      }
    }

    function hideToast(){
      toast.classList.remove("show");
      toast.innerHTML = "";
      undoPayload = null;
      clearTimeout(showUndoToast._t);
    }

    function runUndo(p){
      try{
        if(!p || typeof p !== "object") return;

        if(p.type === "deleteTodo"){
          const pr = projects.find(x => x.id === p.projectId);
          if(!pr) return;
          const idx = Math.min(Math.max(0, p.index), pr.todos.length);
          pr.todos.splice(idx, 0, p.todo);
          pr.updatedAt = Date.now();
          persist();
          if(editingId === pr.id) renderModalTodos(pr);
          render();
          return;
        }

        if(p.type === "deleteProject"){
          const idx = Math.min(Math.max(0, p.index), projects.length);
          projects.splice(idx, 0, p.project);
          persist();
          render();
          return;
        }

        if(p.type === "moveProject"){
          const pr = projects.find(x => x.id === p.projectId);
          if(!pr) return;
          pr.stage = p.fromStage;
          pr.updatedAt = Date.now();
          persist();
          render();
          return;
        }
      }catch(e){}
    }

    /* =========================
       Helpers
    ========================= */
    function persist(){
      saveProjects(projects);
    }

    function formatDateLabel(iso){
      if(!iso) return "—";
      const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(iso));
      if(!m) return iso;
      return `${m[1]}.${m[2]}.${m[3]}`;
    }

    function countTodos(pr){
      const total = pr.todos.length;
      const done = pr.todos.filter(t => t.done).length;
      return { total, done };
    }

    function highlightText(text, q){
      const t = String(text || "");
      const qq = String(q || "").trim();
      if(!qq) return escapeHtml(t);
      const idx = t.toLowerCase().indexOf(qq.toLowerCase());
      if(idx === -1) return escapeHtml(t);
      const before = escapeHtml(t.slice(0, idx));
      const mid = escapeHtml(t.slice(idx, idx + qq.length));
      const after = escapeHtml(t.slice(idx + qq.length));
      return `${before}<span style="background: rgba(165,206,240,0.35); border-radius:6px; padding:0 3px;">${mid}</span>${after}`;
    }

    function getFiltered(){
      let list = projects.slice();

      const q = searchQ.trim().toLowerCase();
      if(q){
        list = list.filter(pr => {
          if(String(pr.name||"").toLowerCase().includes(q)) return true;
          if(String(pr.feedback||"").toLowerCase().includes(q)) return true;
          for(const t of pr.todos){
            if(String(t.text||"").toLowerCase().includes(q)) return true;
          }
          return false;
        });
      }

      if(filterStage === "pinned"){
        list = list.filter(pr => pr.pinned);
      } else if(filterStage !== "all"){
        list = list.filter(pr => pr.stage === filterStage);
      }

      // sorting
      const collator = new Intl.Collator("ko-KR", { numeric:true, sensitivity:"base" });
      list.sort((a,b) => {
        // pinned first (always)
        if(!!a.pinned !== !!b.pinned) return a.pinned ? -1 : 1;

        if(sortMode === "updated") return (b.updatedAt - a.updatedAt);
        if(sortMode === "created") return (b.createdAt - a.createdAt);
        if(sortMode === "name") return collator.compare(a.name || "", b.name || "");
        if(sortMode === "start"){
          const aa = a.startDate || "";
          const bb = b.startDate || "";
          // blank last
          if(!aa && bb) return 1;
          if(aa && !bb) return -1;
          return collator.compare(aa, bb);
        }
        return (b.updatedAt - a.updatedAt);
      });

      return list;
    }

    function stageLabel(stage){
      return stage === "progress" ? "In Progress" : (stage === "done" ? "Done" : "Backlog");
    }

    /* =========================
       Render Board
    ========================= */
    function render(){
      const list = getFiltered();

      // counts (global)
      metaText.textContent = `${projects.length} projects`;

      let allTotal = 0, allDone = 0;
      for(const pr of projects){
        const c = countTodos(pr);
        allTotal += c.total;
        allDone += c.done;
      }
      summaryText.textContent = `${allDone}/${allTotal} todo done`;

      // column lists from filtered
      const bl = list.filter(x => x.stage === "backlog");
      const pg = list.filter(x => x.stage === "progress");
      const dn = list.filter(x => x.stage === "done");

      countBacklog.textContent = String(bl.length);
      countProgress.textContent = String(pg.length);
      countDone.textContent = String(dn.length);

      doneBacklog.textContent = doneBadge(bl);
      doneProgress.textContent = doneBadge(pg);
      doneDone.textContent = doneBadge(dn);

      cardsBacklog.innerHTML = "";
      cardsProgress.innerHTML = "";
      cardsDone.innerHTML = "";

      if(bl.length === 0) cardsBacklog.innerHTML = emptyCol("Backlog");
      if(pg.length === 0) cardsProgress.innerHTML = emptyCol("In Progress");
      if(dn.length === 0) cardsDone.innerHTML = emptyCol("Done");

      for(const pr of bl) cardsBacklog.appendChild(renderProjectCard(pr));
      for(const pr of pg) cardsProgress.appendChild(renderProjectCard(pr));
      for(const pr of dn) cardsDone.appendChild(renderProjectCard(pr));
    }

    function emptyCol(label){
      return `<div class="hint" style="padding:6px 2px;">(empty) ${escapeHtml(label)}</div>`;
    }

    function doneBadge(arr){
      let total=0, done=0;
      for(const pr of arr){
        const c = countTodos(pr);
        total += c.total;
        done += c.done;
      }
      return `${done}/${total}`;
    }

    function renderProjectCard(pr){
      const el = document.createElement("div");
      el.className = "pCard";
      el.dataset.pid = pr.id;
      el.draggable = true;

      const { total, done } = countTodos(pr);

      const nameHtml = highlightText(pr.name || "(untitled)", searchQ);
      const fbPreview = (pr.feedback || "").trim().slice(0, 90);
      const fbHtml = highlightText(fbPreview || "—", searchQ);

      el.innerHTML = `
        <div class="pTop">
          <div class="pTitle">
            <strong title="${escapeHtml(pr.name || "")}">${nameHtml}</strong>
            <div class="pSub">
              <span class="miniTag">${escapeHtml(stageLabel(pr.stage))}</span>
              <span class="miniTag">Start: ${escapeHtml(formatDateLabel(pr.startDate))}</span>
              <span class="miniTag">${done}/${total}</span>
              ${pr.pinned ? `<span class="miniTag">pinned</span>` : ``}
            </div>
          </div>
          <div class="iconRow">
            <button class="iconBtn ${pr.pinned ? "on" : ""}" type="button" data-pin="${escapeHtml(pr.id)}" title="Pin">
              ${svgPin()}
            </button>
            <button class="iconBtn" type="button" data-open="${escapeHtml(pr.id)}" title="Open">
              ${svgOpen()}
            </button>
            <button class="iconBtn danger" type="button" data-delete="${escapeHtml(pr.id)}" title="Delete">
              ${svgTrash()}
            </button>
          </div>
        </div>

        <textarea class="feedback" data-fb="${escapeHtml(pr.id)}" placeholder="Personal feedback…" spellcheck="false">${escapeHtml(pr.feedback || "")}</textarea>

        <div class="todoBox">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <div class="label" style="margin:0;">To-do</div>
            <div class="badge ${done===total && total>0 ? "strong" : ""}">${done}/${total}</div>
          </div>
          <div class="tList">
            ${renderTodoPreview(pr)}
          </div>
          <div class="hint">+ Open에서 전체 todo 편집 / Export 가능</div>
        </div>
      `;

      // feedback autosave (debounced)
      const ta = el.querySelector("textarea[data-fb]");
      ta.addEventListener("input", () => {
        const id = ta.dataset.fb;
        const p2 = projects.find(x => x.id === id);
        if(!p2) return;
        p2.feedback = ta.value;
        p2.updatedAt = Date.now();
        debouncedPersist();
      });

      // drag start
      el.addEventListener("dragstart", (e) => {
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", pr.id);
        // small hint for some browsers
        try{ e.dataTransfer.setData("application/x-softschedule-project", pr.id); }catch(_){}
      });

      // long-press enable drag on mobile-ish environments
      addLongPressDrag(el);

      return el;
    }

    function renderTodoPreview(pr){
      const items = (pr.todos || []).slice(0, 3);
      if(items.length === 0){
        return `<div class="hint" style="padding:4px 2px;">(empty)</div>`;
      }
      return items.map(t => `
        <div class="tItem ${t.done ? "done" : ""}">
          <button class="check" type="button" aria-label="toggle" data-ptog="${escapeHtml(pr.id)}" data-tid="${escapeHtml(t.id)}">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M20 7L10 17l-5-5" stroke="rgba(30,30,30,0.85)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div class="tText" title="${escapeHtml(t.text)}">${highlightText(t.text, searchQ)}</div>
        </div>
      `).join("");
    }

    function svgPin(){
      return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M9 3h6l1 6-2 2v5l-2 2-2-2v-5l-2-2 1-6z" stroke-width="1.6" stroke-linejoin="round"/>
          <path d="M12 21v-5" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
      `;
    }
    function svgTrash(){
      return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M7 7h10l-1 14H8L7 7z" stroke-width="1.6" stroke-linejoin="round"/>
          <path d="M9 7V5a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" stroke-width="1.6" stroke-linejoin="round"/>
          <path d="M6 7h12" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
      `;
    }
    function svgOpen(){
      return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M10 14l4-4" stroke-width="1.7" stroke-linecap="round"/>
          <path d="M12 7h7v7" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M19 5H9a4 4 0 0 0-4 4v10" stroke-width="1.7" stroke-linecap="round"/>
        </svg>
      `;
    }

    /* =========================
       Debounce persist
    ========================= */
    function debounce(fn, ms){
      let t = null;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), ms);
      };
    }
    const debouncedPersist = debounce(() => {
      persist();
      // keep board ordering stable with updatedAt changes
      render();
    }, 260);

    /* =========================
       Filters + Sort
    ========================= */
    function setFilter(mode){
      filterStage = mode;
      [filterAll, filterBacklog, filterProgress, filterDone, filterPinned].forEach(b => b.classList.remove("on"));
      if(mode === "all") filterAll.classList.add("on");
      if(mode === "backlog") filterBacklog.classList.add("on");
      if(mode === "progress") filterProgress.classList.add("on");
      if(mode === "done") filterDone.classList.add("on");
      if(mode === "pinned") filterPinned.classList.add("on");
      render();
    }

    filterAll.addEventListener("click", () => setFilter("all"));
    filterBacklog.addEventListener("click", () => setFilter("backlog"));
    filterProgress.addEventListener("click", () => setFilter("progress"));
    filterDone.addEventListener("click", () => setFilter("done"));
    filterPinned.addEventListener("click", () => setFilter("pinned"));

    searchInput.addEventListener("input", () => {
      searchQ = searchInput.value || "";
      render();
    });

    function cycleSort(){
      const order = ["updated","created","name","start"];
      const idx = order.indexOf(sortMode);
      sortMode = order[(idx + 1) % order.length];
      sortBtn.textContent = "Sort: " + (sortMode === "updated" ? "Updated" : sortMode === "created" ? "Created" : sortMode === "name" ? "Name" : "Start");
      render();
    }
    sortBtn.addEventListener("click", cycleSort);

    /* =========================
       Board interactions (pin/open/delete/todo toggle)
    ========================= */
    document.getElementById("board").addEventListener("click", (e) => {
      const pin = e.target.closest("[data-pin]");
      if(pin){
        const id = pin.dataset.pin;
        const pr = projects.find(x => x.id === id);
        if(!pr) return;
        pr.pinned = !pr.pinned;
        pr.updatedAt = Date.now();
        persist();
        render();
        return;
      }

      const open = e.target.closest("[data-open]");
      if(open){
        openModal(open.dataset.open);
        return;
      }

      const del = e.target.closest("[data-delete]");
      if(del){
        const id = del.dataset.delete;
        deleteProjectWithUndo(id);
        return;
      }

      const ptog = e.target.closest("[data-ptog]");
      if(ptog){
        const pid = ptog.dataset.ptog;
        const tid = ptog.dataset.tid;
        toggleTodo(pid, tid);
        return;
      }
    });

    function toggleTodo(pid, tid){
      const pr = projects.find(x => x.id === pid);
      if(!pr) return;
      const t = pr.todos.find(x => x.id === tid);
      if(!t) return;
      t.done = !t.done;
      pr.updatedAt = Date.now();
      persist();
      if(editingId === pr.id) renderModalTodos(pr);
      render();
    }

    function deleteProjectWithUndo(id){
      const idx = projects.findIndex(x => x.id === id);
      if(idx < 0) return;
      const pr = projects[idx];
      projects.splice(idx, 1);
      persist();
      render();
      showUndoToast("프로젝트를 삭제했어.", { type:"deleteProject", project: pr, index: idx });
    }

    /* =========================
       Drag & Drop columns
    ========================= */
    cols.forEach(col => {
      col.addEventListener("dragover", (e) => {
        e.preventDefault();
        col.classList.add("dragover");
      });
      col.addEventListener("dragleave", () => col.classList.remove("dragover"));
      col.addEventListener("drop", (e) => {
        e.preventDefault();
        col.classList.remove("dragover");

        const id = e.dataTransfer.getData("text/plain");
        if(!id) return;

        const pr = projects.find(x => x.id === id);
        if(!pr) return;

        const to = col.dataset.col;
        const from = pr.stage;
        if(to === from) return;

        pr.stage = to;
        pr.updatedAt = Date.now();
        persist();
        render();

        showUndoToast("이동했어.", { type:"moveProject", projectId: pr.id, fromStage: from, toStage: to });
      });
    });

    function addLongPressDrag(cardEl){
      let timer = null;
      let dragging = false;

      const onDown = (e) => {
        if(e.pointerType === "mouse") return; // desktop already ok
        if(cardEl.getAttribute("draggable") !== "true") return;

        timer = setTimeout(() => {
          dragging = true;
          // some mobile browsers ignore native drag; we just show hint
          document.getElementById("hintText").textContent = "드래그 중… 칼럼 위에 놓아줘.";
        }, 220);
      };

      const onUp = () => {
        clearTimeout(timer);
        timer = null;
        if(dragging){
          dragging = false;
          document.getElementById("hintText").textContent = "Drag & Drop으로 칼럼 이동. 모바일은 카드 상단을 길게 눌러서 드래그.";
        }
      };

      cardEl.addEventListener("pointerdown", onDown);
      cardEl.addEventListener("pointerup", onUp);
      cardEl.addEventListener("pointercancel", onUp);
      cardEl.addEventListener("pointerleave", onUp);
    }

    /* =========================
       Modal (New/Edit)
    ========================= */
    function openModal(id=null){
      editingId = id;
      modalOverlay.classList.add("open");
      modalOverlay.setAttribute("aria-hidden","false");

      const pr = id ? projects.find(x => x.id === id) : null;
      modalTitle.textContent = pr ? "Edit Project" : "New Project";
      modalExportBtn.disabled = !pr;

      nameInput.value = pr ? pr.name : "";
      startInput.value = pr ? (pr.startDate || "") : todayISO();
      fbInput.value = pr ? pr.feedback : "";

      todoInput.value = "";
      syncTodoAddBtn();

      const meta = pr
        ? `Stage: ${stageLabel(pr.stage)} · Updated: ${new Date(pr.updatedAt).toLocaleString()}`
        : "새 프로젝트를 만들고 Save를 눌러줘.";
      modalMeta.textContent = meta;

      pinBtn.textContent = pr && pr.pinned ? "Unpin" : "Pin";
      deleteProjectBtn.disabled = !pr;

      renderModalTodos(pr);

      // default focus
      setTimeout(() => (nameInput.value ? todoInput.focus() : nameInput.focus()), 0);
    }

    function closeModal(){
      modalOverlay.classList.remove("open");
      modalOverlay.setAttribute("aria-hidden","true");
      editingId = null;
      hideToast();
    }

    modalCloseBtn.addEventListener("click", closeModal);
    modalOverlay.addEventListener("click", (e) => {
      if(e.target === modalOverlay) closeModal();
    });

    function getEditingProject(){
      if(!editingId) return null;
      return projects.find(x => x.id === editingId) || null;
    }

    function renderModalTodos(pr){
      todoList.innerHTML = "";
      if(!pr){
        todoList.innerHTML = `<div class="hint">(Save 후 todo를 추가할 수 있어.)</div>`;
        return;
      }

      if(pr.todos.length === 0){
        todoList.innerHTML = `<div class="hint">(empty)</div>`;
        return;
      }

      for(const t of pr.todos){
        const row = document.createElement("div");
        row.className = "tItem" + (t.done ? " done" : "");
        row.innerHTML = `
          <button class="check" type="button" aria-label="toggle" data-mtog="${escapeHtml(pr.id)}" data-tid="${escapeHtml(t.id)}">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M20 7L10 17l-5-5" stroke="rgba(30,30,30,0.85)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div class="tText" title="${escapeHtml(t.text)}">${escapeHtml(t.text)}</div>
          <button class="del" type="button" aria-label="삭제" data-mdel="${escapeHtml(pr.id)}" data-tid="${escapeHtml(t.id)}">✕</button>
        `;
        todoList.appendChild(row);
      }
    }

    function syncTodoAddBtn(){
      const ok = (todoInput.value || "").trim().length > 0 && !!getEditingProject();
      todoAddBtn.disabled = !ok;
    }
    todoInput.addEventListener("input", syncTodoAddBtn);

    todoInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        if(!todoAddBtn.disabled) todoAddBtn.click();
      }
      if(e.key === "Escape"){
        closeModal();
      }
    });

    todoAddBtn.addEventListener("click", () => {
      const pr = getEditingProject();
      if(!pr) return;
      const text = (todoInput.value || "").trim();
      if(!text) return;

      pr.todos.unshift({ id: safeUUID(), text, done:false, createdAt: Date.now() });
      pr.updatedAt = Date.now();

      todoInput.value = "";
      syncTodoAddBtn();

      persist();
      renderModalTodos(pr);
      render();
    });

    todoList.addEventListener("click", (e) => {
      const tog = e.target.closest("[data-mtog]");
      if(tog){
        toggleTodo(tog.dataset.mtog, tog.dataset.tid);
        return;
      }
      const del = e.target.closest("[data-mdel]");
      if(del){
        deleteTodoWithUndo(del.dataset.mdel, del.dataset.tid);
        return;
      }
    });

    function deleteTodoWithUndo(pid, tid){
      const pr = projects.find(x => x.id === pid);
      if(!pr) return;
      const idx = pr.todos.findIndex(x => x.id === tid);
      if(idx < 0) return;
      const todo = pr.todos[idx];
      pr.todos.splice(idx, 1);
      pr.updatedAt = Date.now();
      persist();
      renderModalTodos(pr);
      render();
      showUndoToast("할 일을 삭제했어.", { type:"deleteTodo", projectId: pr.id, todo, index: idx });
    }

    clearDoneTodosBtn.addEventListener("click", () => {
      const pr = getEditingProject();
      if(!pr) return;
      const before = pr.todos.length;
      pr.todos = pr.todos.filter(t => !t.done);
      pr.updatedAt = Date.now();
      persist();
      renderModalTodos(pr);
      render();
      if(before !== pr.todos.length) showUndoToast("완료를 지웠어.", null);
    });

    pinBtn.addEventListener("click", () => {
      const pr = getEditingProject();
      if(!pr) return;
      pr.pinned = !pr.pinned;
      pr.updatedAt = Date.now();
      persist();
      pinBtn.textContent = pr.pinned ? "Unpin" : "Pin";
      modalMeta.textContent = `Stage: ${stageLabel(pr.stage)} · Updated: ${new Date(pr.updatedAt).toLocaleString()}`;
      render();
    });

    function moveStage(stage){
      const pr = getEditingProject();
      if(!pr) return;
      const from = pr.stage;
      if(from === stage) return;
      pr.stage = stage;
      pr.updatedAt = Date.now();
      persist();
      modalMeta.textContent = `Stage: ${stageLabel(pr.stage)} · Updated: ${new Date(pr.updatedAt).toLocaleString()}`;
      render();
      showUndoToast("이동했어.", { type:"moveProject", projectId: pr.id, fromStage: from, toStage: stage });
    }
    moveBacklogBtn.addEventListener("click", () => moveStage("backlog"));
    moveProgressBtn.addEventListener("click", () => moveStage("progress"));
    moveDoneBtn.addEventListener("click", () => moveStage("done"));

    deleteProjectBtn.addEventListener("click", () => {
      const pr = getEditingProject();
      if(!pr) return;
      deleteProjectWithUndo(pr.id);
      closeModal();
    });

    saveBtn.addEventListener("click", () => {
      const name = (nameInput.value || "").trim();
      const startDate = (startInput.value || "").trim();
      const feedback = (fbInput.value || "");

      if(!editingId){
        const pr = normalizeProject({
          id: safeUUID(),
          name,
          startDate,
          feedback,
          stage: "backlog",
          pinned: false,
          createdAt: Date.now(),
          updatedAt: Date.now(),
          todos: []
        });
        projects.unshift(pr);
        editingId = pr.id;
        modalTitle.textContent = "Edit Project";
        modalExportBtn.disabled = false;
        deleteProjectBtn.disabled = false;
        pinBtn.textContent = "Pin";
        modalMeta.textContent = `Stage: ${stageLabel(pr.stage)} · Updated: ${new Date(pr.updatedAt).toLocaleString()}`;
        persist();
        renderModalTodos(pr);
        render();
        syncTodoAddBtn();
        return;
      }

      const pr = getEditingProject();
      if(!pr) return;

      pr.name = name;
      pr.startDate = startDate;
      pr.feedback = feedback;
      pr.updatedAt = Date.now();

      persist();
      render();
      modalMeta.textContent = `Stage: ${stageLabel(pr.stage)} · Updated: ${new Date(pr.updatedAt).toLocaleString()}`;
    });

    // keep fb live edit in modal too
    [nameInput, startInput, fbInput].forEach(el => {
      el.addEventListener("input", () => {
        const pr = getEditingProject();
        if(!pr) return;
        // just update meta preview (save is explicit for name/date; feedback also applied on save)
      });
    });

    // Export (project)
    modalExportBtn.addEventListener("click", async () => {
      const pr = getEditingProject();
      if(!pr) return;
      const md = projectToMarkdown(pr);
      const ok = await copyToClipboard(md);
      showUndoToast(ok ? "Export(복사) 완료." : "복사 실패 (권한 확인)", null);
    });

    // export all
    exportAllBtn.addEventListener("click", async () => {
      const parts = projects
        .slice()
        .sort((a,b) => (b.updatedAt - a.updatedAt))
        .map(projectToMarkdown);
      const md = parts.join("\n\n---\n\n");
      const ok = await copyToClipboard(md);
      showUndoToast(ok ? "Export All(복사) 완료." : "복사 실패 (권한 확인)", null);
    });

    function projectToMarkdown(pr){
      const { total, done } = countTodos(pr);
      const lines = [];
      lines.push(`# ${pr.name || "(untitled)"}`);
      lines.push(`- Stage: ${stageLabel(pr.stage)}`);
      lines.push(`- Start: ${formatDateLabel(pr.startDate)}`);
      lines.push(`- Pinned: ${pr.pinned ? "yes" : "no"}`);
      lines.push(`- Todos: ${done}/${total}`);
      lines.push("");
      lines.push(`## Personal feedback`);
      lines.push(pr.feedback ? pr.feedback : "(empty)");
      lines.push("");
      lines.push(`## To-do`);
      if(pr.todos.length === 0) lines.push(`- (empty)`);
      else{
        for(const t of pr.todos){
          lines.push(`- [${t.done ? "x" : " "}] ${t.text}`);
        }
      }
      return lines.join("\n");
    }

    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        try{
          const ok = document.execCommand("copy");
          document.body.removeChild(ta);
          return ok;
        }catch(err){
          document.body.removeChild(ta);
          return false;
        }
      }
    }

    // Global new
    newBtn.addEventListener("click", () => openModal(null));

    // quick close ESC
    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && modalOverlay.classList.contains("open")){
        closeModal();
      }
    });

    // modal open from card click on textarea focus shouldn't open
    document.getElementById("board").addEventListener("dblclick", (e) => {
      const card = e.target.closest(".pCard");
      if(!card) return;
      const id = card.dataset.pid;
      if(id) openModal(id);
    });

    /* =========================
       Init
    ========================= */
    if(projects.length === 0){
      // seed examples (optional, minimal)
      projects = [
        normalizeProject({
          id: safeUUID(),
          name: "코딩: Projects 위젯 v1",
          startDate: todayISO(),
          feedback: "Backlog → In Progress → Done 흐름으로 작업 쪼개기.\nUndo/Export/드래그는 기본으로.",
          stage: "backlog",
          pinned: true,
          createdAt: Date.now()-200000,
          updatedAt: Date.now()-200000,
          todos: [
            { id: safeUUID(), text: "기본 UI/보드 구조", done: true, createdAt: Date.now()-190000 },
            { id: safeUUID(), text: "프로젝트 편집 모달", done: false, createdAt: Date.now()-180000 },
            { id: safeUUID(), text: "Export Markdown", done: false, createdAt: Date.now()-170000 }
          ]
        }),
        normalizeProject({
          id: safeUUID(),
          name: "AI 디자인: SD prompt 연습",
          startDate: todayISO(),
          feedback: "실험 로그를 feedback에 쌓고, 체크리스트로 반복 학습.",
          stage: "progress",
          pinned: false,
          createdAt: Date.now()-160000,
          updatedAt: Date.now()-160000,
          todos: [
            { id: safeUUID(), text: "prompt template 만들기", done: false, createdAt: Date.now()-150000 },
            { id: safeUUID(), text: "best 결과 5개만 선별", done: false, createdAt: Date.now()-140000 }
          ]
        })
      ];
      persist();
    }

    // filter default
    setFilter("all");
    render();

  </script>
</body>
</html>
