<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Upcoming — Soft Schedule</title>

  <style>
    :root{
      /* Pastel Skyblue (slightly desaturated) */
      --accent-1: rgba(165, 210, 235, 0.90);
      --accent-2: rgba(150, 195, 225, 0.55);
      --border:   rgba(150, 190, 220, 0.62);

      --text:  rgba(30,30,30,0.92);
      --muted: rgba(30,30,30,0.38);

      --glass:   rgba(255,255,255,0.10);
      --glass-2: rgba(255,255,255,0.06);

      --shadow: 0 10px 30px rgba(0,0,0,0.06);
      --radius: 20px;
    }

    @font-face{
      font-family: "EnterSanChaek";
      src: url("../fonts/엔터산책10.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    html, body{
      margin:0;
      padding:0;
      background: transparent;
      font-family: ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      color: var(--text);
    }

    .wrap{
      width: min(620px, 100%);
      margin: 0 auto;
      padding: clamp(10px, 2.6vw, 16px);
      box-sizing: border-box;
    }

    .card{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: clamp(14px, 2.8vw, 18px);
      background: var(--glass);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden; /* ✅ 팝업을 카드 안에 가두기 */
    }

    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(120% 80% at 0% 0%, rgba(165,210,235,0.22), transparent 55%),
        radial-gradient(80% 80% at 100% 20%, rgba(150,195,225,0.16), transparent 55%);
      pointer-events:none;
    }

    .inner{
      position: relative;
      z-index: 1;
      display: grid;
      gap: 12px;
    }

    .top{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .title{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }

    .pearl{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display: block;
      object-fit: cover;
      flex: 0 0 auto;
      box-shadow: 0 0 0 2px rgba(165,210,235,0.18);
    }

    .title h1{
      margin:0;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      font-size: clamp(15px, 3.8vw, 18px);
      letter-spacing: -0.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .meta{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      margin-left: auto;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }

    /* ===== Input Row ===== */
    .inputRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .input{
      flex: 1 1 220px;
      min-width: 0;
      border: 1px solid rgba(150,190,220,0.45);
      background: rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 12px 12px;
      outline: none;
      color: var(--text);
      font-size: 14px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .input::placeholder{ color: var(--muted); }

    /* Base button */
    .btn{
      flex: 0 0 auto;
      border: 1px solid rgba(150,190,220,0.70);
      background: rgba(165,210,235,0.18);
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 13px;
      color: rgba(30,30,30,0.85);
      cursor: pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease, box-shadow .18s ease, color .18s ease;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      white-space: nowrap;
    }
    .btn:active{ transform: scale(0.98); }
    .btn:hover{
      background: rgba(165,210,235,0.26);
      border-color: rgba(150,190,220,0.90);
      box-shadow: 0 0 0 3px rgba(165,210,235,0.20);
    }
    .btn:focus-visible{
      outline: none;
      border-color: rgba(150,190,220,0.90);
      box-shadow: 0 0 0 3px rgba(165,210,235,0.28);
    }

    /* Add (+) button: small round */
    #addUpcomingBtn{
      height: clamp(28px, 3.2vw, 32px);
      min-width: clamp(28px, 3.2vw, 32px);
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;

      color: rgba(150,190,220,0.55);
      background: rgba(255,255,255,0.70);
      border: 1px solid rgba(150,190,220,0.40);
      border-radius: 999px;

      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: box-shadow .18s ease, border-color .18s ease, background .18s ease, transform .12s ease;
    }
    #addUpcomingBtn:hover{
      background: rgba(255,255,255,0.62);
      border-color: rgba(150,190,220,0.65);
      box-shadow: 0 0 0 3px rgba(165,210,235,0.22);
    }
    #addUpcomingBtn:active{ transform: scale(0.96); }
    #addUpcomingBtn:disabled{
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
    }
    #addUpcomingBtn:disabled:hover{ box-shadow: none; }

    /* ===== Custom Date Picker Trigger (in row) ===== */
    .dpTrigger{
      flex: 0 0 auto;
      display: inline-flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;

      height: 38px;
      padding: 0 12px;

      border: 1px solid rgba(150,190,220,0.45);
      background: rgba(255,255,255,0.10);
      border-radius: 14px;

      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      user-select: none;

      transition: border-color .18s ease, box-shadow .18s ease, background .18s ease;
    }
    .dpText{
      font-size: 14px;
      color: var(--muted);
      white-space: nowrap;
    }
    .dpIcon{
      color: var(--muted);
      display: inline-flex;
      align-items: center;
    }
    .dpTrigger:hover{
      border-color: rgba(150,190,220,0.75);
      box-shadow: 0 0 0 3px rgba(165,210,235,0.20);
    }
    .dpTrigger:focus-visible{
      outline: none;
      border-color: rgba(150,190,220,0.85);
      box-shadow: 0 0 0 3px rgba(165,210,235,0.28);
    }
    .dpTrigger.filled .dpText,
    .dpTrigger.filled .dpIcon{
      color: rgba(30,30,30,0.78);
    }

    /* ===== Date Picker Popover (ABSOLUTE inside card) ===== */
    .dpPop{
      position: absolute;              /* ✅ 카드 내부에서만 */
      left: 0;
      top: 0;
      width: 320px;                    /* 논리 너비(스케일로 줄임) */
      z-index: 9999;

      border-radius: 16px;
      border: 1px solid rgba(150,190,220,0.45);
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 16px 40px rgba(0,0,0,0.12);
      padding: 10px;

      transform-origin: top left;
      transform: translateY(6px) scale(0.67); /* ✅ 1/3 줄이기(≈0.67) */

      opacity: 0;
      pointer-events: none;
      transition: opacity .14s ease, transform .14s ease;
    }
    .dpPop.open{
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0) scale(0.67);
    }

    .dpHeader{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 4px 2px 8px;
    }
    .dpTitle{
      font-size: 13px;
      color: rgba(30,30,30,0.78);
      letter-spacing: -0.2px;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .dpNav{
      width: 34px;
      height: 30px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.06);
      background: rgba(255,255,255,0.60);
      color: rgba(30,30,30,0.70);
      cursor: pointer;
      transition: box-shadow .18s ease, border-color .18s ease, transform .08s ease;
    }
    .dpNav:hover{
      border-color: rgba(150,190,220,0.65);
      box-shadow: 0 0 0 3px rgba(165,210,235,0.20);
    }
    .dpNav:active{ transform: scale(0.98); }
    .dpNav:focus-visible{
      outline: none;
      border-color: rgba(150,190,220,0.85);
      box-shadow: 0 0 0 3px rgba(165,210,235,0.28);
    }

    .dpDow{
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      padding: 2px 2px 6px;
      font-size: 11px;
      letter-spacing: 0.2px;
      color: rgba(30,30,30,0.72);
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .dpDow span:nth-child(1),
    .dpDow span:nth-child(7){
      color: rgba(30,30,30,0.72);
    }

    .dpGrid{
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      padding: 2px;
    }

    .dpDay{
      height: 34px;
      border-radius: 10px;

      /* ✅ 기본 테두리 안 보이게 */
      border: 1px solid transparent;
      background: rgba(255,255,255,0.55);
      color: rgba(30,30,30,0.78);
      font-size: 12px;
      cursor: pointer;

      display: grid;
      place-items: center;

      transition: box-shadow .18s ease, border-color .18s ease, background .18s ease, transform .08s ease;
    }
    .dpDay[disabled]{
      opacity: 0.35;
      cursor: default;
    }

    /* ✅ hover 유지 (테두리는 hover에서만 등장) */
    .dpDay:hover:not([disabled]){
      border-color: rgba(150,190,220,0.65);
      box-shadow: 0 0 0 3px rgba(165,210,235,0.18);
    }
    .dpDay:active:not([disabled]){ transform: scale(0.98); }
    .dpDay:focus-visible{
      outline: none;
      border-color: rgba(150,190,220,0.85);
      box-shadow: 0 0 0 3px rgba(165,210,235,0.28);
    }

    .dpDay.today::after{
      content:"";
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: rgba(30,30,30,0.58);
      margin-top: 2px;
    }

    .dpDay.selected{
      background: rgba(165,210,235,0.24);
      border-color: rgba(150,190,220,0.85); /* ✅ 선택 상태에만 테두리 */
      box-shadow: 0 0 0 3px rgba(165,210,235,0.22);
    }

    .dpFooter{
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding-top: 10px;
    }
    .dpAction{
      flex: 1 1 auto;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.06);
      background: rgba(255,255,255,0.60);
      color: rgba(30,30,30,0.78);
      font-size: 12px;
      cursor: pointer;
      transition: box-shadow .18s ease, border-color .18s ease, transform .08s ease;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .dpAction:hover{
      border-color: rgba(150,190,220,0.65);
      box-shadow: 0 0 0 3px rgba(165,210,235,0.20);
    }
    .dpAction:active{ transform: scale(0.98); }
    .dpAction:focus-visible{
      outline: none;
      border-color: rgba(150,190,220,0.85);
      box-shadow: 0 0 0 3px rgba(165,210,235,0.28);
    }
    .dpAction.primary{
      background: rgba(165,210,235,0.18);
      border-color: rgba(150,190,220,0.70);
    }

    /* ===== List ===== */
    .list{
      margin:0;
      padding:0;
      list-style:none;
      display:grid;
      gap: 8px;
    }

    .item{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(150,190,220,0.30);
      background: var(--glass-2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      min-width: 0;
    }

    .check{
      width: 18px;
      height: 18px;
      margin-top: 1px;
      border-radius: 6px;
      border: 1.6px solid rgba(150,190,220,0.95);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      transition: background .18s ease, border-color .18s ease, box-shadow .18s ease, transform .08s ease;
    }
    .check:hover{
      background: rgba(165,210,235,0.14);
      border-color: rgba(150,190,220,1);
      box-shadow: 0 0 0 3px rgba(165,210,235,0.20);
    }
    .check:active{ transform: scale(0.98); }
    .check:focus-visible{
      outline: none;
      background: rgba(165,210,235,0.12);
      border-color: rgba(150,190,220,1);
      box-shadow: 0 0 0 3px rgba(165,210,235,0.28);
    }

    .check svg{
      width: 12px;
      height: 12px;
      opacity: 0;
      transform: scale(0.9);
      transition: opacity .18s ease, transform .18s ease;
    }

    .badgeDate{
      flex: 0 0 auto;
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.06);
      background: rgba(255,255,255,0.55);
      color: rgba(30,30,30,0.70);
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .badgeDate.someday{
      background: rgba(165,210,235,0.16);
      border-color: rgba(150,190,220,0.35);
    }

    .text{
      flex: 1 1 auto;
      min-width: 0;
      line-height: 1.45;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .del{
      flex: 0 0 auto;
      border: none;
      background: transparent;
      color: rgba(30,30,30,0.55);
      cursor:pointer;
      font-size: 14px;
      padding: 6px 8px;
      border-radius: 10px;
      transition: background .18s ease, color .18s ease, box-shadow .18s ease, transform .08s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .del:hover{
      background: rgba(165,210,235,0.14);
      color: rgba(30,30,30,0.78);
      box-shadow: 0 0 0 3px rgba(165,210,235,0.20);
    }
    .del:active{ transform: scale(0.96); }
    .del:focus-visible{
      outline: none;
      background: rgba(165,210,235,0.12);
      color: rgba(30,30,30,0.78);
      box-shadow: 0 0 0 3px rgba(165,210,235,0.28);
    }

    .item.done{ opacity: 0.78; }
    .item.done .text{ text-decoration: line-through; color: rgba(30,30,30,0.50); }
    .item.done .check{
      background: rgba(165,210,235,0.22);
      border-color: rgba(150,190,220,1);
    }
    .item.done .check svg{ opacity: 1; transform: scale(1); }

        /* ===== Footer (match Today exactly) ===== */
    .footer{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    
      font-size: 12px;
      color: var(--muted);
    }
    
    /* ✅ bottom buttons: right aligned + horizontal scroll on narrow screens */
    .footer-actions{
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      width: 100%;
    
      flex-wrap: nowrap;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
    
      margin-left: auto;
      padding-left: 8px;
      padding-right: 2px;
    
      scrollbar-width: none;
    }
    .footer-actions::-webkit-scrollbar{ display: none; }
    .footer-actions > .btn{ flex: 0 0 auto; }
    
    /* ===== Toast (match Today exactly: not overlay, sits under countText) ===== */
    .toast{
      width: 100%;                 /* ✅ footer wrap 때문에 한 줄 내려가게 */
      margin-top: -2px;            /* ✅ done 바로 아래에 가깝게 */
      min-height: 0;
      height: auto;
    
      display: inline-flex;
      align-items: center;
      gap: 8px;
    
      padding: 0;
      background: transparent;
      border: none;
      box-shadow: none;
    
      color: rgba(30,30,30,0.62);
      font-size: 12px;
      line-height: 1;
    
      opacity: 0;
      transform: translateY(4px);
      pointer-events: none;
    
      transition: opacity .14s ease, transform .14s ease;
    }
    .toast:not(:empty){
      opacity: 1;
      transform: translateY(0);
    }
    .toast::before{
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent-1);
      box-shadow: 0 0 0 3px rgba(180, 210, 235, 0.22);
      flex: 0 0 auto;
    }

    
    /* ✅ footer buttons font (Copy/Clear done) */
    #copyBtn, #clearDoneBtn{
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }

  

    @media (max-width: 360px){
      .meta{ display:none; }
      .input{ flex-basis: 100%; }
      .dpTrigger{ width: 100%; }
      #addUpcomingBtn{ width: 100%; border-radius: 14px; height: 38px; }
    }

    @media (pointer: coarse){
      #addUpcomingBtn{ position: relative; }
      #addUpcomingBtn::after{ content:""; position:absolute; inset:-6px; }
      .dpTrigger{ position: relative; }
      .dpTrigger::after{ content:""; position:absolute; inset:-6px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card" id="card" role="application" aria-label="Upcoming Widget">
      <div class="inner">
        <div class="top">
          <div class="title">
            <img class="pearl" src="./icon/pearl.png" alt="" aria-hidden="true" />
            <h1>Upcoming</h1>
          </div>
          <div class="meta" id="metaText"></div>
        </div>

        <div class="inputRow">
          <input id="upcomingInput" class="input" type="text" placeholder="미래 할 일…" maxlength="80" />

          <button type="button" class="dpTrigger" id="dpTrigger" aria-haspopup="dialog" aria-expanded="false">
            <span class="dpText" id="dpText">날짜 선택</span>
            <span class="dpIcon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="16" height="16">
                <path d="M7 3v2M17 3v2M4 8h16M6 5h12a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2z"
                      fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
              </svg>
            </span>
          </button>

          <button class="btn" id="addUpcomingBtn" type="button" title="할 일 추가" aria-label="할 일 추가"></button>
        </div>

        <ul class="list" id="list"></ul>

        <div class="footer">
          <span id="countText">0/0 done</span>
          <span style="display:flex; gap:8px; align-items:center;">
            <button class="btn" id="copyBtn" type="button"
              style="padding:10px 12px; border-radius:12px; font-size:12px; background: rgba(255,255,255,0.08); border-color: rgba(150,190,220,0.45);">
              Copy
            </button>
            <button class="btn" id="clearDoneBtn" type="button"
              style="padding:10px 12px; border-radius:12px; font-size:12px; background: rgba(255,255,255,0.08); border-color: rgba(150,190,220,0.45);">
              Clear done
            </button>
          </span>
        </div>

        <div class="toast" id="toast"></div>
      </div>

      <!-- ✅ Date Picker Popover (now INSIDE card) -->
      <div class="dpPop" id="dpPop" role="dialog" aria-label="Date Picker">
        <div class="dpHeader">
          <button type="button" class="dpNav" id="dpPrev" aria-label="Previous month">‹</button>
          <div class="dpTitle" id="dpTitle">2026.01</div>
          <button type="button" class="dpNav" id="dpNext" aria-label="Next month">›</button>
        </div>

        <div class="dpDow" aria-hidden="true">
          <span>S</span><span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span>
        </div>

        <div class="dpGrid" id="dpGrid" role="grid" aria-label="Calendar days"></div>

        <div class="dpFooter">
          <button type="button" class="dpAction" id="dpBack">Back</button>
          <button type="button" class="dpAction primary" id="dpToday">Today</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Helpers =====
    function pad2(n){ return String(n).padStart(2,"0"); }
    function ymdDash(d=new Date()){
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }
    function ymdDotFromDash(s){
      const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(s||""));
      if(!m) return null;
      return `${m[1]}.${m[2]}.${m[3]}`;
    }
    function dashFromDate(d){
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }
    function fmtYM(d){
      return `${d.getFullYear()}.${pad2(d.getMonth()+1)}`;
    }
    function isSameDay(a, b){
      return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
    }
    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        try{
          const ok = document.execCommand("copy");
          document.body.removeChild(ta);
          return ok;
        }catch(err){
          document.body.removeChild(ta);
          return false;
        }
      }
    }

    // ===== UI refs =====
    const metaText = document.getElementById("metaText");
    const listEl = document.getElementById("list");
    const inputEl = document.getElementById("upcomingInput");
    const addBtn = document.getElementById("addUpcomingBtn");
    const countText = document.getElementById("countText");
    const toast = document.getElementById("toast");
    const copyBtn = document.getElementById("copyBtn");
    const clearDoneBtn = document.getElementById("clearDoneBtn");
    const cardEl = document.getElementById("card");

    // Add button icon
    addBtn.innerHTML = `
      <svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true">
        <path d="M12 5v14M5 12h14"
              stroke="currentColor"
              stroke-width="1.6"
              stroke-linecap="round"/>
      </svg>
    `;

    function showToast(msg){
      toast.textContent = msg;
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.textContent = "", 1600);
    }

    metaText.textContent = "Date optional";

    // ===== Storage =====
    const KEY_UPCOMING = "soft_schedule_upcoming_v1";

    function loadUpcoming(){
      try{
        const raw = localStorage.getItem(KEY_UPCOMING);
        if(!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      }catch(e){ return []; }
    }
    function saveUpcoming(items){
      localStorage.setItem(KEY_UPCOMING, JSON.stringify(items));
    }

    let state = loadUpcoming();

    // ===== Custom Date Picker (inside card) =====
    const dpTrigger = document.getElementById("dpTrigger");
    const dpText = document.getElementById("dpText");
    const dpPop = document.getElementById("dpPop");
    const dpTitle = document.getElementById("dpTitle");
    const dpGrid = document.getElementById("dpGrid");
    const dpPrev = document.getElementById("dpPrev");
    const dpNext = document.getElementById("dpNext");
    const dpBack = document.getElementById("dpBack");
    const dpToday = document.getElementById("dpToday");

    // selectedDate: "YYYY-MM-DD" or null
    let selectedDate = null;
    let view = new Date();
    view.setDate(1);

    // ✅ popover scale (CSS와 동일)
    const DP_SCALE = 0.67;

    function openDP(){
      dpTrigger.setAttribute("aria-expanded","true");
      dpPop.classList.add("open");
      renderDP();
      requestAnimationFrame(()=>{
        placeDP();
        dpPrev.focus();
      });
    }
    function closeDP(){
      dpTrigger.setAttribute("aria-expanded","false");
      dpPop.classList.remove("open");
    }

    function setSelected(dateObjOrNull, {close=true} = {}){
      if(!dateObjOrNull){
        selectedDate = null;
        dpText.textContent = "날짜 선택";
        dpTrigger.classList.remove("filled");
      }else{
        selectedDate = dashFromDate(dateObjOrNull);
        dpText.textContent = ymdDotFromDash(selectedDate);
        dpTrigger.classList.add("filled");
      }
      renderDP();
      if(close) closeDP();
    }

    function renderDP(){
      dpTitle.textContent = fmtYM(view);
      dpGrid.innerHTML = "";

      const today = new Date();
      const first = new Date(view.getFullYear(), view.getMonth(), 1);
      const last  = new Date(view.getFullYear(), view.getMonth()+1, 0);
      const daysInMonth = last.getDate();
      const startDow = first.getDay(); // Sunday=0

      for(let i=0;i<startDow;i++){
        const blank = document.createElement("button");
        blank.type = "button";
        blank.className = "dpDay";
        blank.disabled = true;
        blank.setAttribute("aria-hidden","true");
        blank.textContent = "";
        dpGrid.appendChild(blank);
      }

      for(let day=1; day<=daysInMonth; day++){
        const d = new Date(view.getFullYear(), view.getMonth(), day);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "dpDay";
        btn.textContent = String(day);
        btn.setAttribute("role","gridcell");

        if(isSameDay(d, today)) btn.classList.add("today");
        if(selectedDate && selectedDate === dashFromDate(d)) btn.classList.add("selected");

        btn.addEventListener("click", ()=> setSelected(d, {close:true}));
        dpGrid.appendChild(btn);
      }
    }

    function placeDP(){
      const r = dpTrigger.getBoundingClientRect();
      const cardR = cardEl.getBoundingClientRect();

      // dpPop의 "논리 크기"(스케일 전)
      const popW = dpPop.offsetWidth;
      const popH = dpPop.offsetHeight;

      // ✅ 실제 화면에서 차지하는 크기(스케일 반영)
      const scaledW = popW * DP_SCALE;
      const scaledH = popH * DP_SCALE;

      const gap = 8;
      const pad = 10;

      // 카드 내부 좌표로 변환
      const relLeft0 = r.left - cardR.left;
      const relTop0  = r.bottom - cardR.top;

      // 기본: 트리거 아래
      let left = relLeft0;
      let top  = relTop0 + gap;

      // 아래가 넘치면 위로
      if(top + scaledH > cardEl.clientHeight - pad){
        top = (r.top - cardR.top) - scaledH - gap;
      }

      // clamp (카드 내부)
      left = Math.max(pad, Math.min(left, cardEl.clientWidth - scaledW - pad));
      top  = Math.max(pad, Math.min(top,  cardEl.clientHeight - scaledH - pad));

      dpPop.style.left = `${left}px`;
      dpPop.style.top  = `${top}px`;
    }

    dpTrigger.addEventListener("click", (e)=>{
      e.stopPropagation();
      if(dpPop.classList.contains("open")) closeDP();
      else openDP();
    });

    dpPrev.addEventListener("click", ()=>{
      view = new Date(view.getFullYear(), view.getMonth()-1, 1);
      renderDP();
      placeDP();
    });
    dpNext.addEventListener("click", ()=>{
      view = new Date(view.getFullYear(), view.getMonth()+1, 1);
      renderDP();
      placeDP();
    });

    dpBack.addEventListener("click", ()=> setSelected(null, {close:true}));
    dpToday.addEventListener("click", ()=>{
      const t = new Date();
      view = new Date(t.getFullYear(), t.getMonth(), 1);
      setSelected(t, {close:true});
    });

    dpPop.addEventListener("click", (e)=> e.stopPropagation());
    document.addEventListener("click", ()=> { if(dpPop.classList.contains("open")) closeDP(); });
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && dpPop.classList.contains("open")){
        closeDP();
        dpTrigger.focus();
      }
    });

    window.addEventListener("resize", ()=> { if(dpPop.classList.contains("open")) placeDP(); }, {passive:true});
    window.addEventListener("scroll", ()=> { if(dpPop.classList.contains("open")) placeDP(); }, {passive:true});

    // ===== Add button enable/disable =====
    function syncAddButtonState(){
      const hasText = (inputEl.value || "").trim().length > 0;
      addBtn.disabled = !hasText;
    }
    inputEl.addEventListener("input", syncAddButtonState);
    syncAddButtonState();

    // ===== Render =====
    function sortUpcoming(items){
      const dated = [];
      const undated = [];
      for(const it of items){
        if(it.date) dated.push(it);
        else undated.push(it);
      }
      dated.sort((a,b)=> String(a.date).localeCompare(String(b.date)));
      undated.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
      return [...dated, ...undated];
    }

    function render(){
      state = sortUpcoming(state);

      listEl.innerHTML = "";
      for(const it of state){
        const li = document.createElement("li");
        li.className = "item" + (it.done ? " done" : "");

        const badgeText = it.date ? (ymdDotFromDash(it.date) || it.date) : "Someday";
        const badgeCls = "badgeDate" + (it.date ? "" : " someday");

        li.innerHTML = `
          <div class="check" role="checkbox" aria-checked="${it.done}" tabindex="0" data-id="${it.id}">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M20 7L10 17l-5-5" stroke="rgba(30,30,30,0.85)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <span class="${badgeCls}" title="${badgeText}">${badgeText}</span>
          <div class="text" title="${String(it.text||"").replace(/"/g,'&quot;')}">${String(it.text||"")}</div>
          <button class="del" type="button" aria-label="삭제" data-del="${it.id}">✕</button>
        `;
        listEl.appendChild(li);
      }

      const total = state.length;
      const done = state.filter(x => x.done).length;
      countText.textContent = `${done}/${total} done`;

      saveUpcoming(state);
    }

    function addItem(){
      const t = (inputEl.value || "").trim();
      if(!t) return;

      state.unshift({
        id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())),
        text: t,
        date: selectedDate || null,
        done: false,
        createdAt: Date.now()
      });

      inputEl.value = "";
      inputEl.focus();
      syncAddButtonState();

      // 추가 후 날짜는 다시 옵션 상태로
      setSelected(null, {close:false});

      showToast(selectedDate ? "날짜 포함으로 추가했어." : "Someday로 추가했어.");
      render();
    }

    function toggleItem(id){
      state = state.map(it => it.id === id ? ({...it, done: !it.done}) : it);
      render();
    }

    function deleteItem(id){
      state = state.filter(it => it.id !== id);
      render();
    }

    function clearDone(){
      const before = state.length;
      state = state.filter(it => !it.done);
      render();
      showToast(before === state.length ? "완료된 항목이 없어." : "완료 항목을 지웠어.");
    }

    // ===== Events =====
    addBtn.addEventListener("click", addItem);

    inputEl.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        if(!addBtn.disabled) addBtn.click();
      }
    });

    listEl.addEventListener("click", (e)=>{
      const check = e.target.closest(".check");
      const del = e.target.closest("[data-del]");
      if(check) toggleItem(check.dataset.id);
      else if(del) deleteItem(del.dataset.del);
    });

    listEl.addEventListener("keydown", (e)=>{
      const check = e.target.closest(".check");
      if(!check) return;
      if(e.key === "Enter" || e.key === " "){
        e.preventDefault();
        toggleItem(check.dataset.id);
      }
    });

    clearDoneBtn.addEventListener("click", clearDone);

    copyBtn.addEventListener("click", async ()=>{
      const lines = [];
      lines.push("[Upcoming]");
      for(const it of state){
        const dateLabel = it.date ? (ymdDotFromDash(it.date) || it.date) : "Someday";
        lines.push(`- [${it.done ? "x" : " "}] (${dateLabel}) ${it.text}`);
      }
      const ok = await copyToClipboard(lines.join("\n"));
      showToast(ok ? "복사했어." : "복사 실패 (브라우저 권한 확인)");
    });

    // Initial
    render();
  </script>
</body>
</html>
