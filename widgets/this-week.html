<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>This Week — Soft Schedule</title>

  <style>
    :root{
      --accent-1: rgba(165, 206, 240, 0.88);
      --accent-2: rgba(140, 190, 232, 0.52);
      --border:   rgba(140, 190, 232, 0.60);

      --text: rgba(30,30,30,0.92);
      --muted: rgba(30,30,30,0.38);

      --glass: rgba(255,255,255,0.10);
      --shadow: 0 10px 30px rgba(0,0,0,0.06);
      --radius: 20px;
    }

    @font-face{
      font-family: "EnterSanChaek";
      src: url("../fonts/엔터산책10.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    html, body{
      margin:0;
      padding:0;
      background: transparent;
      font-family: ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      color: var(--text);
    }

    .wrap{
      width: min(760px, 100%);
      margin: 0 auto;
      padding: clamp(10px, 2.6vw, 16px);
      box-sizing: border-box;
    }

    .card{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: clamp(14px, 2.8vw, 18px);
      background: var(--glass);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(120% 80% at 0% 0%, rgba(165,206,240,0.20), transparent 55%),
        radial-gradient(80% 80% at 100% 20%, rgba(140,190,232,0.14), transparent 55%);
      pointer-events:none;
    }

    .inner{
      position: relative;
      z-index: 1;
      display: grid;
      gap: 12px;
    }

    .top{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .title{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }

    .pearl{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display: block;
      object-fit: cover;
      flex: 0 0 auto;
      box-shadow: 0 0 0 2px rgba(165,206,240,0.22);
    }

    .title h1{
      margin:0;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      font-size: clamp(15px, 3.8vw, 18px);
      letter-spacing: -0.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .meta{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      margin-left: auto;
      font-variant-numeric: tabular-nums;
    }

    .controls{
      display:flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .inputRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      flex: 1 1 420px;
      min-width: 0;
    }

    .input{
      flex: 1 1 220px;
      min-width: 0;
      border: 1px solid rgba(140,190,232,0.45);
      background: rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 12px 12px;
      outline: none;
      color: var(--text);
      font-size: 14px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .input::placeholder{ color: rgba(30,30,30,0.45); }

    .btn{
      flex: 0 0 auto;
      border: 1px solid rgba(140,190,232,0.70);
      background: rgba(165,206,240,0.18);
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 13px;
      color: rgba(30,30,30,0.85);
      cursor: pointer;
      transition: transform .08s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease, color .18s ease;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      white-space: nowrap;
    }
    .btn:active{ transform: scale(0.98); }
    .btn:hover{
      background: rgba(165,206,240,0.24);
      border-color: rgba(140,190,232,0.90);
    }
    .btn:focus-visible{
      outline: none;
      box-shadow: 0 0 0 3px rgba(165,206,240,0.28);
    }

    .btn.secondary{
      border: 1px solid rgba(140,190,232,0.45);
      background: rgba(255,255,255,0.08);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .btn.secondary:hover{
      border-color: rgba(140,190,232,0.70);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.22);
      color: var(--accent-1);
    }

    #addBtn{
      height: clamp(28px, 3.2vw, 32px);
      min-width: clamp(28px, 3.2vw, 32px);
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: rgba(30,30,30,0.48);
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(140,190,232,0.45);
      border-radius: 999px;
      cursor: pointer;
      transition: background .18s ease, border-color .18s ease, box-shadow .18s ease, transform .08s ease;
    }
    #addBtn:hover{
      background: rgba(165,206,240,0.16);
      border-color: rgba(140,190,232,0.70);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.22);
    }
    #addBtn:active{ transform: scale(0.96); }
    #addBtn:disabled{
      opacity: 0.45;
      cursor: not-allowed;
      background: rgba(255,255,255,0.06);
      border-color: rgba(140,190,232,0.25);
      box-shadow: none;
      transform: none;
    }
    #addBtn:focus-visible{
      outline:none;
      box-shadow: 0 0 0 3px rgba(165,206,240,0.28);
    }

    .weekbar{
      display:flex;
      align-items: center;
      justify-content: flex-end;
      gap: 10px;
      flex: 0 0 auto;
    }

    .weeknav{
      display:flex;
      align-items:center;
      gap: 8px;
    }

    .navBtn{
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(140,190,232,0.45);
      background: rgba(255,255,255,0.08);
      cursor: pointer;
      display:grid;
      place-items:center;
      transition: box-shadow .18s ease, border-color .18s ease, background .18s ease, transform .08s ease;
    }
    .navBtn:hover{
      border-color: rgba(140,190,232,0.70);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.22);
    }
    .navBtn:active{ transform: scale(0.98); }
    .navBtn:focus-visible{ outline:none; box-shadow: 0 0 0 3px rgba(165,206,240,0.28); }

    .weekdays{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: nowrap;
    }

    .dayPill{
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(140,190,232,0.45);
      background: rgba(255,255,255,0.08);
      cursor:pointer;

      display:grid;
      place-items:center;

      font-size: 12px;
      color: rgba(30,30,30,0.70);
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;

      transition: background .18s ease, border-color .18s ease, box-shadow .18s ease, transform .08s ease, color .18s ease;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    .dayPill:hover{
      border-color: rgba(140,190,232,0.70);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.22);
      color: rgba(30,30,30,0.84);
    }
    .dayPill:active{ transform: scale(0.98); }
    .dayPill:focus-visible{
      outline:none;
      box-shadow: 0 0 0 3px rgba(165,206,240,0.28);
    }
    .dayPill.active{
      background: rgba(165,206,240,0.18);
      border-color: rgba(140,190,232,0.88);
      box-shadow: 0 10px 26px rgba(140,190,232,0.10);
      color: rgba(30,30,30,0.88);
    }

    .nextInboxRow{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;

      border: 1px solid rgba(140,190,232,0.30);
      background: rgba(255,255,255,0.06);
      border-radius: 14px;
      padding: 10px 10px;
      overflow: hidden;
      min-width: 0;
    }

    .nextInboxLeft{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }

    .nextInboxTitle{
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      color: rgba(30,30,30,0.82);
      font-size: 13px;
      white-space: nowrap;
    }

    .nextInboxCount{
      font-size: 12px;
      color: rgba(30,30,30,0.62);
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(140,190,232,0.35);
      border-radius: 999px;
      padding: 5px 10px;
      line-height: 1;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }

    .nextInboxRight{
      display:flex;
      gap: 8px;
      flex-wrap: nowrap;
      align-items:center;
      flex: 0 0 auto;
    }

    .popover{
      position: fixed;
      left: 0;
      top: 0;

      width: min(340px, calc(100vw - 24px));
      border-radius: 16px;
      border: 1px solid rgba(140,190,232,0.32);
      background: rgba(255,255,255,0.86);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 16px 40px rgba(0,0,0,0.12);
      z-index: 9999;

      opacity: 0;
      pointer-events: none;
      transform: translateY(6px);
      transition: opacity .14s ease, transform .14s ease;
      overflow: hidden;
    }
    .popover.open{
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .popHead{
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      gap: 10px;
      min-width: 0;
    }
    .popTitle{
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      font-size: 13px;
      color: rgba(30,30,30,0.86);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      min-width: 0;
    }
    .popClose{
      border: 1px solid rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.70);
      width: 30px;
      height: 30px;
      border-radius: 999px;
      cursor:pointer;
      color: rgba(30,30,30,0.70);
      display:grid;
      place-items:center;
      -webkit-tap-highlight-color: transparent;
      transition: box-shadow .18s ease, border-color .18s ease, transform .08s ease;
      flex: 0 0 auto;
    }
    .popClose:hover{
      border-color: rgba(140,190,232,0.55);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.20);
    }
    .popClose:active{ transform: scale(0.98); }
    .popClose:focus-visible{
      outline:none;
      border-color: rgba(140,190,232,0.78);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.28);
    }

    .popList{
      padding: 10px 12px;
      display:grid;
      gap: 8px;
      max-height: 46vh;
      overflow: auto;
    }

    .popItem{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(140,190,232,0.22);
      background: rgba(255,255,255,0.60);
      min-width:0;
    }

    .popText{
      flex:1 1 auto;
      min-width:0;
      font-size: 13px;
      color: rgba(30,30,30,0.86);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      line-height: 1.45;
    }
    .popItem.done .popText{
      text-decoration: line-through;
      color: rgba(30,30,30,0.55);
      opacity: 0.95;
    }

    .popFoot{
      padding: 10px 12px;
      border-top: 1px solid rgba(0,0,0,0.06);
      display:flex;
      justify-content:flex-end;
      gap: 8px;
      flex-wrap: nowrap;
    }

    .weekList{
      display:grid;
      gap: 10px;
      margin-top: 2px;
    }

    .daySection{
      border: 1px solid rgba(140,190,232,0.30);
      background: rgba(255,255,255,0.06);
      border-radius: 14px;
      padding: 10px;
      overflow: hidden;
    }

    .dayHead{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }

    .dayLabel{
      display:flex;
      align-items: baseline;
      gap: 10px;
      min-width: 0;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      color: rgba(30,30,30,0.82);
      font-size: 13px;
    }

    .dayLabel small{
      color: rgba(30,30,30,0.40);
      font-size: 12px;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }

    .showBtn{
      border: 1px solid rgba(140,190,232,0.35);
      background: rgba(255,255,255,0.08);
      color: rgba(30,30,30,0.72);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      cursor: pointer;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      transition: box-shadow .18s ease, border-color .18s ease, color .18s ease;
      white-space: nowrap;
    }
    .showBtn:hover{
      border-color: rgba(140,190,232,0.70);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.22);
      color: var(--accent-1);
    }
    .showBtn:focus-visible{ outline:none; box-shadow: 0 0 0 3px rgba(165,206,240,0.28); }

    .items{
      margin-top: 10px;
      display:grid;
      gap: 8px;
    }

    .item{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(140,190,232,0.22);
      background: rgba(255,255,255,0.06);
      min-width: 0;
    }

    .check{
      width: 18px;
      height: 18px;
      margin-top: 1px;
      border-radius: 6px;
      border: 1.6px solid rgba(140,190,232,0.95);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      transition: background .18s ease, border-color .18s ease, box-shadow .18s ease, transform .08s ease;
      appearance: none;
      -webkit-appearance: none;
      background: transparent;
      padding: 0;
    }
    .check:hover{
      background: rgba(165,206,240,0.12);
      border-color: rgba(140,190,232,1);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.22);
    }
    .check:active{ transform: scale(0.98); }
    .check:focus-visible{
      outline: none;
      background: rgba(165,206,240,0.10);
      border-color: rgba(140,190,232,1);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.28);
    }

    .check svg{
      width: 12px;
      height: 12px;
      opacity: 0;
      transform: scale(0.9);
      transition: opacity .18s ease, transform .18s ease;
    }

    .text{
      flex: 1 1 auto;
      min-width: 0;
      line-height: 1.45;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .del{
      flex: 0 0 auto;
      border: none;
      background: transparent;
      color: rgba(30,30,30,0.50);
      cursor:pointer;
      font-size: 14px;
      padding: 6px 8px;
      border-radius: 10px;
      transition: background .18s ease, color .18s ease, box-shadow .18s ease, transform .08s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .del:hover{
      background: rgba(165,206,240,0.12);
      color: rgba(30,30,30,0.78);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.20);
    }
    .del:active{ transform: scale(0.96); }
    .del:focus-visible{
      outline:none;
      background: rgba(165,206,240,0.10);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.28);
    }

    .item.done{ opacity: 0.78; }
    .item.done .text{ text-decoration: line-through; color: rgba(30,30,30,0.50); }
    .item.done .check{
      background: rgba(165,206,240,0.18);
      border-color: rgba(140,190,232,1);
    }
    .item.done .check svg{ opacity: 1; transform: scale(1); }

    .footer{
      display:flex;
      justify-content: space-between;
      align-items:flex-end;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .footerLeft{
      display:flex;
      flex-direction: column;
      gap: 6px;
      min-width: 160px;
    }

    .toast{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: rgba(30,30,30,0.62);
      font-size: 12px;
      line-height: 1;

      opacity: 0;
      transform: translateY(4px);
      pointer-events: none;

      transition: opacity .14s ease, transform .14s ease;
    }
    .toast:not(:empty){
      opacity: 1;
      transform: translateY(0);
    }
    .toast::before{
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(165,206,240,0.88);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.16);
      flex: 0 0 auto;
    }

    .footer-actions{
      display:flex;
      justify-content: flex-end;
      align-items:center;
      gap: 8px;
      flex-wrap: nowrap;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      padding-left: 8px;
      padding-right: 2px;
      scrollbar-width: none;
      width: 100%;
    }
    .footer-actions::-webkit-scrollbar{ display:none; }
    .footer-actions > .btn{ flex: 0 0 auto; }

    #historyBtn, #copyBtn, #clearDoneBtn{
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }

    @media (max-width: 420px){
      .weekbar{ width: 100%; justify-content: space-between; }
    }
    @media (max-width: 360px){
      .meta{ display:none; }
      .btn{ width: auto; }
      .input{ flex-basis: 100%; }
    }

    /* ===== Modal (Week History / Archive) ===== */
    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.18);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 10px;
      z-index: 5000;
      overflow: hidden;
    }
    .modalOverlay.open{ display:flex; }

    .modal{
      width: min(860px, 100%);
      max-height: calc(100vh - 20px);
      display: flex;
      flex-direction: column;
      border-radius: 18px;
      border: 1px solid rgba(140,190,232,0.38);
      background: rgba(255,255,255,0.84);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 18px 50px rgba(0,0,0,0.18);
      overflow: hidden;
      position: relative;
    }

    .modalHeader{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      flex-wrap: nowrap;
      min-width: 0;
      box-sizing: border-box;
    }

    .mhLeft{
      display:flex;
      gap: 10px;
      align-items:center;
      min-width: 0;
      flex: 1 1 auto;
    }
    .mhLeft strong{
      font-size: 14px;
      letter-spacing: -0.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      flex: 0 0 auto;
    }

    .search{
      border: 1px solid rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.70);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 12.5px;
      outline: none;
      min-width: 0;
      flex: 1 1 260px;
      width: 100%;
      box-sizing: border-box;
    }
    .search::placeholder{ color: rgba(30,30,30,0.45); }

    .mhRight{
      display:flex;
      gap: 8px;
      align-items:center;
      justify-content: flex-end;
      flex: 0 0 auto;
      min-width: 0;
      flex-wrap: nowrap;
    }

    .modalBody{
      display: grid;
      grid-template-columns: max-content 1fr;
      min-height: 0;
      flex: 1 1 auto;
      overflow: hidden;
    }

    .weeks{
      border-right: 1px solid rgba(0,0,0,0.06);
      padding: 12px 10px;
      overflow: auto;
      width: max-content;
      min-height: 0;
    }

    .weekRow{
      display:grid;
      grid-template-columns: 18px 1fr;
      gap: 10px;
      align-items:start;
      margin-bottom: 14px;
    }

    .wkChk{
      width: 18px;
      height: 18px;
      border-radius: 6px;
      border: 1.4px solid rgba(140,190,232,0.55);
      background: rgba(255,255,255,0.60);
      cursor:pointer;
      display:grid;
      place-items:center;
      flex: 0 0 auto;
      -webkit-tap-highlight-color: transparent;
    }
    .wkChk svg{
      width: 12px;
      height: 12px;
      opacity: 0;
    }
    .wkChk svg path{
      stroke: rgba(70,70,70,0.95);
    }
    .wkChk.on{
      background: rgba(165,206,240,0.20);
      border-color: rgba(140,190,232,0.75);
    }
    .wkChk.on svg{ opacity: 1; }

    .weekCol{
      display:grid;
      gap: 7px;
      min-width: 0;
    }

    .weekBtn{
      width: fit-content;
      max-width: 100%;
      display: grid;
      gap: 4px;
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(140,190,232,0.22);
      background: rgba(255,255,255,0.62);
      cursor: pointer;
      text-align: left;
      white-space: nowrap;
      font-size: 13px;
      color: rgba(30,30,30,0.88);
      transition: background .18s ease, border-color .18s ease, transform .08s ease;
      -webkit-tap-highlight-color: transparent;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .weekBtn:hover{
      border-color: rgba(140,190,232,0.45);
      background: rgba(255,255,255,0.72);
    }
    .weekBtn:active{ transform: scale(0.99); }
    .weekBtn small{
      display: block;
      font-size: 11px;
      color: rgba(30,30,30,0.52);
      margin-top: 0;
      font-variant-numeric: tabular-nums;
    }
    .weekBtn.active{
      border-color: rgba(140,190,232,0.70);
      background: rgba(165,206,240,0.14);
      box-shadow: 0 10px 26px rgba(140,190,232,0.10);
    }

    .pinTag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size: 11px;
      color: rgba(30,30,30,0.50);
      margin-left: 6px;
    }

    /* ✅ 아이콘 1.5배 */
    .weekActions{
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap: nowrap;
    }

    .iconBtn{
      width: 24px;   /* was 16 */
      height: 24px;  /* was 16 */
      border-radius: 999px;
      border: 1px solid rgba(140,190,232,0.18);
      background: rgba(255,255,255,0.70);
      cursor:pointer;
      display:grid;
      place-items:center;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
      transition: background .18s ease, border-color .18s ease, transform .08s ease;
    }
    .iconBtn:hover{
      border-color: rgba(140,190,232,0.38);
      background: rgba(255,255,255,0.78);
    }
    .iconBtn:active{ transform: scale(0.98); }

    .iconBtn svg{
      width: 15.5px;   /* was 10.5 */
      height: 15.5px;  /* was 10.5 */
      stroke: rgba(110,110,110,0.68);
    }
    .iconBtn.danger svg{
      stroke: rgba(120,120,120,0.72);
    }
    .iconBtn.on{
      border-color: rgba(140,190,232,0.45);
      background: rgba(165,206,240,0.18);
    }

    .preview{
      padding: 12px;
      overflow: auto;
      min-height: 0;
      display: grid;
      gap: 10px;
    }

    .previewTop{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: nowrap;
      min-width: 0;
    }
    .picked{
      font-size: 13px;
      color: rgba(30,30,30,0.82);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
      flex: 1 1 auto;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .previewTop > div:last-child{
      display:flex;
      gap: 8px;
      flex-wrap: nowrap;
      justify-content: flex-end;
      flex: 0 0 auto;
    }

    .previewBox{
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,255,255,0.66);
      display: grid;
      gap: 10px;
    }

    .pItem{
      display:flex;
      gap: 10px;
      align-items:center;
      font-size: 13px;
      color: rgba(30,30,30,0.86);
      line-height: 1.25;
      min-width: 0;
    }
    .pItem .pText{
      min-width: 0;
      flex: 1 1 auto;
    }

    .badge{
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.06);
      background: rgba(0,0,0,0.03);
      color: rgba(30,30,30,0.58);
      flex: 0 0 auto;
      font-variant-numeric: tabular-nums;
    }
    .badge.done{
      border-color: rgba(140,190,232,0.40);
      background: rgba(165,206,240,0.18);
      color: rgba(30,30,30,0.62);
    }
    .mark{
      background: rgba(165,206,240,0.35);
      border-radius: 6px;
      padding: 0 3px;
    }

    /* ✅ preview toggle done + delete */
    .pTog{
      width: 18px;
      height: 18px;
      border-radius: 6px;
      border: 1px solid rgba(140,190,232,0.35);
      background: rgba(255,255,255,0.70);
      cursor: pointer;
      display: grid;
      place-items: center;
      padding: 0;
      flex: 0 0 auto;
      -webkit-tap-highlight-color: transparent;
      transition: background .18s ease, border-color .18s ease, transform .08s ease;
    }
    .pTog:hover{
      border-color: rgba(140,190,232,0.55);
      background: rgba(255,255,255,0.82);
    }
    .pTog:active{ transform: scale(0.98); }
    .pTog svg{
      width: 12px;
      height: 12px;
      stroke: rgba(120,120,120,0.90);
      opacity: 0.0;
      transition: opacity .18s ease;
    }
    .pTog.on{
      border-color: rgba(140,190,232,0.55);
      background: rgba(165,206,240,0.14);
    }
    .pTog.on svg{ opacity: 1; }

    .pDel{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.06);
      background: rgba(255,255,255,0.70);
      cursor:pointer;
      display:grid;
      place-items:center;
      padding: 0;
      flex: 0 0 auto;
      -webkit-tap-highlight-color: transparent;
      transition: background .18s ease, border-color .18s ease, transform .08s ease;
    }
    .pDel:hover{
      border-color: rgba(0,0,0,0.10);
      background: rgba(255,255,255,0.82);
    }
    .pDel:active{ transform: scale(0.98); }
    .pDel svg{
      width: 12px;
      height: 12px;
      stroke: rgba(150,150,150,0.92);
    }

    .modalFooter{
      padding: 12px 14px;
      border-top: 1px solid rgba(0,0,0,0.06);
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      font-size: 12px;
      color: rgba(30,30,30,0.55);
      font-variant-numeric: tabular-nums;
    }

    /* ✅ Modal Undo toast */
    .mToast{
      position: absolute;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.90);
      border: 1px solid rgba(140,190,232,0.35);
      box-shadow: 0 14px 30px rgba(0,0,0,0.12);
      border-radius: 999px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 20;
      opacity: 0;
      pointer-events: none;
      transition: opacity .14s ease, transform .14s ease;
      transform-origin: center;
    }
    .mToast.show{
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) translateY(0);
    }
    .mToastMsg{
      font-size: 12.5px;
      color: rgba(30,30,30,0.75);
      white-space: nowrap;
    }
    .mUndoBtn{
      border: 1px solid rgba(140,190,232,0.55);
      background: rgba(165,206,240,0.16);
      color: rgba(30,30,30,0.82);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      cursor: pointer;
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .mUndoBtn:hover{
      border-color: rgba(140,190,232,0.80);
      box-shadow: 0 0 0 3px rgba(165,206,240,0.18);
    }

    @media (max-width: 420px){
      .modalBody{ grid-template-columns: 1fr; }
      .weeks{ border-right: none; border-bottom: 1px solid rgba(0,0,0,0.06); }
      .modalHeader{ flex-wrap: wrap; }
      .mhRight{ width: 100%; justify-content: flex-end; }
    }

    /* ===== Custom mini modal (for Next Week Add) ===== */
    .miniOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.18);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 10px;
      z-index: 9000;
    }
    .miniOverlay.open{ display:flex; }

    .miniModal{
      width: min(420px, calc(100vw - 20px));
      border-radius: 18px;
      border: 1px solid rgba(140,190,232,0.38);
      background: rgba(255,255,255,0.86);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 18px 50px rgba(0,0,0,0.18);
      overflow: hidden;
    }
    .miniHead{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
    }
    .miniHead strong{
      font-family: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      font-size: 14px;
      color: rgba(30,30,30,0.86);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .miniBody{ padding: 12px 14px; display:grid; gap:10px; }
    .miniInput{
      border: 1px solid rgba(140,190,232,0.45);
      background: rgba(255,255,255,0.70);
      border-radius: 14px;
      padding: 12px 12px;
      outline: none;
      color: var(--text);
      font-size: 14px;
      font-family: ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    .miniFoot{
      padding: 12px 14px;
      border-top: 1px solid rgba(0,0,0,0.06);
      display:flex;
      justify-content:flex-end;
      gap: 8px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card" role="application" aria-label="This Week Widget">
      <div class="inner">
        <div class="top">
          <div class="title">
            <img class="pearl" src="./icon/pearl.png" alt="" aria-hidden="true" />
            <h1>This Week</h1>
          </div>
          <div class="meta" id="rangeText"></div>
        </div>

        <div class="controls">
          <div class="inputRow">
            <input id="taskInput" class="input" type="text" placeholder="이번 주 할 일…" maxlength="80" />
            <button class="btn secondary" id="fromTodayBtn" type="button">From Today</button>
            <button class="btn secondary" id="pullBtn" type="button" title="Today에서 가져오기">Pull</button>
            <button class="btn secondary" id="pushBtn" type="button" title="Today로 보내기">Push</button>
            <button id="addBtn" type="button" title="할 일 추가" aria-label="할 일 추가"></button>
          </div>

          <div class="weekbar" aria-label="Week navigation">
            <div class="weeknav">
              <button class="navBtn" id="prevWeekBtn" type="button" aria-label="이전 주">
                <svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true">
                  <path d="M15 6l-6 6 6 6" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>

              <button class="navBtn" id="nextWeekBtn" type="button" aria-label="다음 주">
                <svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true">
                  <path d="M9 6l6 6-6 6" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>

            <div class="weekdays" id="weekdayPills" aria-label="요일 선택"></div>
          </div>
        </div>

        <div class="nextInboxRow" id="nextInboxRow" aria-label="Next Week Inbox">
          <div class="nextInboxLeft">
            <span class="nextInboxTitle">Next Week Inbox</span>
            <span class="nextInboxCount" id="nextInboxCount">0</span>
          </div>
          <div class="nextInboxRight">
            <button class="btn secondary" id="nextAddBtn" type="button">Add</button>
            <button class="btn secondary" id="nextShowBtn" type="button">Show</button>
          </div>
        </div>

        <div class="weekList" id="weekList"></div>

        <div class="footer">
          <div class="footerLeft">
            <span id="countText">0/0 done</span>
            <div class="toast" id="toast"></div>
          </div>

          <div class="footer-actions">
            <button class="btn secondary" id="historyBtn" type="button">History / Archive</button>
            <button class="btn secondary" id="copyBtn" type="button">Copy</button>
            <button class="btn secondary" id="clearDoneBtn" type="button">Clear done</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="popover" id="nextPopover" aria-hidden="true">
    <div class="popHead">
      <div class="popTitle" id="nextPopTitle">Next Week Inbox</div>
      <button class="popClose" id="nextPopCloseBtn" type="button" aria-label="닫기">✕</button>
    </div>

    <div class="popList" id="nextPopList"></div>

    <div class="popFoot">
      <button class="btn secondary" id="nextCopyBtn" type="button">Copy</button>
      <button class="btn secondary" id="nextClearDoneBtn" type="button">Clear done</button>
    </div>
  </div>

  <!-- History / Archive Modal -->
  <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Week History / Archive">
      <div class="modalHeader">
        <div class="mhLeft">
          <img class="pearl" src="./icon/pearl.png" alt="" aria-hidden="true" />
          <strong>Week History / Archive</strong>
          <input id="searchInput" class="search" type="text" placeholder="검색: 주차(YYYY.MM.DD~) 또는 할 일 키워드…" />
        </div>

        <div class="mhRight">
          <button class="btn secondary" id="bulkPinBtn" type="button" title="선택한 주차 Pin">Pin</button>
          <button class="btn secondary" id="bulkCopyMdBtn" type="button" title="선택한 주차 Markdown 내보내기">Export</button>
          <button class="btn secondary" id="bulkDeleteBtn" type="button" title="선택한 주차 삭제">Delete</button>
          <button class="btn secondary" id="bulkUnpinBtn" type="button" title="선택한 주차 Unpin">Clear</button>
          <button class="btn secondary" id="closeModalBtn" type="button">닫기</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="weeks" id="weeksPanel"></div>

        <div class="preview">
          <div class="previewTop">
            <div class="picked" id="pickedWeekText">주차를 선택해줘</div>
            <div>
              <button class="btn secondary" id="restoreWeekBtn" type="button" disabled>Restore</button>
              <button class="btn secondary" id="copyWeekBtn" type="button" disabled>Copy</button>
              <button class="btn secondary" id="copyWeekMdBtn" type="button" disabled>Copy MD</button>
              <button class="btn secondary" id="downloadWeekMdBtn" type="button" disabled>Download MD</button>
            </div>
          </div>

          <div class="previewBox" id="previewBox">
            <div style="color: rgba(30,30,30,0.55); font-size:12px;">
              왼쪽에서 주차를 선택하면, 그 주의 기록을 보여줘.
            </div>
          </div>
        </div>
      </div>

      <div class="modalFooter">
        <span id="archiveMeta">자동 아카이브: ON</span>
        <span id="archiveCount">0 / 0 weeks</span>
      </div>

      <!-- ✅ Undo Toast -->
      <div class="mToast" id="mToast" aria-hidden="true">
        <div class="mToastMsg" id="mToastMsg">삭제했어.</div>
        <button class="mUndoBtn" id="mUndoBtn" type="button">Undo</button>
      </div>
    </div>
  </div>

  <div class="miniOverlay" id="miniOverlay" aria-hidden="true">
    <div class="miniModal" role="dialog" aria-modal="true" aria-label="Next Week Add">
      <div class="miniHead">
        <strong>Next Week Inbox에 넣을 한 줄</strong>
        <button class="popClose" id="miniCloseBtn" type="button" aria-label="닫기">✕</button>
      </div>
      <div class="miniBody">
        <input id="miniInput" class="miniInput" type="text" maxlength="120" placeholder="한 줄 입력…" />
      </div>
      <div class="miniFoot">
        <button class="btn secondary" id="miniCancelBtn" type="button">취소</button>
        <button class="btn secondary" id="miniOkBtn" type="button">확인</button>
      </div>
    </div>
  </div>

  <script>
    /* ========= storage keys ========= */
    const WEEK_PREFIX = "soft_schedule_week_";
    const WEEK_ARCHIVE_KEY = "soft_schedule_week_archive_v2";

    const WORKSPACE_ID_STORAGE_KEY = "soft_schedule_workspace_id_v1";
    function getWorkspaceIdMaybe(){
      const v = localStorage.getItem(WORKSPACE_ID_STORAGE_KEY);
      return (v && String(v).trim()) ? String(v).trim() : "";
    }
    const workspace_id = getWorkspaceIdMaybe();
    const TODAY_PREFIX_SCOPED = workspace_id ? `soft_schedule_today_${workspace_id}_` : "soft_schedule_today_";
    const TODAY_PREFIX_FALLBACK = "soft_schedule_today_";

    /* ========= utils ========= */
    function pad2(n){ return String(n).padStart(2,"0"); }
    function ymd(d=new Date()){
      return `${d.getFullYear()}.${pad2(d.getMonth()+1)}.${pad2(d.getDate())}`;
    }
    function parseYmd(str){
      const m = /^(\d{4})\.(\d{2})\.(\d{2})$/.exec(str);
      if(!m) return null;
      return { y:+m[1], m:+m[2], d:+m[3] };
    }
    function ymdToDate(str){
      const p = parseYmd(str);
      if(!p) return null;
      return new Date(p.y, p.m-1, p.d);
    }
    function dateToYmd(d){
      return `${d.getFullYear()}.${pad2(d.getMonth()+1)}.${pad2(d.getDate())}`;
    }
    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#039;"
      }[m]));
    }
    function showToast(msg){
      toast.textContent = msg;
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.textContent = "", 1600);
    }
    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        try{
          const ok = document.execCommand("copy");
          document.body.removeChild(ta);
          return ok;
        }catch(err){
          document.body.removeChild(ta);
          return false;
        }
      }
    }
    function downloadText(filename, text){
      const blob = new Blob([text], { type: "text/markdown;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function mondayOfWeek(d){
      const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const day = x.getDay();
      const diff = (day === 0) ? -6 : (1 - day);
      x.setDate(x.getDate() + diff);
      x.setHours(0,0,0,0);
      return x;
    }
    function addDays(d, n){
      const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      x.setDate(x.getDate() + n);
      x.setHours(0,0,0,0);
      return x;
    }
    function weekIdFromMonday(monday){
      const start = dateToYmd(monday);
      const end = dateToYmd(addDays(monday, 6));
      return `${start} ~ ${end}`;
    }
    function parseWeekRangeId(weekId){
      const parts = String(weekId || "").split("~");
      if(parts.length < 2) return null;
      const startStr = parts[0].trim();
      const endStr = parts[1].trim();
      const start = ymdToDate(startStr);
      const end = ymdToDate(endStr);
      if(!start || !end) return null;
      start.setHours(0,0,0,0);
      end.setHours(0,0,0,0);
      return { startStr, endStr, start, end };
    }

    function highlight(text, query){
      const t = String(text);
      const q = String(query || "").trim();
      if(!q) return escapeHtml(t);
      const idx = t.toLowerCase().indexOf(q.toLowerCase());
      if(idx === -1) return escapeHtml(t);
      const before = escapeHtml(t.slice(0, idx));
      const mid = escapeHtml(t.slice(idx, idx + q.length));
      const after = escapeHtml(t.slice(idx + q.length));
      return `${before}<span class="mark">${mid}</span>${after}`;
    }

    /* ========= archive (meta only, state may be local week) ========= */
    function loadWeekArchiveV2(){
      try{
        const raw = localStorage.getItem(WEEK_ARCHIVE_KEY);
        if(!raw) return { weeks: {} };
        const parsed = JSON.parse(raw);
        if(parsed && parsed.weeks && typeof parsed.weeks === "object"){
          return { weeks: parsed.weeks };
        }
        // migrate v1
        if(parsed && typeof parsed === "object"){
          const weeks = {};
          for(const [id, val] of Object.entries(parsed)){
            if(!val || typeof val !== "object") continue;
            weeks[id] = { state: normalizeWeekState(val), meta: { pinned: false } };
          }
          const out = { weeks };
          saveWeekArchiveV2(out);
          return out;
        }
        return { weeks: {} };
      }catch(e){
        return { weeks: {} };
      }
    }
    function saveWeekArchiveV2(archive){
      localStorage.setItem(WEEK_ARCHIVE_KEY, JSON.stringify(archive));
    }

    function emptyWeekState(){
      const days = {};
      for(let i=0;i<7;i++) days[String(i)] = [];
      return { days, nextInbox: [] };
    }
    function normalizeWeekState(parsed){
      const base = emptyWeekState();
      if(!parsed || typeof parsed !== "object") return base;

      if(parsed.days && typeof parsed.days === "object"){
        for(let i=0;i<7;i++){
          const k = String(i);
          base.days[k] = Array.isArray(parsed.days[k]) ? parsed.days[k] : [];
        }
      }
      base.nextInbox = Array.isArray(parsed.nextInbox) ? parsed.nextInbox : [];
      return base;
    }

    function loadWeek(key){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return emptyWeekState();
        const parsed = JSON.parse(raw);
        return normalizeWeekState(parsed);
      }catch(e){ return emptyWeekState(); }
    }
    function saveWeek(key, data){
      localStorage.setItem(key, JSON.stringify(normalizeWeekState(data)));
    }

    // keep older weeks saved to archive store when they pass
    function autoArchivePastWeeks(){
      const archive = loadWeekArchiveV2();
      const thisWeekMon = mondayOfWeek(new Date());
      let changed = false;

      for(let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if(!k) continue;
        if(k === WEEK_ARCHIVE_KEY) continue;
        if(!k.startsWith(WEEK_PREFIX)) continue;

        const weekId = k.slice(WEEK_PREFIX.length);
        const rng = parseWeekRangeId(weekId);
        if(!rng) continue;

        if(rng.end.getTime() < thisWeekMon.getTime()){
          if(!archive.weeks[weekId]){
            try{
              const raw = localStorage.getItem(k);
              const data = raw ? JSON.parse(raw) : null;
              if(data && typeof data === "object"){
                archive.weeks[weekId] = { state: normalizeWeekState(data), meta: { pinned: false } };
                changed = true;
              }
            }catch(e){}
          }
        }
      }
      if(changed) saveWeekArchiveV2(archive);
      return archive;
    }

    /* ========= DOM ========= */
    const rangeText = document.getElementById("rangeText");
    const weekdayPills = document.getElementById("weekdayPills");

    const taskInput = document.getElementById("taskInput");
    const fromTodayBtn = document.getElementById("fromTodayBtn");
    const pullBtn = document.getElementById("pullBtn");
    const pushBtn = document.getElementById("pushBtn");
    const addBtn = document.getElementById("addBtn");

    const prevWeekBtn = document.getElementById("prevWeekBtn");
    const nextWeekBtn = document.getElementById("nextWeekBtn");

    const weekList = document.getElementById("weekList");

    const countText = document.getElementById("countText");
    const historyBtn = document.getElementById("historyBtn");
    const copyBtn = document.getElementById("copyBtn");
    const clearDoneBtn = document.getElementById("clearDoneBtn");

    const toast = document.getElementById("toast");

    const nextInboxCount = document.getElementById("nextInboxCount");
    const nextAddBtn = document.getElementById("nextAddBtn");
    const nextShowBtn = document.getElementById("nextShowBtn");

    const nextPopover = document.getElementById("nextPopover");
    const nextPopCloseBtn = document.getElementById("nextPopCloseBtn");
    const nextPopList = document.getElementById("nextPopList");
    const nextCopyBtn = document.getElementById("nextCopyBtn");
    const nextClearDoneBtn = document.getElementById("nextClearDoneBtn");
    const cardEl = document.querySelector(".card");

    const modalOverlay = document.getElementById("modalOverlay");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const weeksPanel = document.getElementById("weeksPanel");
    const pickedWeekText = document.getElementById("pickedWeekText");
    const previewBox = document.getElementById("previewBox");
    const restoreWeekBtn = document.getElementById("restoreWeekBtn");
    const copyWeekBtn = document.getElementById("copyWeekBtn");
    const archiveCount = document.getElementById("archiveCount");
    const searchInput = document.getElementById("searchInput");

    const bulkPinBtn = document.getElementById("bulkPinBtn");
    const bulkCopyMdBtn = document.getElementById("bulkCopyMdBtn");
    const bulkDeleteBtn = document.getElementById("bulkDeleteBtn");
    const bulkUnpinBtn = document.getElementById("bulkUnpinBtn");

    const copyWeekMdBtn = document.getElementById("copyWeekMdBtn");
    const downloadWeekMdBtn = document.getElementById("downloadWeekMdBtn");

    const miniOverlay = document.getElementById("miniOverlay");
    const miniCloseBtn = document.getElementById("miniCloseBtn");
    const miniCancelBtn = document.getElementById("miniCancelBtn");
    const miniOkBtn = document.getElementById("miniOkBtn");
    const miniInput = document.getElementById("miniInput");

    // modal toast (Undo)
    const mToast = document.getElementById("mToast");
    const mToastMsg = document.getElementById("mToastMsg");
    const mUndoBtn = document.getElementById("mUndoBtn");

    /* ========= add icon ========= */
    addBtn.innerHTML = `
      <svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true">
        <path d="M12 5v14M5 12h14"
              stroke="currentColor"
              stroke-width="1.6"
              stroke-linecap="round"/>
      </svg>
    `;

    /* ========= Week runtime state ========= */
    const WK = ["M","T","W","T","F","S","S"];
    const DOW_LABEL = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

    let viewMonday = mondayOfWeek(new Date());
    let selectedDayIndex = (() => {
      const today = new Date();
      const mon = mondayOfWeek(today);
      const diff = Math.round((today - mon) / 86400000);
      return Math.min(6, Math.max(0, diff));
    })();

    const expanded = new Map();

    function getWeekId(){ return weekIdFromMonday(viewMonday); }
    function getWeekKey(){ return WEEK_PREFIX + getWeekId(); }

    let weekArchive = autoArchivePastWeeks();
    let weekState = loadWeek(getWeekKey());

    function persistCurrentWeek(){
      saveWeek(getWeekKey(), weekState);
    }

    function syncAddButtonState(){
      const hasText = (taskInput.value || "").trim().length > 0;
      addBtn.disabled = !hasText;
    }
    taskInput.addEventListener("input", syncAddButtonState);
    syncAddButtonState();

    function buildWeekdayPills(){
      weekdayPills.innerHTML = "";
      for(let i=0;i<7;i++){
        const b = document.createElement("button");
        b.type = "button";
        b.className = "dayPill" + (i === selectedDayIndex ? " active" : "");
        b.dataset.day = String(i);
        b.textContent = WK[i];
        weekdayPills.appendChild(b);
      }
    }

    function setSelectedDay(i){
      selectedDayIndex = i;
      buildWeekdayPills();
      renderWeekList();
    }

    weekdayPills.addEventListener("click", (e) => {
      const btn = e.target.closest(".dayPill");
      if(!btn) return;
      const i = Number(btn.dataset.day);
      if(Number.isFinite(i)) setSelectedDay(i);
    });

    function dayDateStr(i){
      const d = addDays(viewMonday, i);
      return dateToYmd(d);
    }

    function totalAndDoneForDay(i){
      const arr = weekState.days[String(i)] || [];
      const total = arr.length;
      const done = arr.filter(x => x.done).length;
      return { total, done };
    }

    function renderNextInboxRow(){
      const arr = weekState.nextInbox || [];
      nextInboxCount.textContent = String(arr.length);
    }

    function renderNextPopover(){
      const arr = weekState.nextInbox || [];
      nextPopList.innerHTML = "";

      if(arr.length === 0){
        nextPopList.innerHTML = `<div style="color: rgba(30,30,30,0.55); font-size:12px;">(empty)</div>`;
        return;
      }

      for(const it of arr){
        const row = document.createElement("div");
        row.className = "popItem" + (it.done ? " done" : "");
        row.innerHTML = `
          <button class="check" type="button" role="checkbox" aria-checked="${it.done}" data-nx-id="${escapeHtml(it.id)}">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M20 7L10 17l-5-5" stroke="rgba(30,30,30,0.85)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div class="popText" title="${escapeHtml(it.text)}">${escapeHtml(it.text)}</div>
          <button class="del" type="button" aria-label="삭제" data-nx-del="${escapeHtml(it.id)}">✕</button>
        `;
        nextPopList.appendChild(row);
      }
    }

    function renderWeekList(){
      rangeText.textContent = getWeekId();
      weekList.innerHTML = "";

      let allTotal = 0;
      let allDone = 0;

      for(let i=0;i<7;i++){
        const { total, done } = totalAndDoneForDay(i);
        allTotal += total;
        allDone += done;

        const section = document.createElement("div");
        section.className = "daySection";
        section.dataset.day = String(i);

        const head = document.createElement("div");
        head.className = "dayHead";

        const label = document.createElement("div");
        label.className = "dayLabel";
        label.innerHTML = `
          <span>${DOW_LABEL[i]}</span>
          <small>${escapeHtml(dayDateStr(i))}</small>
        `;

        const toggleWrap = document.createElement("div");

        if(total >= 2){
          const isOpen = expanded.get(i) === true;
          const tBtn = document.createElement("button");
          tBtn.type = "button";
          tBtn.className = "showBtn";
          tBtn.textContent = isOpen ? `Hide (${done}/${total})` : `Show (${done}/${total})`;
          tBtn.dataset.toggle = "1";
          toggleWrap.appendChild(tBtn);
        }

        head.appendChild(label);
        head.appendChild(toggleWrap);

        const itemsBox = document.createElement("div");
        itemsBox.className = "items";

        const list = weekState.days[String(i)] || [];
        const isOpen = expanded.get(i) === true;

        let visible = list;
        if(total >= 2 && !isOpen) visible = list.slice(0, 1);

        for(const it of visible){
          const row = document.createElement("div");
          row.className = "item" + (it.done ? " done" : "");
          row.innerHTML = `
            <button class="check" type="button" role="checkbox" aria-checked="${it.done}" data-id="${it.id}" data-day="${i}">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M20 7L10 17l-5-5" stroke="rgba(30,30,30,0.85)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div class="text" title="${escapeHtml(it.text)}">${escapeHtml(it.text)}</div>
            <button class="del" type="button" aria-label="삭제" data-del="${it.id}" data-day="${i}">✕</button>
          `;
          itemsBox.appendChild(row);
        }

        label.style.cursor = "pointer";
        label.addEventListener("click", () => setSelectedDay(i));

        section.appendChild(head);
        if(total > 0) section.appendChild(itemsBox);

        if(i === selectedDayIndex){
          section.style.borderColor = "rgba(140,190,232,0.45)";
          section.style.background = "rgba(255,255,255,0.08)";
        }

        weekList.appendChild(section);
      }

      countText.textContent = `${allDone}/${allTotal} done`;
      renderNextInboxRow();
    }

    buildWeekdayPills();
    renderWeekList();

    function addItemToDay(dayIndex, text){
      const t = (text || "").trim();
      if(!t) return;

      const dayKey = String(dayIndex);
      const arr = weekState.days[dayKey] || (weekState.days[dayKey] = []);
      arr.unshift({
        id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())),
        text: t,
        done: false
      });
      persistCurrentWeek();
      renderWeekList();
    }

    function toggleItem(dayIndex, id){
      const dayKey = String(dayIndex);
      const arr = weekState.days[dayKey] || [];
      weekState.days[dayKey] = arr.map(it => it.id === id ? ({ ...it, done: !it.done }) : it);
      persistCurrentWeek();
      renderWeekList();
    }

    function deleteItem(dayIndex, id){
      const dayKey = String(dayIndex);
      const arr = weekState.days[dayKey] || [];
      weekState.days[dayKey] = arr.filter(it => it.id !== id);
      persistCurrentWeek();
      renderWeekList();
    }

    function clearDone(){
      for(let i=0;i<7;i++){
        const k = String(i);
        weekState.days[k] = (weekState.days[k] || []).filter(it => !it.done);
      }
      persistCurrentWeek();
      renderWeekList();
      showToast("완료를 지웠어.");
    }

    function addNextInbox(text){
      const t = (text || "").trim();
      if(!t) return;

      const arr = weekState.nextInbox || (weekState.nextInbox = []);
      arr.unshift({
        id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())),
        text: t,
        done: false
      });
      persistCurrentWeek();
      renderNextInboxRow();
      if(nextPopover.classList.contains("open")) renderNextPopover();
      showToast("Next Week Inbox에 추가했어.");
    }

    function toggleNextInbox(id){
      const arr = weekState.nextInbox || [];
      weekState.nextInbox = arr.map(it => it.id === id ? ({ ...it, done: !it.done }) : it);
      persistCurrentWeek();
      renderNextInboxRow();
      renderNextPopover();
    }

    function deleteNextInbox(id){
      const arr = weekState.nextInbox || [];
      weekState.nextInbox = arr.filter(it => it.id !== id);
      persistCurrentWeek();
      renderNextInboxRow();
      renderNextPopover();
    }

    function clearNextDone(){
      const arr = weekState.nextInbox || [];
      weekState.nextInbox = arr.filter(it => !it.done);
      persistCurrentWeek();
      renderNextInboxRow();
      renderNextPopover();
      showToast("Next Week 완료를 지웠어.");
    }

    async function copyNextInbox(){
      const arr = weekState.nextInbox || [];
      const lines = [];
      lines.push(`# Next Week Inbox`);
      lines.push(`> from ${getWeekId()}`);
      lines.push("");
      if(arr.length === 0) lines.push(`- (empty)`);
      else for(const it of arr) lines.push(`- [${it.done ? "x" : " "}] ${it.text}`);
      const ok = await copyToClipboard(lines.join("\n"));
      showToast(ok ? "Next Week Inbox를 복사했어." : "복사 실패 (권한 확인)");
    }

    weekList.addEventListener("click", (e) => {
      const tbtn = e.target.closest("[data-toggle]");
      if(tbtn){
        const section = e.target.closest(".daySection");
        if(!section) return;
        const day = Number(section.dataset.day);
        const cur = expanded.get(day) === true;
        expanded.set(day, !cur);
        renderWeekList();
        return;
      }

      const check = e.target.closest(".check");
      const del = e.target.closest("[data-del]");
      if(check && check.dataset.id){
        const day = Number(check.dataset.day);
        toggleItem(day, check.dataset.id);
      } else if(del){
        const day = Number(del.dataset.day);
        deleteItem(day, del.dataset.del);
      }
    });

    addBtn.addEventListener("click", () => {
      addItemToDay(selectedDayIndex, taskInput.value);
      taskInput.value = "";
      taskInput.focus();
      syncAddButtonState();
      showToast(`${DOW_LABEL[selectedDayIndex]}에 추가했어.`);
    });

    taskInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        if(!addBtn.disabled) addBtn.click();
      }
    });

    fromTodayBtn.addEventListener("click", () => {
      const today = new Date();
      const mon = mondayOfWeek(today);
      const sameWeek = (dateToYmd(mon) === dateToYmd(viewMonday));
      if(!sameWeek){
        showToast("현재 보고 있는 주가 이번 주가 아니야.");
        return;
      }
      const idx = Math.min(6, Math.max(0, Math.round((today - mon)/86400000)));
      setSelectedDay(idx);
      showToast("Today 기준으로 이동했어.");
    });

    function readTodayList(){
      const key1 = TODAY_PREFIX_SCOPED + ymd(new Date());
      const key2 = TODAY_PREFIX_FALLBACK + ymd(new Date());

      let data = null;
      for(const k of [key1, key2]){
        try{
          const raw = localStorage.getItem(k);
          if(!raw) continue;
          const parsed = JSON.parse(raw);
          if(Array.isArray(parsed)){
            data = parsed;
            break;
          }
        }catch(e){}
      }
      return Array.isArray(data) ? data : [];
    }

    function writeTodayList(list){
      const key = TODAY_PREFIX_SCOPED + ymd(new Date());
      localStorage.setItem(key, JSON.stringify(Array.isArray(list) ? list : []));
    }

    pullBtn.addEventListener("click", () => {
      const src = readTodayList();

      if(!Array.isArray(src) || src.length === 0){
        showToast("Today 기록이 없어.");
        return;
      }

      const unfinished = src.filter(x => !x.done && (x.text||"").trim());
      if(unfinished.length === 0){
        showToast("가져올 미완료가 없어.");
        return;
      }

      const dayKey = String(selectedDayIndex);
      const arr = weekState.days[dayKey] || (weekState.days[dayKey] = []);
      const existing = new Set(arr.map(x => (x.text||"").trim()));

      let added = 0;
      for(const it of unfinished){
        const tx = (it.text||"").trim();
        if(!tx) continue;
        if(existing.has(tx)) continue;
        arr.unshift({
          id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())),
          text: tx,
          done: false
        });
        existing.add(tx);
        added++;
      }

      if(added === 0){
        showToast("이미 이번 주에 있어.");
        return;
      }

      persistCurrentWeek();
      renderWeekList();
      showToast(`Today에서 ${added}개 가져왔어.`);
    });

    pushBtn.addEventListener("click", () => {
      let dest = readTodayList();
      if(!Array.isArray(dest)) dest = [];

      const dayArr = weekState.days[String(selectedDayIndex)] || [];
      const unfinished = dayArr.filter(x => !x.done && (x.text||"").trim());
      if(unfinished.length === 0){
        showToast("보낼 미완료가 없어.");
        return;
      }

      const existing = new Set(dest.map(x => (x.text||"").trim()));
      let added = 0;

      for(const it of unfinished){
        const tx = (it.text||"").trim();
        if(!tx) continue;
        if(existing.has(tx)) continue;
        dest.unshift({
          id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())),
          text: tx,
          done: false
        });
        existing.add(tx);
        added++;
      }

      if(added === 0){
        showToast("이미 Today에 있어.");
        return;
      }

      writeTodayList(dest);
      showToast(`Today로 ${added}개 보냈어.`);
    });

    function placeNextPopover(anchorEl){
      if(!anchorEl || !cardEl) return;

      const popRect = nextPopover.getBoundingClientRect();
      const btnRect = anchorEl.getBoundingClientRect();
      const cardRect = cardEl.getBoundingClientRect();

      const gap = 8;
      const pad = 10;

      let top = btnRect.bottom + gap;
      let left = btnRect.right - popRect.width;

      const minLeft = cardRect.left + pad;
      const maxLeft = cardRect.right - popRect.width - pad;
      const minTop  = cardRect.top + pad;
      const maxTop  = cardRect.bottom - popRect.height - pad;

      left = Math.max(minLeft, Math.min(left, maxLeft));
      top  = Math.max(minTop,  Math.min(top, maxTop));

      nextPopover.style.left = `${left}px`;
      nextPopover.style.top  = `${top}px`;
    }

    function openNextPopover(anchorEl){
      renderNextPopover();
      nextPopover.classList.add("open");
      nextPopover.setAttribute("aria-hidden", "false");

      requestAnimationFrame(() => {
        placeNextPopover(anchorEl || nextShowBtn);
        requestAnimationFrame(() => placeNextPopover(anchorEl || nextShowBtn));
      });
    }

    function closeNextPopover(){
      nextPopover.classList.remove("open");
      nextPopover.setAttribute("aria-hidden", "true");
    }

    function openMiniAdd(){
      miniOverlay.classList.add("open");
      miniOverlay.setAttribute("aria-hidden","false");
      miniInput.value = "";
      setTimeout(()=> miniInput.focus(), 0);
    }
    function closeMiniAdd(){
      miniOverlay.classList.remove("open");
      miniOverlay.setAttribute("aria-hidden","true");
    }
    function confirmMiniAdd(){
      const text = (miniInput.value || "").trim();
      if(!text){
        closeMiniAdd();
        return;
      }
      addNextInbox(text);
      closeMiniAdd();
    }

    nextAddBtn.addEventListener("click", () => openMiniAdd());
    miniCloseBtn.addEventListener("click", closeMiniAdd);
    miniCancelBtn.addEventListener("click", closeMiniAdd);
    miniOkBtn.addEventListener("click", confirmMiniAdd);
    miniOverlay.addEventListener("click", (e)=>{ if(e.target === miniOverlay) closeMiniAdd(); });
    miniInput.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){ e.preventDefault(); confirmMiniAdd(); }
      if(e.key === "Escape"){ closeMiniAdd(); }
    });

    nextShowBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      if(nextPopover.classList.contains("open")) closeNextPopover();
      else openNextPopover(nextShowBtn);
    });

    nextPopCloseBtn.addEventListener("click", closeNextPopover);

    nextPopList.addEventListener("click", (e) => {
      const check = e.target.closest("[data-nx-id]");
      const del = e.target.closest("[data-nx-del]");
      if(check){
        toggleNextInbox(check.dataset.nxId);
        return;
      }
      if(del){
        deleteNextInbox(del.dataset.nxDel);
        return;
      }
    });

    nextCopyBtn.addEventListener("click", copyNextInbox);
    nextClearDoneBtn.addEventListener("click", clearNextDone);

    nextPopover.addEventListener("click", (e)=> e.stopPropagation());

    document.addEventListener("click", (e) => {
      if(!nextPopover.classList.contains("open")) return;
      const inside = nextPopover.contains(e.target);
      const onBtn = nextShowBtn.contains(e.target);
      if(!inside && !onBtn) closeNextPopover();
    });

    document.addEventListener("keydown", (e) => {
      if(e.key !== "Escape") return;
      if(miniOverlay.classList.contains("open")) return;
      closeNextPopover();
    });

    window.addEventListener("resize", () => {
      if(nextPopover.classList.contains("open")) placeNextPopover(nextShowBtn);
    }, { passive: true });
    window.addEventListener("scroll", () => {
      if(nextPopover.classList.contains("open")) placeNextPopover(nextShowBtn);
    }, { passive: true });

    function formatWeekForCopy(weekId, data){
      const lines = [];
      lines.push(`[This Week | ${weekId}]`);
      for(let i=0;i<7;i++){
        const dateStr = (() => {
          const rng = parseWeekRangeId(weekId);
          if(!rng) return dayDateStr(i);
          return dateToYmd(addDays(rng.start, i));
        })();
        const arr = (data.days && data.days[String(i)]) ? data.days[String(i)] : [];
        lines.push(`\n${DOW_LABEL[i]} (${dateStr})`);
        if(arr.length === 0){
          lines.push(`- (empty)`);
          continue;
        }
        for(const it of arr){
          lines.push(`- [${it.done ? "x" : " "}] ${it.text}`);
        }
      }

      const nx = Array.isArray(data.nextInbox) ? data.nextInbox : [];
      lines.push(`\nNext Week Inbox`);
      if(nx.length === 0) lines.push(`- (empty)`);
      else for(const it of nx) lines.push(`- [${it.done ? "x" : " "}] ${it.text}`);

      return lines.join("\n");
    }

    function formatWeekAsMarkdown(weekId, data){
      const rng = parseWeekRangeId(weekId);
      const title = rng ? `# This Week (${rng.startStr} ~ ${rng.endStr})` : `# This Week (${weekId})`;
      const lines = [title, ""];

      for(let i=0;i<7;i++){
        const dateStr = (() => {
          if(rng) return dateToYmd(addDays(rng.start, i));
          return dayDateStr(i);
        })();
        lines.push(`## ${DOW_LABEL[i]} (${dateStr})`);
        const arr = (data.days && data.days[String(i)]) ? data.days[String(i)] : [];
        if(arr.length === 0){
          lines.push(`- (empty)`);
        } else {
          for(const it of arr){
            lines.push(`- [${it.done ? "x" : " "}] ${it.text}`);
          }
        }
        lines.push("");
      }

      lines.push(`## Next Week Inbox`);
      const nx = Array.isArray(data.nextInbox) ? data.nextInbox : [];
      if(nx.length === 0){
        lines.push(`- (empty)`);
      }else{
        for(const it of nx){
          lines.push(`- [${it.done ? "x" : " "}] ${it.text}`);
        }
      }

      return lines.join("\n");
    }

    copyBtn.addEventListener("click", async () => {
      const text = formatWeekForCopy(getWeekId(), weekState);
      const ok = await copyToClipboard(text);
      showToast(ok ? "주간 전체를 복사했어." : "복사 실패 (권한 확인)");
    });

    clearDoneBtn.addEventListener("click", clearDone);

    function loadCurrentViewWeek(){
      weekArchive = autoArchivePastWeeks();
      weekState = loadWeek(getWeekKey());
      expanded.clear();
      buildWeekdayPills();
      renderWeekList();
    }

    prevWeekBtn.addEventListener("click", () => {
      persistCurrentWeek();
      viewMonday = addDays(viewMonday, -7);
      loadCurrentViewWeek();
      showToast("이전 주로 이동했어.");
    });

    nextWeekBtn.addEventListener("click", () => {
      persistCurrentWeek();
      viewMonday = addDays(viewMonday, 7);
      loadCurrentViewWeek();
      showToast("다음 주로 이동했어.");
    });

    /* ========= History / Archive modal ========= */
    let pickedWeekId = null;
    let searchQuery = "";
    const selectedWeeks = new Set();

    // ✅ 5주(과거2/현재/미래2)만 목록으로 사용
    function getFiveWeekWindowIds(){
      const base = mondayOfWeek(new Date());
      const mons = [
        addDays(base, -14),
        addDays(base, -7),
        addDays(base, 0),
        addDays(base, 7),
        addDays(base, 14),
      ];
      return mons.map(m => weekIdFromMonday(m));
    }

    // ✅ 이 모달은 "현재 로컬 week 데이터"를 직접 읽어 보여줌 (그래서 기본화면 추가가 바로 보임)
    function loadWeekStateById(weekId){
      const key = WEEK_PREFIX + weekId;
      return loadWeek(key);
    }
    function saveWeekStateById(weekId, data){
      const key = WEEK_PREFIX + weekId;
      saveWeek(key, data);
    }

    function openModal(){
      selectedWeeks.clear();
      weekArchive = loadWeekArchiveV2(); // meta(pinned) 용
      searchQuery = (searchInput.value || "").trim();
      buildWeeks();

      modalOverlay.classList.add("open");
      modalOverlay.setAttribute("aria-hidden", "false");

      pickedWeekId = null;
      pickedWeekText.textContent = "주차를 선택해줘";
      restoreWeekBtn.disabled = true;
      copyWeekBtn.disabled = true;
      copyWeekMdBtn.disabled = true;
      downloadWeekMdBtn.disabled = true;

      previewBox.innerHTML = `
        <div style="color: rgba(30,30,30,0.55); font-size:12px;">
          왼쪽에서 주차를 선택하면, 그 주의 기록을 보여줘.
        </div>
      `;
    }

    function closeModal(){
      modalOverlay.classList.remove("open");
      modalOverlay.setAttribute("aria-hidden", "true");
      hideModalToast();
    }

    function weekMatchesQuery(weekId, data, q){
      if(!q) return true;
      const lowerQ = q.toLowerCase();
      if(String(weekId).toLowerCase().includes(lowerQ)) return true;

      const days = (data && data.days) ? data.days : {};
      for(let i=0;i<7;i++){
        const arr = days[String(i)] || [];
        for(const it of arr){
          const tx = String(it.text || "").toLowerCase();
          if(tx.includes(lowerQ)) return true;
        }
      }
      const nx = (data && Array.isArray(data.nextInbox)) ? data.nextInbox : [];
      for(const it of nx){
        const tx = String(it.text || "").toLowerCase();
        if(tx.includes(lowerQ)) return true;
      }
      return false;
    }

    function getCountsForWeek(data){
      let total = 0, done = 0;
      const days = (data && data.days) ? data.days : {};
      for(let i=0;i<7;i++){
        const arr = days[String(i)] || [];
        total += arr.length;
        done += arr.filter(x => x.done).length;
      }
      return { total, done };
    }

    function ensureMetaEntry(weekId){
      if(!weekArchive.weeks[weekId]){
        weekArchive.weeks[weekId] = { state: null, meta: { pinned: false } };
      } else {
        weekArchive.weeks[weekId].meta = weekArchive.weeks[weekId].meta || { pinned: false };
      }
    }
    function isPinned(id){
      const entry = weekArchive.weeks[id];
      return !!(entry && entry.meta && entry.meta.pinned);
    }
    function setPinned(id, pinned){
      ensureMetaEntry(id);
      weekArchive.weeks[id].meta.pinned = !!pinned;
    }

    function toggleSelectWeek(id){
      if(selectedWeeks.has(id)) selectedWeeks.delete(id);
      else selectedWeeks.add(id);
    }

    function svgPin(){
      return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M9 3h6l1 6-2 2v5l-2 2-2-2v-5l-2-2 1-6z" stroke-width="1.6" stroke-linejoin="round"/>
          <path d="M12 21v-5" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
      `;
    }
    function svgDownload(){
      return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 3v10" stroke-width="1.7" stroke-linecap="round"/>
          <path d="M8 10l4 4 4-4" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M5 20h14" stroke-width="1.7" stroke-linecap="round"/>
        </svg>
      `;
    }
    function svgCopy(){
      return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M9 9h10v12H9V9z" stroke-width="1.6" stroke-linejoin="round"/>
          <path d="M5 15H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      `;
    }
    function svgTrash(){
      return `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M7 7h10l-1 14H8L7 7z" stroke-width="1.6" stroke-linejoin="round"/>
          <path d="M9 7V5a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" stroke-width="1.6" stroke-linejoin="round"/>
          <path d="M6 7h12" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
      `;
    }

    function buildWeeks(){
      const q = (searchQuery || "").trim();
      const ids = getFiveWeekWindowIds(); // ✅ 5개 고정

      // 필터는 유지
      const filtered = ids.filter(id => {
        const st = loadWeekStateById(id);
        return weekMatchesQuery(id, st, q);
      });

      weeksPanel.innerHTML = "";

      if(filtered.length === 0){
        weeksPanel.innerHTML = `
          <div style="color: rgba(30,30,30,0.55); font-size:12px; padding:8px;">
            검색 결과가 없어.
          </div>
        `;
      }else{
        for(const id of filtered){
          ensureMetaEntry(id);

          const data = loadWeekStateById(id);
          const { total, done } = getCountsForWeek(data);
          const pinned = isPinned(id);
          const checked = selectedWeeks.has(id);

          const row = document.createElement("div");
          row.className = "weekRow";
          row.dataset.weekRow = id;

          const chk = document.createElement("div");
          chk.className = "wkChk" + (checked ? " on" : "");
          chk.title = "선택";
          chk.dataset.chk = id;
          chk.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M20 7L10 17l-5-5" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          `;

          const col = document.createElement("div");
          col.className = "weekCol";

          const btn = document.createElement("button");
          btn.className = "weekBtn";
          btn.type = "button";
          btn.dataset.week = id;

          const pinTag = pinned ? `<span class="pinTag">• pinned</span>` : ``;
          btn.innerHTML = `${escapeHtml(id)} ${pinTag}<small>${done}/${total}</small>`;

          const actions = document.createElement("div");
          actions.className = "weekActions";

          const pinBtn = document.createElement("button");
          pinBtn.type = "button";
          pinBtn.className = "iconBtn" + (pinned ? " on" : "");
          pinBtn.dataset.pin = id;
          pinBtn.title = pinned ? "Unpin" : "Pin";
          pinBtn.innerHTML = svgPin();

          const expBtn = document.createElement("button");
          expBtn.type = "button";
          expBtn.className = "iconBtn";
          expBtn.dataset.exp = id;
          expBtn.title = "Export (Copy MD)";
          expBtn.innerHTML = svgCopy();

          const dlBtn = document.createElement("button");
          dlBtn.type = "button";
          dlBtn.className = "iconBtn";
          dlBtn.dataset.dl = id;
          dlBtn.title = "Download MD";
          dlBtn.innerHTML = svgDownload();

          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "iconBtn danger";
          delBtn.dataset.wdel = id;
          delBtn.title = "Delete week (local week data)";
          delBtn.innerHTML = svgTrash();

          actions.appendChild(pinBtn);
          actions.appendChild(expBtn);
          actions.appendChild(dlBtn);
          actions.appendChild(delBtn);

          col.appendChild(btn);
          col.appendChild(actions);

          row.appendChild(chk);
          row.appendChild(col);
          weeksPanel.appendChild(row);
        }
      }

      archiveCount.textContent = `${filtered.length} / ${ids.length} weeks`;

      if(pickedWeekId && !filtered.includes(pickedWeekId)){
        pickedWeekId = null;
        pickedWeekText.textContent = "주차를 선택해줘";
        restoreWeekBtn.disabled = true;
        copyWeekBtn.disabled = true;
        copyWeekMdBtn.disabled = true;
        downloadWeekMdBtn.disabled = true;
        previewBox.innerHTML = `
          <div style="color: rgba(30,30,30,0.55); font-size:12px;">
            검색 결과에서 주차를 선택해줘.
          </div>
        `;
      } else if(pickedWeekId){
        setActiveWeekButton(pickedWeekId);
        renderWeekPreview(pickedWeekId);
      }
    }

    function setActiveWeekButton(id){
      const btns = weeksPanel.querySelectorAll(".weekBtn");
      btns.forEach(b => b.classList.toggle("active", b.dataset.week === id));
    }

    /* ========= Modal Undo Toast ========= */
    let _undoPayload = null;
    function hideModalToast(){
      mToast.classList.remove("show");
      mToast.setAttribute("aria-hidden","true");
      _undoPayload = null;
      clearTimeout(hideModalToast._t);
    }
    function showModalToast(message, undoFn){
      _undoPayload = { undoFn };
      mToastMsg.textContent = message || "삭제했어.";
      mToast.classList.add("show");
      mToast.setAttribute("aria-hidden","false");
      clearTimeout(hideModalToast._t);
      hideModalToast._t = setTimeout(hideModalToast, 3000);
    }
    mUndoBtn.addEventListener("click", () => {
      if(_undoPayload && typeof _undoPayload.undoFn === "function"){
        _undoPayload.undoFn();
      }
      hideModalToast();
    });

    /* ✅ 프리뷰: done 토글 + delete(Undo 3s) */
    function togglePreviewDone(weekId, sec, itemId){
      const data = loadWeekStateById(weekId);
      if(sec === "nx"){
        data.nextInbox = (data.nextInbox || []).map(it => it.id === itemId ? ({...it, done: !it.done}) : it);
      }else{
        const day = String(sec);
        const arr = (data.days && data.days[day]) ? data.days[day] : [];
        data.days[day] = arr.map(it => it.id === itemId ? ({...it, done: !it.done}) : it);
      }
      saveWeekStateById(weekId, data);
      buildWeeks();
      renderWeekPreview(weekId);
    }

    function deletePreviewItemWithUndo(weekId, sec, itemId){
      const data = loadWeekStateById(weekId);

      let removed = null;
      let removedIndex = -1;

      if(sec === "nx"){
        const arr = data.nextInbox || [];
        removedIndex = arr.findIndex(it => it.id === itemId);
        if(removedIndex >= 0){
          removed = arr[removedIndex];
          data.nextInbox = arr.filter(it => it.id !== itemId);
        }
      }else{
        const day = String(sec);
        const arr = (data.days && data.days[day]) ? data.days[day] : [];
        removedIndex = arr.findIndex(it => it.id === itemId);
        if(removedIndex >= 0){
          removed = arr[removedIndex];
          data.days[day] = arr.filter(it => it.id !== itemId);
        }
      }

      if(!removed) return;

      saveWeekStateById(weekId, data);
      buildWeeks();
      renderWeekPreview(weekId);

      showModalToast("삭제했어.", () => {
        const cur = loadWeekStateById(weekId);
        if(sec === "nx"){
          const arr = cur.nextInbox || [];
          const idx = Math.min(Math.max(0, removedIndex), arr.length);
          arr.splice(idx, 0, removed);
          cur.nextInbox = arr;
        }else{
          const day = String(sec);
          const arr = (cur.days && cur.days[day]) ? cur.days[day] : (cur.days[day] = []);
          const idx = Math.min(Math.max(0, removedIndex), arr.length);
          arr.splice(idx, 0, removed);
          cur.days[day] = arr;
        }
        saveWeekStateById(weekId, cur);
        buildWeeks();
        renderWeekPreview(weekId);
      });
    }

    function renderWeekPreview(id){
      const data = loadWeekStateById(id);

      pickedWeekId = id;
      setActiveWeekButton(id);

      pickedWeekText.textContent = `선택: ${id}`;
      restoreWeekBtn.disabled = false;
      copyWeekBtn.disabled = false;
      copyWeekMdBtn.disabled = false;
      downloadWeekMdBtn.disabled = false;

      const q = (searchQuery || "").trim();
      const days = data.days || {};
      const rows = [];

      const togBtnHtml = (weekId, sec, itemId, on) => `
        <button class="pTog ${on ? "on" : ""}" type="button" title="done 토글"
          data-ptog-week="${escapeHtml(weekId)}" data-ptog-sec="${escapeHtml(sec)}" data-ptog-id="${escapeHtml(itemId)}">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M20 7L10 17l-5-5" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      `;

      const trashBtnHtml = (weekId, sec, itemId) => `
        <button class="pDel" type="button" title="삭제"
          data-pdel-week="${escapeHtml(weekId)}" data-pdel-sec="${escapeHtml(sec)}" data-pdel-id="${escapeHtml(itemId)}">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M7 7h10l-1 14H8L7 7z" stroke-width="1.6" stroke-linejoin="round"/>
            <path d="M9 7V5a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2" stroke-width="1.6" stroke-linejoin="round"/>
            <path d="M6 7h12" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </button>
      `;

      for(let i=0;i<7;i++){
        const arr = days[String(i)] || [];
        const dateStr = (() => {
          const startStr = id.split("~")[0].trim();
          const start = ymdToDate(startStr);
          if(!start) return "";
          return dateToYmd(addDays(start, i));
        })();

        rows.push(`<div style="margin-top:6px; color:rgba(30,30,30,0.72); font-size:12.5px; font-family:EnterSanChaek, ui-sans-serif, system-ui;">${DOW_LABEL[i]} <span style="color:rgba(30,30,30,0.42); font-variant-numeric:tabular-nums;">${escapeHtml(dateStr)}</span></div>`);

        if(arr.length === 0){
          rows.push(`<div style="color: rgba(30,30,30,0.45); font-size:12px;">(empty)</div>`);
          continue;
        }

        const view = q ? arr.filter(it => String(it.text||"").toLowerCase().includes(q.toLowerCase()) || id.toLowerCase().includes(q.toLowerCase())) : arr;

        for(const it of view){
          const badgeCls = it.done ? "badge done" : "badge";
          const badgeText = it.done ? "done" : "todo";
          const textHtml = highlight(it.text || "", q);
          rows.push(`
            <div class="pItem">
              <span class="${badgeCls}">${badgeText}</span>
              <span class="pText" style="${it.done ? "text-decoration:line-through; color:rgba(30,30,30,0.55);" : ""}">
                ${textHtml}
              </span>
              ${togBtnHtml(id, String(i), it.id, it.done)}
              ${trashBtnHtml(id, String(i), it.id)}
            </div>
          `);
        }
      }

      const nx = Array.isArray(data.nextInbox) ? data.nextInbox : [];
      rows.push(`<div style="margin-top:10px; color:rgba(30,30,30,0.72); font-size:12.5px; font-family:EnterSanChaek, ui-sans-serif, system-ui;">Next Week Inbox</div>`);
      if(nx.length === 0){
        rows.push(`<div style="color: rgba(30,30,30,0.45); font-size:12px;">(empty)</div>`);
      }else{
        const viewNx = q ? nx.filter(it => String(it.text||"").toLowerCase().includes(q.toLowerCase())) : nx;
        for(const it of viewNx){
          const badgeCls = it.done ? "badge done" : "badge";
          const badgeText = it.done ? "done" : "todo";
          const textHtml = highlight(it.text || "", q);
          rows.push(`
            <div class="pItem">
              <span class="${badgeCls}">${badgeText}</span>
              <span class="pText" style="${it.done ? "text-decoration:line-through; color:rgba(30,30,30,0.55);" : ""}">
                ${textHtml}
              </span>
              ${togBtnHtml(id, "nx", it.id, it.done)}
              ${trashBtnHtml(id, "nx", it.id)}
            </div>
          `);
        }
      }

      previewBox.innerHTML = rows.join("");
    }

    historyBtn.addEventListener("click", openModal);
    closeModalBtn.addEventListener("click", closeModal);
    modalOverlay.addEventListener("click", (e) => {
      if(e.target === modalOverlay) closeModal();
    });

    weeksPanel.addEventListener("click", async (e) => {
      const chk = e.target.closest("[data-chk]");
      if(chk){
        const id = chk.dataset.chk;
        toggleSelectWeek(id);
        buildWeeks();
        return;
      }

      const pin = e.target.closest("[data-pin]");
      if(pin){
        const id = pin.dataset.pin;
        setPinned(id, !isPinned(id));
        saveWeekArchiveV2(weekArchive);
        buildWeeks();
        showToast(isPinned(id) ? "Pinned." : "Unpinned.");
        return;
      }

      const exp = e.target.closest("[data-exp]");
      if(exp){
        const id = exp.dataset.exp;
        const data = loadWeekStateById(id);
        const md = formatWeekAsMarkdown(id, data);
        const ok = await copyToClipboard(md);
        showToast(ok ? "Export(복사) 완료." : "복사 실패 (권한 확인)");
        return;
      }

      const dl = e.target.closest("[data-dl]");
      if(dl){
        const id = dl.dataset.dl;
        const data = loadWeekStateById(id);
        const md = formatWeekAsMarkdown(id, data);
        const safe = id.replace(/[^\d.\s~]/g,"").replace(/\s+/g," ").trim().replace(/ /g,"_");
        downloadText(`ThisWeek_${safe}.md`, md);
        showToast("다운로드를 시작했어.");
        return;
      }

      const wdel = e.target.closest("[data-wdel]");
      if(wdel){
        const id = wdel.dataset.wdel;
        const ok = confirm(`이 주차(로컬 데이터)를 삭제할까? (되돌리기 불가)\n\n${id}`);
        if(!ok) return;

        localStorage.removeItem(WEEK_PREFIX + id);
        selectedWeeks.delete(id);
        if(pickedWeekId === id) pickedWeekId = null;

        buildWeeks();

        if(!pickedWeekId){
          pickedWeekText.textContent = "주차를 선택해줘";
          restoreWeekBtn.disabled = true;
          copyWeekBtn.disabled = true;
          copyWeekMdBtn.disabled = true;
          downloadWeekMdBtn.disabled = true;
          previewBox.innerHTML = `
            <div style="color: rgba(30,30,30,0.55); font-size:12px;">
              왼쪽에서 주차를 선택하면, 그 주의 기록을 보여줘.
            </div>
          `;
        }
        showToast("삭제 완료.");
        return;
      }

      const btn = e.target.closest(".weekBtn");
      if(!btn) return;
      renderWeekPreview(btn.dataset.week);
    });

    // ✅ preview interactions: done toggle + delete(with undo)
    previewBox.addEventListener("click", (e) => {
      const tog = e.target.closest("[data-ptog-week]");
      if(tog){
        togglePreviewDone(tog.dataset.ptogWeek, tog.dataset.ptogSec, tog.dataset.ptogId);
        return;
      }

      const del = e.target.closest("[data-pdel-week]");
      if(del){
        deletePreviewItemWithUndo(del.dataset.pdelWeek, del.dataset.pdelSec, del.dataset.pdelId);
        return;
      }
    });

    restoreWeekBtn.addEventListener("click", () => {
      if(!pickedWeekId) return;
      const data = loadWeekStateById(pickedWeekId);

      weekState = normalizeWeekState(JSON.parse(JSON.stringify(data)));
      persistCurrentWeek();
      renderWeekList();
      showToast("선택한 주 기록으로 복원했어.");
    });

    copyWeekBtn.addEventListener("click", async () => {
      if(!pickedWeekId) return;
      const data = loadWeekStateById(pickedWeekId);
      const text = formatWeekForCopy(pickedWeekId, data);
      const ok = await copyToClipboard(text);
      showToast(ok ? "선택 주차를 복사했어." : "복사 실패 (권한 확인)");
    });

    copyWeekMdBtn.addEventListener("click", async () => {
      if(!pickedWeekId) return;
      const data = loadWeekStateById(pickedWeekId);
      const md = formatWeekAsMarkdown(pickedWeekId, data);
      const ok = await copyToClipboard(md);
      showToast(ok ? "Markdown 복사 완료." : "복사 실패 (권한 확인)");
    });

    downloadWeekMdBtn.addEventListener("click", () => {
      if(!pickedWeekId) return;
      const data = loadWeekStateById(pickedWeekId);
      const md = formatWeekAsMarkdown(pickedWeekId, data);
      const safe = pickedWeekId.replace(/[^\d.\s~]/g,"").replace(/\s+/g," ").trim().replace(/ /g,"_");
      downloadText(`ThisWeek_${safe}.md`, md);
      showToast("다운로드를 시작했어.");
    });

    searchInput.addEventListener("input", () => {
      searchQuery = (searchInput.value || "").trim();
      buildWeeks();
      if(pickedWeekId) renderWeekPreview(pickedWeekId);
    });

    function getSelectedIds(){
      return Array.from(selectedWeeks);
    }

    bulkPinBtn.addEventListener("click", () => {
      const ids = getSelectedIds();
      if(ids.length === 0){ showToast("선택된 주차가 없어."); return; }
      for(const id of ids) setPinned(id, true);
      saveWeekArchiveV2(weekArchive);
      buildWeeks();
      showToast(`${ids.length}개 pin.`);
    });

    bulkUnpinBtn.addEventListener("click", () => {
      const ids = getSelectedIds();
      if(ids.length === 0){ showToast("선택된 주차가 없어."); return; }
      for(const id of ids) setPinned(id, false);
      saveWeekArchiveV2(weekArchive);
      buildWeeks();
      showToast(`${ids.length}개 unpin.`);
    });

    bulkCopyMdBtn.addEventListener("click", async () => {
      const ids = getSelectedIds();
      if(ids.length === 0){ showToast("선택된 주차가 없어."); return; }

      const mdParts = [];
      for(const id of ids){
        const data = loadWeekStateById(id);
        mdParts.push(formatWeekAsMarkdown(id, data));
      }
      const md = mdParts.join("\n\n---\n\n");
      const ok = await copyToClipboard(md);
      showToast(ok ? "Export(복사) 완료." : "복사 실패 (권한 확인)");
    });

    bulkDeleteBtn.addEventListener("click", () => {
      const ids = getSelectedIds();
      if(ids.length === 0){ showToast("선택된 주차가 없어."); return; }
      const ok = confirm(`선택한 ${ids.length}개 주차(로컬 데이터)를 삭제할까? (되돌리기 불가)`);
      if(!ok) return;

      for(const id of ids){
        localStorage.removeItem(WEEK_PREFIX + id);
        selectedWeeks.delete(id);
        if(pickedWeekId === id) pickedWeekId = null;
      }

      buildWeeks();

      if(!pickedWeekId){
        pickedWeekText.textContent = "주차를 선택해줘";
        restoreWeekBtn.disabled = true;
        copyWeekBtn.disabled = true;
        copyWeekMdBtn.disabled = true;
        downloadWeekMdBtn.disabled = true;
        previewBox.innerHTML = `
          <div style="color: rgba(30,30,30,0.55); font-size:12px;">
            왼쪽에서 주차를 선택하면, 그 주의 기록을 보여줘.
          </div>
        `;
      }

      showToast("삭제 완료.");
    });

    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape"){
        if(modalOverlay.classList.contains("open")) closeModal();
      }
    });
  </script>
</body>
</html>
