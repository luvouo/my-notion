<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Today — Soft Schedule</title>

  <style>
    :root{
      /* Pastel Pink */
      --accent-1: rgba(255, 192, 203, 0.88);
      --accent-2: rgba(255, 170, 190, 0.55);
      --border: rgba(255, 170, 190, 0.62);

      --text: rgba(30,30,30,0.92);
      --muted: rgba(30,30,30,0.38);  /* 기존 0.55 → 더 연하게 */

      --glass: rgba(255,255,255,0.10);
      --glass-2: rgba(255,255,255,0.06);

      --shadow: 0 10px 30px rgba(0,0,0,0.06);
      --radius: 20px;

      /* ===== Design tokens (shared) ===== */
      --font-display: "EnterSanChaek", ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;

      --radius-card: 20px;
      --radius-control: 14px;
      --radius-pill: 999px;

      --gap-1: 8px;
      --gap-2: 10px;
      --gap-3: 12px;

      --stroke-strong: rgba(255,170,190,0.70);
      --stroke-soft: rgba(255,170,190,0.45);

      --bg-control: rgba(255,255,255,0.10);
      --bg-soft: rgba(255,255,255,0.06);

      /* Interaction ring (hover/focus “중간 강도”) */
      --ring: 0 0 0 3px rgba(255,192,203,0.22);
      --ring-strong: 0 0 0 3px rgba(255,192,203,0.28);

      /* Control height scale */
      --h-control: 44px; /* input 기준 높이(시각 기준) */
    }

    @font-face{
      font-family: "EnterSanChaek";
      src: url("../fonts/엔터산책10.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    html, body{
      margin:0;
      padding:0;
      background: transparent;
      font-family: ui-sans-serif, system-ui, -apple-system,
        "Apple SD Gothic Neo","Noto Sans KR",sans-serif;
      color: var(--text);
    }

    .wrap{
      width: min(620px, 100%);
      margin: 0 auto;
      padding: clamp(10px, 2.6vw, 16px);
      box-sizing: border-box;
    }

    .card{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: clamp(14px, 2.8vw, 18px);
      background: var(--glass);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden; /* 유지 */
    }

    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(120% 80% at 0% 0%, rgba(255,192,203,0.25), transparent 55%),
        radial-gradient(80% 80% at 100% 20%, rgba(255,170,190,0.18), transparent 55%);
      pointer-events:none;
    }

    .inner{
      position: relative;
      z-index: 1;
      display: grid;
      gap: 12px;
    }

    .top{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .title{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }

    .pearl{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display: block;
      object-fit: cover;
      flex: 0 0 auto;
      box-shadow: 0 0 0 2px rgba(255,192,203,0.22);
    }

    .title h1{
      margin:0;
      font-family: var(--font-display);
      font-size: clamp(15px, 3.8vw, 18px);
      letter-spacing: -0.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .meta{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      margin-left: auto;
    }

    .inputRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center; /* ✅ 입력창/버튼 세로 중앙 정렬 */
    }

    .input{
      flex: 1 1 220px;
      min-width: 0;
      border: 1px solid rgba(255,170,190,0.45);
      background: rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 12px 12px;
      outline: none;
      color: var(--text);
      font-size: 14px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      min-height: var(--h-control); /* ✅ 기준 높이 */
      box-sizing: border-box;
    }
    .input::placeholder{ color: rgba(30,30,30,0.45); }

    .btn{
      flex: 0 0 auto;
      border: 1px solid rgba(255,170,190,0.70);
      background: rgba(255,192,203,0.22);
      border-radius: 14px;
      padding: 12px 14px;
      font-size: 13px;
      color: rgba(30,30,30,0.85);
      cursor: pointer;
      transition: transform .08s ease, background .2s ease, border-color .2s ease, box-shadow .18s ease;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      white-space: nowrap;
    }
    .btn:active{ transform: scale(0.98); }
    .btn:hover{ background: rgba(255,192,203,0.30); border-color: rgba(255,170,190,0.90); }

    .btn.secondary{
      border: 1px solid rgba(255,170,190,0.45);
      background: rgba(255,255,255,0.08);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
    }
    .btn.secondary:disabled{
      opacity: 0.55;
      cursor: not-allowed;
    }

    /* ✅ ghost variant (Upcoming/Focus 등에서 재사용) */
    .btn.ghost{
      border: 1px solid rgba(0,0,0,0.06);
      background: transparent;
      color: rgba(30,30,30,0.62);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      transition: background .18s ease, border-color .18s ease, box-shadow .18s ease, transform .08s ease, color .18s ease;
    }
    .btn.ghost:hover{
      border-color: rgba(255,170,190,0.55);
      box-shadow: var(--ring);
    }
    .btn.ghost:active{ transform: scale(0.98); }
    .btn.ghost:focus-visible{
      outline: none;
      box-shadow: var(--ring-strong);
    }

    .list{
      margin:0;
      padding:0;
      list-style:none;
      display:grid;
      gap: 8px;
    }

    .item{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 8px 10px;
      min-height: var(--h-control); /* ✅ 기준 높이 */
      border-radius: 14px;
      border: 1px solid rgba(255,170,190,0.30);
      background: var(--glass-2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      min-width: 0;
      box-sizing: border-box;
    }

    .check{
      width: 18px;
      height: 18px;
      margin-top: 1px; /* ✅ 시각적 중심 맞춤 */
      border-radius: 6px;
      border: 1.6px solid rgba(255,170,190,0.95);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      transition: background .18s ease, border-color .18s ease, box-shadow .18s ease, transform .08s ease;
    }

    .check:hover{
      background: rgba(255,192,203,0.14);
      border-color: rgba(255,170,190,1);
      box-shadow: var(--ring);
    }

    .check:active{
      transform: scale(0.98);
    }

    .check:focus-visible{
      outline: none;
      background: rgba(255,192,203,0.12);
      border-color: rgba(255,170,190,1);
      box-shadow: var(--ring-strong);
    }

    .check svg{
      width: 12px;
      height: 12px;
      opacity: 0;
      transform: scale(0.9);
      transition: opacity .18s ease, transform .18s ease;
    }

    .text{
      flex: 1 1 auto;
      min-width: 0;
      line-height: 1.45;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .del{
      flex: 0 0 auto;
      border: none;
      background: transparent;
      color: rgba(30,30,30,0.55);
      cursor:pointer;
      font-size: 14px;
      padding: 6px 8px;
      border-radius: 10px;
      transition: background .18s ease, color .18s ease, box-shadow .18s ease, transform .08s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .del:hover{
      background: rgba(255,192,203,0.14);
      color: rgba(30,30,30,0.78);
      box-shadow: var(--ring);
    }
    .del:active{ transform: scale(0.96); }
    .del:focus-visible{
      outline: none;
      background: rgba(255,192,203,0.12);
      color: rgba(30,30,30,0.78);
      box-shadow: var(--ring-strong);
    }

    .item.done{ opacity: 0.78; }
    .item.done .text{ text-decoration: line-through; color: rgba(30,30,30,0.50); }
    .item.done .check{
      background: rgba(255,192,203,0.25);
      border-color: rgba(255,170,190,1);
    }
    .item.done .check svg{ opacity: 1; transform: scale(1); }

    .footer{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--muted);
    }

    /* ✅ bottom buttons: right aligned + horizontal scroll on narrow screens */
    .footer-actions{
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      width: 100%;

      flex-wrap: nowrap;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;

      margin-left: auto;
      padding-left: 8px;
      padding-right: 2px;

      scrollbar-width: none;
    }
    .footer-actions::-webkit-scrollbar{ display: none; }
    .footer-actions > .btn{ flex: 0 0 auto; }

    /* ✅ hide non-essential buttons (kept in DOM but removed from layout) */
    #clearDoneBtn,
    #resetBtn{
      display: none !important;
      width: 0 !important;
      height: 0 !important;
      padding: 0 !important;
      margin: 0 !important;
      border: 0 !important;
    }

    /* ✅ bottom action buttons font + unified ring */
    #carryYesterdayBtn,
    #historyBtn,
    #copyTodayBtn{
      font-family: var(--font-display);
      transition: color .18s ease, border-color .18s ease, box-shadow .18s ease, background .18s ease, transform .08s ease;
    }

    #carryYesterdayBtn:hover,
    #historyBtn:hover,
    #copyTodayBtn:hover{
      color: var(--accent-1);
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,170,190,0.70);
      box-shadow: var(--ring);
    }

    #carryYesterdayBtn:focus-visible,
    #historyBtn:focus-visible,
    #copyTodayBtn:focus-visible{
      outline: none;
      color: var(--accent-1);
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,170,190,0.78);
      box-shadow: var(--ring-strong);
    }

    /* 선택 날짜 액션 버튼을 더 작고 정돈된 pill로 */
    #carryPickedBtn,
    #copyPickedBtn{
      padding: 9px 10px;
      border-radius: 999px;
      font-size: 12px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      letter-spacing: -0.1px;
      font-family: var(--font-display);
    }

    /* ===== Add button (RGBA only, unified ring) ===== */
    #addBtn{
      height: clamp(28px, 3.2vw, 32px);
      min-width: clamp(28px, 3.2vw, 32px);
      padding: 0;

      display: inline-flex;
      align-items: center;
      justify-content: center;

      color: rgba(255,170,190,0.55);              /* 거의 흰 핑크 느낌 */
      background: rgba(255,255,255,0.75);         /* 거의 흰 배경 */
      border: 1px solid rgba(255,170,190,0.35);
      border-radius: 999px;

      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      cursor: pointer;

      transition: box-shadow .2s ease, border-color .2s ease, background .2s ease, transform .15s ease, color .18s ease;
    }

    #addBtn:hover{
      background: transparent;
      border-color: rgba(255,170,190,0.55);
      box-shadow: var(--ring);
    }

    #addBtn:focus-visible{
      outline: none;
      background: transparent;
      border-color: rgba(255,170,190,0.78);
      box-shadow: var(--ring-strong);
    }

    #addBtn:active{
      transform: scale(0.96);
    }

    #addBtn:disabled{
      opacity: 0.45;
      cursor: not-allowed;
      background: transparent;
      border-color: rgba(255,170,190,0.18);
      box-shadow: none;
      transform: none;
    }
    #addBtn:disabled:hover{
      background: transparent;
      box-shadow: none;
    }

    /* -------- Modal -------- */
    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.18);

      display: none;
      align-items: center;
      justify-content: center;

      padding: 10px;
      z-index: 5000;

      overflow: hidden;
    }
    .modalOverlay.open{ display:flex; }

    .modal{
      width: min(820px, 100%);
      max-height: calc(100vh - 20px);
      display: flex;
      flex-direction: column;
      border-radius: 18px;
      border: 1px solid rgba(255,170,190,0.38);
      background: rgba(255,255,255,0.82);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 18px 50px rgba(0,0,0,0.18);
      overflow: hidden;
    }

    .modalHeader{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 14px 14px;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      flex-wrap: wrap;
    }

    .mhLeft{
      display:flex;
      gap: 10px;
      align-items:center;
      min-width: 0;
    }
    .mhLeft strong{
      font-size: 14px;
      letter-spacing: -0.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: var(--font-display);
    }

    .mhRight{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
      justify-content: flex-end;
      flex: 1 1 auto;
      min-width: 0;
    }

    .search{
      border: 1px solid rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.70);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 12.5px;
      outline: none;
      min-width: min(340px, 100%);
      flex: 1 1 260px;
      min-width: 0;
      width: 100%;
      box-sizing: border-box;
    }
    .search::placeholder{ color: rgba(30,30,30,0.45); }

    .modalBody{
      display: grid;
      grid-template-columns: max-content 1fr;
      min-height: 0;
      flex: 1 1 auto;
      overflow: hidden;
    }

    .dates{
      border-right: 1px solid rgba(0,0,0,0.06);
      padding: 12px 10px;
      overflow: auto;

      width: max-content;
      max-width: none;
      min-width: unset;
      min-height: 0;

      justify-items: start;
    }

    .dateBtn{
      width: fit-content;
      max-width: 100%;
      display: grid;
      gap: 4px;

      padding: 8px 10px;
      margin-bottom: 10px;

      border-radius: 14px;
      border: 1px solid rgba(255,170,190,0.22);
      background: rgba(255,255,255,0.62);

      cursor: pointer;
      text-align: left;
      white-space: nowrap;

      font-size: 13px;
      color: rgba(30,30,30,0.88);

      transition: background .18s ease, border-color .18s ease, transform .08s ease, box-shadow .18s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .dateBtn:hover{
      border-color: rgba(255,170,190,0.45);
      background: rgba(255,255,255,0.72);
      box-shadow: var(--ring);
    }
    .dateBtn:active{ transform: scale(0.99); }

    .dateBtn:focus-visible{
      outline: none;
      box-shadow: var(--ring-strong);
      border-color: rgba(255,170,190,0.70);
    }

    .dateBtn small{
      display: block;
      font-size: 11px;
      color: rgba(30,30,30,0.52);
      margin-top: 0;
    }

    .dateBtn.active{
      border-color: rgba(255,170,190,0.70);
      background: rgba(255,192,203,0.14);
      box-shadow: 0 10px 26px rgba(255,170,190,0.12);
    }

    .preview{
      padding: 12px;
      overflow: auto;
      min-height: 0;
      display: grid;
      gap: 10px;
    }

    .previewTop{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: nowrap;
      min-width: 0;
    }

    .picked{
      font-size: 13px;
      color: rgba(30,30,30,0.82);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
      flex: 1 1 auto;
    }

    .previewTop > div:last-child{
      display:flex;
      gap: 8px;
      flex-wrap: nowrap;
      justify-content: flex-end;
      flex: 0 0 auto;
    }

    .previewBox{
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,255,255,0.66);
      display: grid;
      gap: 10px;
    }

    .pItem{
      display:flex;
      gap: 10px;
      align-items:center;
      font-size: 13px;
      color: rgba(30,30,30,0.86);
      line-height: 1.25;
    }

    .badge{
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.06);
      background: rgba(0,0,0,0.03);
      color: rgba(30,30,30,0.58);
      flex: 0 0 auto;
    }
    .badge.done{
      border-color: rgba(255,170,190,0.40);
      background: rgba(255,192,203,0.18);
      color: rgba(30,30,30,0.62);
    }

    .mark{
      background: rgba(255,192,203,0.35);
      border-radius: 6px;
      padding: 0 3px;
    }

    .modalFooter{
      padding: 12px 14px;
      border-top: 1px solid rgba(0,0,0,0.06);
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      font-size: 12px;
      color: rgba(30,30,30,0.55);
    }

    @media (max-width: 420px){
      .modalBody{ grid-template-columns: 1fr; }
      .dates{ border-right: none; border-bottom: 1px solid rgba(0,0,0,0.06); }
      .search{ min-width: 100%; }
    }

    @media (max-width: 360px){
      .meta{ display:none; }
      .btn{ width: 100%; }
      .input{ flex-basis: 100%; }
    }

    /* ✅ Copy Popover (fixed, no overflow clipping) */
    .popover{
      position: fixed;
      left: 0;
      top: 0;
      min-width: 150px;
      padding: 6px;
      border-radius: 14px;
      border: 1px solid rgba(255,170,190,0.38);
      background: rgba(255,255,255,0.86);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 16px 40px rgba(0,0,0,0.12);
      z-index: 9999;

      opacity: 0;
      pointer-events: none;
      transform: translateY(6px);
      transition: opacity .14s ease, transform .14s ease;
    }
    .popover.open{
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .popItem{
      width: 100%;
      text-align: left;
      border: 1px solid rgba(0,0,0,0.06);
      background: rgba(255,255,255,0.70);
      border-radius: 12px;
      padding: 10px 10px;
      font-size: 12.5px;
      color: rgba(30,30,30,0.82);
      cursor: pointer;
      font-family: var(--font-display);
      transition: background .18s ease, border-color .18s ease, box-shadow .18s ease;
    }
    .popItem:hover{
      border-color: rgba(255,170,190,0.55);
      background: rgba(255,192,203,0.14);
      box-shadow: var(--ring);
    }
    .popItem:focus-visible{
      outline: none;
      box-shadow: var(--ring-strong);
      border-color: rgba(255,170,190,0.60);
    }

    /* Fix: Notion embed flex/min-width clipping */
    .modalHeader, .mhRight, .mhLeft{ min-width: 0; }
    .modalHeader{ box-sizing: border-box; }
    .mhRight{ flex: 1 1 360px; min-width: 0; }

    @media (pointer: coarse){
      #addBtn{ position: relative; }
      #addBtn::after{
        content:"";
        position:absolute;
        inset:-6px; /* 터치 히트박스만 확대 */
      }
    }

    /* ===== Toast overlay (B) ===== */
    .card{ position: relative; }

    .toast{
      position: absolute;
      left: 16px;
      bottom: 12px;
      z-index: 10;

      display: inline-flex;
      align-items: center;
      gap: 8px;

      padding: 0;
      background: transparent;
      border: none;
      box-shadow: none;

      color: rgba(30,30,30,0.62);
      font-size: 12px;
      line-height: 1;

      opacity: 0;
      transform: translateY(4px);
      pointer-events: none;

      transition: opacity .14s ease, transform .14s ease;
    }

    .toast:not(:empty){
      opacity: 1;
      transform: translateY(0);
    }

    .toast::before{
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,192,203,0.88);
      box-shadow: 0 0 0 3px rgba(255,192,203,0.16);
      flex: 0 0 auto;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card" role="application" aria-label="Today Widget">
      <div class="inner">
        <div class="top">
          <div class="title">
            <img class="pearl" src="./icon/pearl.png" alt="" aria-hidden="true" />
            <h1>Today</h1>
          </div>
          <div class="meta" id="metaText"></div>
        </div>

        <div class="inputRow">
          <input id="todoInput" class="input" type="text" placeholder="오늘 할 일 (Enter)…" maxlength="80" />
          <button class="btn" id="addBtn" type="button" title="할 일 추가" aria-label="할 일 추가"></button>
        </div>

        <ul class="list" id="list"></ul>

        <div class="footer">
          <span id="countText">0/0 done</span>

          <div class="footer-actions">
            <button class="btn secondary" id="carryYesterdayBtn" type="button">Carry over</button>
            <button class="btn secondary" id="historyBtn" type="button">History / Archive</button>
            <button class="btn secondary" id="copyTodayBtn" type="button">Copy</button>

            <!-- kept but hidden -->
            <button class="btn secondary" id="clearDoneBtn" type="button">완료 삭제</button>
            <button class="btn secondary" id="resetBtn" type="button">전체 초기화</button>
          </div>
        </div>

        <div class="toast" id="toast"></div>
      </div>
    </div>
  </div>

  <!-- ✅ Copy Popover (placed at body level; fixed positioning) -->
  <div class="popover" id="copyPopover" aria-hidden="true">
    <button class="popItem" type="button" data-copy="all">All</button>
    <button class="popItem" type="button" data-copy="todo">Todo</button>
    <button class="popItem" type="button" data-copy="done">Done</button>
  </div>

  <!-- History / Archive Modal -->
  <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="History / Archive">
      <div class="modalHeader">
        <div class="mhLeft">
          <img class="pearl" src="./icon/pearl.png" alt="" aria-hidden="true" />
          <strong>History / Archive</strong>
        </div>

        <div class="mhRight">
          <input id="searchInput" class="search" type="text" placeholder="검색: 날짜(YYYY.MM.DD) 또는 할 일 키워드…" />
          <button class="btn secondary" id="clearSearchBtn" type="button">검색 초기화</button>
          <button class="btn secondary" id="closeModalBtn" type="button">닫기</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="dates" id="datesPanel"></div>

        <div class="preview">
          <div class="previewTop">
            <div class="picked" id="pickedDateText">날짜를 선택해줘</div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn secondary" id="carryPickedBtn" type="button" disabled>Carry</button>
              <button class="btn secondary" id="copyPickedBtn" type="button" disabled>Copy</button>
            </div>
          </div>

          <div class="previewBox" id="previewBox">
            <div style="color: rgba(30,30,30,0.55); font-size:12px;">
              왼쪽에서 날짜를 선택하면, 그날의 Today 기록을 보여줘.
            </div>
          </div>
        </div>
      </div>

      <div class="modalFooter">
        <span id="archiveMeta">자동 아카이브: ON (기간 제한 없음)</span>
        <span id="archiveCount">0 days archived</span>
      </div>
    </div>
  </div>

  <script src="../env.js"></script>
<script type="module">
  import { getWorkspaceId, savePasscode } from "../core/auth-lite.js";
  import { sbFetch } from "../core/supabase-rest.js";

  // =====================
  // 0) Passcode → workspace_id 게이트
  // =====================
  async function requireWorkspaceId() {
    let ws = await getWorkspaceId();
    if (ws) return ws;

    const wrap = document.querySelector(".wrap");
    if (!wrap) throw new Error("Cannot find .wrap");

    wrap.innerHTML = `
      <div class="card" role="application" aria-label="Passcode Gate">
        <div class="inner" style="gap: 10px;">
          <div class="top">
            <div class="title">
              <img class="pearl" src="./icon/pearl.png" alt="" aria-hidden="true" />
              <h1>Passcode</h1>
            </div>
            <div class="meta">sync</div>
          </div>

          <div class="inputRow">
            <input id="passInput" class="input" type="password" placeholder="패스코드 입력…" />
            <button class="btn" id="passBtn" type="button" style="min-width:90px;">확인</button>
          </div>

          <div style="font-size:12px; color: var(--muted); line-height:1.4;">
            같은 패스코드를 쓰는 모든 위젯/기기가 같은 데이터를 보게 돼.
          </div>
        </div>
      </div>
    `;

    const passInput = document.getElementById("passInput");
    const passBtn = document.getElementById("passBtn");

    const submit = async () => {
      const pass = (passInput.value || "").trim();
      if (!pass) return;
      savePasscode(pass);
      location.reload();
    };

    passBtn.addEventListener("click", submit);
    passInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") submit();
    });

    return null;
  }

  const workspace_id = await requireWorkspaceId();
  if (!workspace_id) throw new Error("passcode required");

  // =====================
  // 1) 기존 로컬 함수는 남겨두되 "서버 모드"에서 호출 안 하게 처리
  // =====================
  const USE_SUPABASE = true; // ✅ 오늘부터 서버 연결 ON

  const PREFIX_DAY = `soft_schedule_today_${workspace_id}_`;
  const KEY_ARCHIVE = `soft_schedule_today_${workspace_id}_archive_v1`;

  function pad2(n){ return String(n).padStart(2,"0"); }
  function ymd(d=new Date()){
    return `${d.getFullYear()}.${pad2(d.getMonth()+1)}.${pad2(d.getDate())}`;
  }
  function parseYmd(str){
    const m = /^(\d{4})\.(\d{2})\.(\d{2})$/.exec(str);
    if(!m) return null;
    return { y:+m[1], m:+m[2], d:+m[3] };
  }
  function ymdToDate(str){
    const p = parseYmd(str);
    if(!p) return null;
    return new Date(p.y, p.m-1, p.d);
  }
  function formatDateLabel(dateStr){
    const d = ymdToDate(dateStr);
    if(!d) return dateStr;
    const yy = String(d.getFullYear()).slice(-2);
    const mm = pad2(d.getMonth() + 1);
    const dd = pad2(d.getDate());
    const wk = ["일","월","화","수","목","금","토"][d.getDay()];
    return `${yy}.${mm}.${dd} (${wk})`;
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (m) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#039;"
    }[m]));
  }

  function showToast(msg){
    toast.textContent = msg;
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toast.textContent = "", 1600);
  }

  async function copyToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch(e){
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      try{
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        return ok;
      }catch(err){
        document.body.removeChild(ta);
        return false;
      }
    }
  }

  function formatForCopy(dateStr, items){
    const lines = [];
    lines.push(`[Today | ${dateStr}]`);
    for(const it of items){
      lines.push(`- [${it.done ? "x" : " "}] ${it.text}`);
    }
    return lines.join("\n");
  }

  function highlight(text, query){
    const t = String(text);
    const q = String(query || "").trim();
    if(!q) return escapeHtml(t);
    const idx = t.toLowerCase().indexOf(q.toLowerCase());
    if(idx === -1) return escapeHtml(t);
    const before = escapeHtml(t.slice(0, idx));
    const mid = escapeHtml(t.slice(idx, idx + q.length));
    const after = escapeHtml(t.slice(idx + q.length));
    return `${before}<span class="mark">${mid}</span>${after}`;
  }

  // ===== 로컬 아카이브 함수는 "남겨두되" 서버 모드에서는 완전 무시 =====
  function loadArchive(){
    if (USE_SUPABASE) return {};
    try{
      const raw = localStorage.getItem(KEY_ARCHIVE);
      if(!raw) return {};
      const parsed = JSON.parse(raw);
      return (parsed && typeof parsed === "object") ? parsed : {};
    }catch(e){ return {}; }
  }
  function saveArchive(archive){
    if (USE_SUPABASE) return;
    localStorage.setItem(KEY_ARCHIVE, JSON.stringify(archive));
  }
  function loadDay(key){
    if (USE_SUPABASE) return [];
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    }catch(e){ return []; }
  }
  function saveDay(key, items){
    if (USE_SUPABASE) return;
    localStorage.setItem(key, JSON.stringify(items));
  }

  // =====================
  // 2) Supabase Today Layer (row 단위)
  // =====================
  function nowIso(){ return new Date().toISOString(); }

  function dayRangeIso(dateStr){
    const p = parseYmd(dateStr);
    if(!p) throw new Error("bad dateStr");
    const start = new Date(p.y, p.m-1, p.d, 0,0,0,0);
    const end = new Date(p.y, p.m-1, p.d+1, 0,0,0,0);
    return { startIso: start.toISOString(), endIso: end.toISOString() };
  }

  function rowToItem(row){
    return { id: row.id, text: row.title || "", done: row.status === "done" };
  }

  function itemToRow(item, dateStr){
    const { startIso } = dayRangeIso(dateStr);
    return {
      id: item.id,
      workspace_id,
      title: (item.text || "").trim(),
      status: item.done ? "done" : "todo",
      due_at: startIso,
      deleted: false,
      updated_at: nowIso(),
      pinned: false,
      priority: 0
    };
  }

  async function sbLoadDay(dateStr){
    const { startIso, endIso } = dayRangeIso(dateStr);

    // due_at 필터 2개(gte, lt) 때문에 query를 배열로 넣음
    const rows = await sbFetch("items", {
      query: [
        ["select", "id,title,status,updated_at,due_at"],
        ["workspace_id", `eq.${workspace_id}`],
        ["deleted", "eq.false"],
        ["due_at", `gte.${startIso}`],
        ["due_at", `lt.${endIso}`],
        ["order", "updated_at.desc"]
      ]
    });

    return (rows || []).map(rowToItem);
  }

  async function sbLoadArchiveAll(){
    const rows = await sbFetch("items", {
      query: {
        select: "id,title,status,due_at,updated_at",
        workspace_id: `eq.${workspace_id}`,
        deleted: "eq.false",
        order: "due_at.desc",
        limit: "2000"
      }
    });

    const archive = {};
    for(const r of (rows || [])){
      if(!r.due_at) continue;
      const d = new Date(r.due_at);
      const dateStr = `${d.getFullYear()}.${pad2(d.getMonth()+1)}.${pad2(d.getDate())}`;
      (archive[dateStr] ||= []).push(rowToItem(r));
    }
    return archive;
  }

  async function sbUpsertRow(row){
    // on_conflict=id 로 upsert
    await sbFetch("items?on_conflict=id", { method:"POST", body:[row] });
  }

  async function sbPatchRow(id, patch){
    await sbFetch(`items?id=eq.${id}`, { method:"PATCH", body: patch });
  }

  async function sbSoftDelete(id){
    await sbPatchRow(id, { deleted: true, updated_at: nowIso() });
  }

  // =====================
  // 3) UI init
  // =====================
  const todayStr = ymd(new Date());
  const yesterdayStr = ymd(new Date(Date.now() - 86400000));
  const KEY_TODAY = `${PREFIX_DAY}${todayStr}`;

  const metaText = document.getElementById("metaText");
  const listEl = document.getElementById("list");
  const inputEl = document.getElementById("todoInput");
  const addBtn = document.getElementById("addBtn");
  const countText = document.getElementById("countText");
  const clearDoneBtn = document.getElementById("clearDoneBtn");
  const resetBtn = document.getElementById("resetBtn");

  const carryYesterdayBtn = document.getElementById("carryYesterdayBtn");
  const historyBtn = document.getElementById("historyBtn");
  const copyTodayBtn = document.getElementById("copyTodayBtn");
  const copyPopover = document.getElementById("copyPopover");
  const toast = document.getElementById("toast");

  // Modal
  const modalOverlay = document.getElementById("modalOverlay");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const datesPanel = document.getElementById("datesPanel");
  const pickedDateText = document.getElementById("pickedDateText");
  const previewBox = document.getElementById("previewBox");
  const copyPickedBtn = document.getElementById("copyPickedBtn");
  const carryPickedBtn = document.getElementById("carryPickedBtn");
  const archiveCount = document.getElementById("archiveCount");
  const searchInput = document.getElementById("searchInput");
  const clearSearchBtn = document.getElementById("clearSearchBtn");

  metaText.textContent = todayStr;

  addBtn.innerHTML = `
    <svg viewBox="0 0 24 24" width="14" height="14" aria-hidden="true">
      <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
    </svg>
  `;

  function syncAddButtonState(){
    const hasText = (inputEl.value || "").trim().length > 0;
    addBtn.disabled = !hasText;
  }
  inputEl.addEventListener("input", syncAddButtonState);
  syncAddButtonState();

  let state = [];
  let archive = {};
  let pickedDate = null;
  let searchQuery = "";

  // ✅ 최초 로딩: 오늘 데이터 서버에서 받음
  state = USE_SUPABASE ? await sbLoadDay(todayStr) : loadDay(KEY_TODAY);
  render();

  // =====================
  // 4) CRUD (서버 모드에서는 서버로 반영)
  // =====================
  async function addItem(text){
    const t = (text || "").trim();
    if(!t) return;

    const it = {
      id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())),
      text: t,
      done: false
    };

    state.unshift(it);
    render();

    if (USE_SUPABASE) {
      await sbUpsertRow(itemToRow(it, todayStr));
    } else {
      saveDay(KEY_TODAY, state);
    }
  }

  async function toggleItem(id){
    state = state.map(it => it.id === id ? ({ ...it, done: !it.done }) : it);
    render();

    const it = state.find(x => x.id === id);
    if(!it) return;

    if (USE_SUPABASE) {
      await sbPatchRow(id, { status: it.done ? "done" : "todo", updated_at: nowIso() });
    } else {
      saveDay(KEY_TODAY, state);
    }
  }

  async function deleteItem(id){
    state = state.filter(it => it.id !== id);
    render();

    if (USE_SUPABASE) {
      await sbSoftDelete(id);
    } else {
      saveDay(KEY_TODAY, state);
    }
  }

  function clearDone(){
    state = state.filter(it => !it.done);
    render();
    if (!USE_SUPABASE) saveDay(KEY_TODAY, state);
  }

  function resetAll(){
    state = [];
    render();
    if (!USE_SUPABASE) saveDay(KEY_TODAY, state);
  }

  function render(){
    listEl.innerHTML = "";
    for(const it of state){
      const li = document.createElement("li");
      li.className = "item" + (it.done ? " done" : "");
      li.innerHTML = `
        <div class="check" role="checkbox" aria-checked="${it.done}" tabindex="0" data-id="${it.id}">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M20 7L10 17l-5-5" stroke="rgba(30,30,30,0.85)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="text" title="${escapeHtml(it.text)}">${escapeHtml(it.text)}</div>
        <button class="del" type="button" aria-label="삭제" data-del="${it.id}">✕</button>
      `;
      listEl.appendChild(li);
    }
    const total = state.length;
    const done = state.filter(x => x.done).length;
    countText.textContent = `${done}/${total} done`;
  }

  // =====================
  // 5) Carry over (서버 모드)
  // =====================
  async function carryOverUnfinishedFromDate(dateStr){
    if(!dateStr || !parseYmd(dateStr)){
      showToast("가져오기 실패: 날짜 형식이 올바르지 않아.");
      return;
    }

    const src = USE_SUPABASE ? await sbLoadDay(dateStr) : (archive[dateStr] || []);
    if(!src || src.length === 0){
      showToast("가져올 기록이 없어.");
      return;
    }

    const unfinished = src.filter(x => !x.done && (x.text || "").trim());
    if(unfinished.length === 0){
      showToast("미완료가 없어.");
      return;
    }

    const existing = new Set(state.map(x => (x.text || "").trim()));
    const toAdd = [];

    for(const it of unfinished){
      const tx = (it.text || "").trim();
      if(!tx) continue;
      if(existing.has(tx)) continue;
      toAdd.push({
        id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random())),
        text: tx,
        done: false
      });
    }

    if(toAdd.length === 0){
      showToast("미완료가 이미 오늘에 있어.");
      return;
    }

    state = [...toAdd, ...state];
    render();

    if (USE_SUPABASE) {
      // 오늘 날짜 row로 upsert
      for(const it of toAdd){
        await sbUpsertRow(itemToRow(it, todayStr));
      }
    } else {
      saveDay(KEY_TODAY, state);
    }

    showToast(`${dateStr} 미완료 ${toAdd.length}개 가져왔어.`);
  }

  async function carryOverYesterday(){
    await carryOverUnfinishedFromDate(yesterdayStr);
  }

  // =====================
  // 6) Copy / Modal
  // =====================
  async function copyToday(mode = "all"){
    let filtered = state;
    if(mode === "todo") filtered = state.filter(x => !x.done);
    if(mode === "done") filtered = state.filter(x => x.done);

    const text = formatForCopy(todayStr, filtered);
    const ok = await copyToClipboard(text);

    const label =
      mode === "todo" ? "미완료만" :
      mode === "done" ? "완료만" : "전체";

    showToast(ok ? `${label} 복사했어.` : "복사 실패 (브라우저 권한 확인)");
  }

  async function copyPicked(){
    if(!pickedDate) return;
    const items = archive[pickedDate] || [];
    const text = formatForCopy(pickedDate, items);
    const ok = await copyToClipboard(text);
    showToast(ok ? "선택 날짜 기록을 복사했어." : "복사 실패 (브라우저 권한 확인)");
  }

  async function openModal(){
    datesPanel.innerHTML = `<div style="color: rgba(30,30,30,0.55); font-size:12px; padding:8px;">불러오는 중…</div>`;
    previewBox.innerHTML = "";
    modalOverlay.classList.add("open");
    modalOverlay.setAttribute("aria-hidden", "false");

    archive = USE_SUPABASE ? await sbLoadArchiveAll() : loadArchive();
    searchQuery = (searchInput.value || "").trim();
    buildDates();

    pickedDate = null;
    pickedDateText.textContent = "날짜를 선택해줘";
    copyPickedBtn.disabled = true;
    carryPickedBtn.disabled = true;
    previewBox.innerHTML = `
      <div style="color: rgba(30,30,30,0.55); font-size:12px;">
        왼쪽에서 날짜를 선택하면, 그날의 Today 기록을 보여줘.
      </div>
    `;
  }

  function closeModal(){
    modalOverlay.classList.remove("open");
    modalOverlay.setAttribute("aria-hidden", "true");
  }

  function dateMatchesQuery(dateStr, items, q){
    if(!q) return true;
    const lowerQ = q.toLowerCase();
    if(dateStr.toLowerCase().includes(lowerQ)) return true;
    for(const it of (items || [])){
      const tx = String(it.text || "").toLowerCase();
      if(tx.includes(lowerQ)) return true;
    }
    return false;
  }

  function buildDates(){
    const q = (searchQuery || "").trim();
    const dates = Object.keys(archive).filter(d => parseYmd(d));
    dates.sort((a,b) => ymdToDate(b).getTime() - ymdToDate(a).getTime());

    const filtered = dates.filter(d => dateMatchesQuery(d, archive[d], q));

    datesPanel.innerHTML = "";
    if(filtered.length === 0){
      datesPanel.innerHTML = `
        <div style="color: rgba(30,30,30,0.55); font-size:12px; padding:8px;">
          검색 결과가 없어.
        </div>
      `;
    }else{
      for(const d of filtered){
        const items = archive[d] || [];
        const done = items.filter(x => x.done).length;
        const total = items.length;

        const btn = document.createElement("button");
        btn.className = "dateBtn";
        btn.type = "button";
        btn.dataset.date = d;
        const label = formatDateLabel(d);
        btn.innerHTML = `${escapeHtml(label)}<small>${done}/${total}</small>`;
        datesPanel.appendChild(btn);
      }
    }

    archiveCount.textContent = `${filtered.length} / ${dates.length} days`;

    if(pickedDate && !filtered.includes(pickedDate)){
      pickedDate = null;
      pickedDateText.textContent = "날짜를 선택해줘";
      copyPickedBtn.disabled = true;
      carryPickedBtn.disabled = true;
      previewBox.innerHTML = `
        <div style="color: rgba(30,30,30,0.55); font-size:12px;">
          검색 결과에서 날짜를 선택해줘.
        </div>
      `;
    }else if(pickedDate){
      setActiveDateButton(pickedDate);
      renderPreview(pickedDate);
    }
  }

  function setActiveDateButton(dateStr){
    const btns = datesPanel.querySelectorAll(".dateBtn");
    btns.forEach(b => b.classList.toggle("active", b.dataset.date === dateStr));
  }

  function renderPreview(dateStr){
    const items = archive[dateStr] || [];
    const q = (searchQuery || "").trim();

    pickedDate = dateStr;
    setActiveDateButton(dateStr);

    pickedDateText.textContent = `선택: ${formatDateLabel(dateStr)}`;
    copyPickedBtn.disabled = false;
    carryPickedBtn.disabled = false;

    let view = items;
    if(q){
      const lowerQ = q.toLowerCase();
      view = items.filter(it =>
        String(it.text || "").toLowerCase().includes(lowerQ) ||
        dateStr.toLowerCase().includes(lowerQ)
      );
    }

    if(!view || view.length === 0){
      previewBox.innerHTML = `<div style="color: rgba(30,30,30,0.55); font-size:12px;">표시할 항목이 없어.</div>`;
      return;
    }

    const rows = view.map(it => {
      const badgeCls = it.done ? "badge done" : "badge";
      const badgeText = it.done ? "done" : "todo";
      const textHtml = highlight(it.text || "", q);
      return `
        <div class="pItem">
          <span class="${badgeCls}">${badgeText}</span>
          <span style="${it.done ? "text-decoration:line-through; color:rgba(30,30,30,0.55);" : ""}">
            ${textHtml}
          </span>
        </div>
      `;
    }).join("");

    previewBox.innerHTML = rows;
  }

  // Popover helpers
  function placePopover(){
    const btnRect = copyTodayBtn.getBoundingClientRect();
    const popRect = copyPopover.getBoundingClientRect();
    const gap = 8;
    const pad = 8;

    let top = btnRect.top - popRect.height - gap;
    let left = btnRect.right - popRect.width;

    if(top < pad) top = btnRect.bottom + gap;
    left = Math.max(pad, Math.min(left, window.innerWidth - popRect.width - pad));

    copyPopover.style.left = `${left}px`;
    copyPopover.style.top = `${top}px`;
  }

  function openCopyPopover(){
    if(modalOverlay.classList.contains("open")) return;
    copyPopover.classList.add("open");
    copyPopover.setAttribute("aria-hidden", "false");
    requestAnimationFrame(placePopover);
  }

  function closeCopyPopover(){
    copyPopover.classList.remove("open");
    copyPopover.setAttribute("aria-hidden", "true");
  }

  // =====================
  // 7) Events
  // =====================
  addBtn.addEventListener("click", async () => {
    await addItem(inputEl.value);
    inputEl.value = "";
    inputEl.focus();
    syncAddButtonState();
  });

  inputEl.addEventListener("keydown", async (e) => {
    if(e.key === "Enter"){
      e.preventDefault();
      if(!addBtn.disabled) addBtn.click();
    }
  });

  listEl.addEventListener("click", async (e) => {
    const check = e.target.closest(".check");
    const del = e.target.closest("[data-del]");
    if(check) await toggleItem(check.dataset.id);
    else if(del) await deleteItem(del.dataset.del);
  });

  listEl.addEventListener("keydown", async (e) => {
    const check = e.target.closest(".check");
    if(!check) return;
    if(e.key === "Enter" || e.key === " "){
      e.preventDefault();
      await toggleItem(check.dataset.id);
    }
  });

  if (clearDoneBtn) clearDoneBtn.addEventListener("click", clearDone);
  if (resetBtn) resetBtn.addEventListener("click", resetAll);

  carryYesterdayBtn.addEventListener("click", () => carryOverYesterday());
  historyBtn.addEventListener("click", () => openModal());

  copyTodayBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    if(copyPopover.classList.contains("open")) closeCopyPopover();
    else openCopyPopover();
  });

  copyPopover.addEventListener("click", (e) => {
    e.stopPropagation();
    const btn = e.target.closest("[data-copy]");
    if(!btn) return;
    const mode = btn.dataset.copy || "all";
    closeCopyPopover();
    copyToday(mode);
  });

  document.addEventListener("click", () => closeCopyPopover());
  document.addEventListener("keydown", (e) => {
    if(e.key === "Escape") closeCopyPopover();
  });

  window.addEventListener("resize", () => {
    if(copyPopover.classList.contains("open")) placePopover();
  }, { passive: true });

  window.addEventListener("scroll", () => {
    if(copyPopover.classList.contains("open")) placePopover();
  }, { passive: true });

  closeModalBtn.addEventListener("click", closeModal);
  modalOverlay.addEventListener("click", (e) => {
    if(e.target === modalOverlay) closeModal();
  });

  datesPanel.addEventListener("click", (e) => {
    const btn = e.target.closest(".dateBtn");
    if(!btn) return;
    renderPreview(btn.dataset.date);
  });

  copyPickedBtn.addEventListener("click", copyPicked);

  carryPickedBtn.addEventListener("click", () => {
    if(!pickedDate) return;
    carryOverUnfinishedFromDate(pickedDate);
  });

  searchInput.addEventListener("input", () => {
    searchQuery = (searchInput.value || "").trim();
    buildDates();
  });

  clearSearchBtn.addEventListener("click", () => {
    searchInput.value = "";
    searchQuery = "";
    buildDates();
    showToast("검색을 초기화했어.");
  });
</script>

</body>
</html>
